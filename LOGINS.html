<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaron Agronomy System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2E7D32;
            --primary-light: #4CAF50;
            --primary-dark: #1B5E20;
            --secondary: #FF9800;
            --light: #F5F5F5;
            --dark: #333333;
            --gray: #757575;
            --light-gray: #EEEEEE;
            --danger: #D32F2F;
            --success: #388E3C;
            --warning: #F57C00;
            --info: #1976D2;
            --invoice-bg: #FFFDE7;
            --invoice-header: #4CAF50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header and Navigation */
        .main-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 3px solid var(--secondary);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: white;
        }

        .logo-img {
            height: 50px;
            width: 50px;
            background-color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border: 2px solid var(--secondary);
        }

        .logo-img img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        .logo-text {
            text-align: left;
        }

        .system-title {
            font-size: clamp(1.2rem, 3vw, 1.8rem);
            font-weight: bold;
            color: white;
            text-align: left;
            margin: 0 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .nav-links {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
            white-space: nowrap;
            position: relative;
        }

        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .nav-links .active {
            background-color: rgba(255,255,255,0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: white;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(45deg, #FF5722, #FF9800);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .has-notification {
            position: relative;
        }

        .has-notification::after {
            content: '';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: #FF5722;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main-content {
            padding: 25px 0;
            min-height: calc(100vh - 80px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .card-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            min-width: 600px;
        }

        .table th {
            background-color: rgba(46, 125, 50, 0.05);
            color: var(--primary);
            font-weight: 600;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .table tr:hover {
            background-color: rgba(46, 125, 50, 0.02);
        }

        /* Status Badges */
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background-color: rgba(56, 142, 60, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--danger);
        }

        .badge-info {
            background-color: rgba(25, 118, 210, 0.1);
            color: var(--info);
        }

        /* Login Page */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            padding: 30px;
            margin: 20px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: var(--light-gray);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .login-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-body {
            padding: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            line-height: 1;
        }

        /* Invoice */
        .invoice {
            background: var(--invoice-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid var(--primary);
        }

        .invoice-header {
            background: var(--invoice-header);
            padding: 20px;
            border-radius: 8px 8px 0 0;
            color: white;
            margin: -25px -25px 20px -25px;
        }

        .invoice-company {
            text-align: center;
            margin-bottom: 30px;
        }

        .invoice-company h2 {
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .invoice-from, .invoice-to {
            flex: 1;
            min-width: 200px;
        }

        .invoice-items {
            margin: 25px 0;
        }

        .invoice-total {
            text-align: right;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid var(--light-gray);
        }

        .invoice-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
            font-style: italic;
            color: var(--gray);
        }

        /* Expense Container */
        .expense-container {
            background: #FFF3E0;
            border: 1px solid #FFB74D;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #FFE0B2;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* PDF Upload/Download Styles */
        .pdf-upload-container {
            border: 2px dashed var(--primary-light);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            background-color: rgba(76, 175, 80, 0.05);
        }

        .pdf-preview {
            margin-top: 15px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-icon {
            color: var(--danger);
            font-size: 1.5rem;
        }

        .upload-btn {
            background-color: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            margin-top: 10px;
        }

        .upload-btn input[type="file"] {
            display: none;
        }

        .pdf-list {
            margin-top: 20px;
        }

        .pdf-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light-gray);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .pdf-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Month Selector */
        .month-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .month-btn {
            padding: 8px 15px;
            background: var(--light-gray);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .month-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Mobile Navigation */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 10px;
        }

        /* Agronomist selection cards */
        .agronomist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .agronomist-card {
            border: 2px solid var(--light-gray);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            background: white;
        }

        .agronomist-card:hover {
            border-color: var(--primary-light);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .agronomist-card.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(46, 125, 50, 0.05), rgba(76, 175, 80, 0.05));
        }

        .agronomist-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--light-gray);
            margin: 0 auto 15px;
            overflow: hidden;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .agronomist-rating {
            color: #FF9800;
            font-size: 1.2rem;
            margin: 10px 0;
        }

        .agronomist-specialties {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin: 10px 0;
        }

        .specialty-tag {
            background: #e8f5e8;
            color: var(--primary);
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo, .system-title, .nav-links {
                width: 100%;
                justify-content: center;
                text-align: center;
            }
            
            .system-title {
                order: -1;
                margin: 10px 0;
            }
        }

        /* Mobile Navigation Styles */
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
                position: absolute;
                right: 20px;
                top: 15px;
            }

            .nav-links {
                position: fixed;
                top: 0;
                right: -100%;
                width: 70%;
                max-width: 300px;
                height: 100vh;
                background: linear-gradient(135deg, var(--primary-dark), var(--primary));
                flex-direction: column;
                align-items: flex-start;
                padding: 80px 20px 20px;
                transition: right 0.3s ease;
                box-shadow: -5px 0 15px rgba(0,0,0,0.2);
                z-index: 1000;
                overflow-y: auto;
            }

            .nav-links.active {
                right: 0;
            }

            .nav-links a {
                width: 100%;
                padding: 15px;
                margin: 5px 0;
                border-radius: 8px;
            }

            .user-info {
                width: 100%;
                flex-direction: column;
                text-align: center;
                padding: 15px;
                margin-top: 20px;
            }

            /* Overlay when menu is open */
            .nav-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }

            .nav-overlay.active {
                display: block;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .invoice-details {
                flex-direction: column;
            }
            
            .modal-content {
                margin: 10px;
            }
            
            .table {
                min-width: 300px;
            }
            
            .table th, .table td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
            
            .agronomist-grid {
                grid-template-columns: 1fr;
            }
            
            .agronomist-card {
                padding: 15px;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .card-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
                margin-bottom: 5px;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
                padding: 10px;
            }
            
            .invoice-header h2 {
                font-size: 1.2rem;
            }
            
            .invoice-company h2 {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 360px) {
            .container {
                padding: 0 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .login-card {
                padding: 20px;
            }
        }

        /* Print Styles */
        @media print {
            .main-header, .modal-header, .btn, .close-modal {
                display: none !important;
            }
            
            .modal {
                position: static;
                background: none;
                padding: 0;
                display: block !important;
            }
            
            .modal-content {
                box-shadow: none;
                max-height: none;
                border: none;
            }
            
            .invoice {
                border: none;
                box-shadow: none;
                padding: 0;
                background: white;
            }
            
            .invoice-header {
                background: #4CAF50 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        /* Fix for logo link */
        .logo-link {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: white;
            gap: 15px;
        }
        
        /* Sales display for agronomist */
        .sales-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            border-radius: 10px;
        }
        
        .sales-summary h3 {
            margin: 0;
            color: white;
        }
        
        .total-sales {
            font-size: 2rem;
            font-weight: bold;
        }

        /* New Styles */
        
        /* Full width charts */
        .full-width-chart {
            grid-column: 1 / -1;
        }
        
        .chart-container.full-height {
            height: 350px;
        }
        
        /* Invoice logo */
        .invoice-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .invoice-logo img {
            max-height: 80px;
            width: auto;
        }
        
        /* Notification styles */
        .invoice-notification {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Farmer selection */
        .farmer-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .farmer-card {
            flex: 1;
            min-width: 200px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .farmer-card:hover {
            border-color: var(--primary);
            background: rgba(46, 125, 50, 0.05);
        }
        
        .farmer-card.selected {
            border-color: var(--primary);
            background: rgba(46, 125, 50, 0.1);
        }
        
        /* PDF viewer */
        .pdf-viewer {
            width: 100%;
            height: 500px;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .full-width-chart .chart-container {
                height: 250px;
            }
            
            .farmer-card {
                min-width: 100%;
            }
        }
        
        /* Crop fields styles */
        .crop-fields {
            margin-top: 20px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 15px;
        }
        
        .crop-field-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        
        .add-crop-btn {
            margin-top: 10px;
        }
        
        /* Deadline warning */
        .deadline-warning {
            color: var(--danger);
            font-weight: bold;
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <!-- Mobile Navigation Overlay -->
<div class="nav-overlay" id="navOverlay"></div>
    <!-- Header -->
    <header class="main-header">
        <div class="container header-container">
            <a href="index.html" class="logo-link">
                <div class="logo-img">
                    <img src="aaron logo.webp" alt="Aaron Agronomy Services Logo" onerror="this.style.display='none'">
                </div>
                <div class="system-title">MKULIMA DIGITAL</div>
            </a>
            
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
           
            <nav class="nav-links" id="navLinks">
                <a href="#" id="navDashboard" class="active"><i class="fas fa-home"></i> Dashboard</a>
                <a href="#" id="navReports"><i class="fas fa-file-alt"></i> Reports</a>
                <a href="#" id="navSales"><i class="fas fa-chart-line"></i> Sales</a>
                <a href="#" id="navFarms"><i class="fas fa-tractor"></i> Farms</a>
                <a href="#" id="navInvoices">
                    <i class="fas fa-receipt"></i> Invoices
                    <span class="notification-badge" id="invoiceNotification" style="display: none;">0</span>
                </a>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName">User</div>
                        <small id="userRole">Role</small>
                    </div>
                    <button class="btn btn-sm btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content container" id="mainContent">
        <!-- Dashboard will be loaded here -->
    </main>

    <!-- Login Modal -->
    <div class="modal" id="loginModal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="login-header">
                    <h2>MKULIMA DIGITAL FARMER</h2>
                    <p>Aaron Agronomy System</p>
                </div>
                
                <div class="login-tabs">
                    <div class="login-tab active" data-type="farmer">Farmer</div>
                    <div class="login-tab" data-type="agronomist">Agronomist</div>
                </div>
                
                <!-- Farmer Login -->
                <form id="farmerLoginForm">
                    <div class="form-group">
                        <label for="farmerEmail">Email Address</label>
                        <input type="email" id="farmerEmail" class="form-control" placeholder="farmer@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="farmerPassword">Password</label>
                        <input type="password" id="farmerPassword" class="form-control" placeholder="Enter password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Login as Farmer
                    </button>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" id="showFarmerSignup" style="color: var(--primary);">Don't have account? Sign up</a>
                    </div>
                </form>
                
                <!-- Farmer Signup -->
                <form id="farmerSignupForm" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="signupFirstName">First Name</label>
                            <input type="text" id="signupFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="signupLastName">Last Name</label>
                            <input type="text" id="signupLastName" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPhone">Phone Number</label>
                        <input type="tel" id="signupPhone" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupLocation">Location</label>
                        <input type="text" id="signupLocation" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="signupPassword">Password</label>
                            <input type="password" id="signupPassword" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="signupConfirmPassword">Confirm Password</label>
                            <input type="password" id="signupConfirmPassword" class="form-control" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-user-plus"></i> Create Farmer Account
                    </button>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" id="showFarmerLogin" style="color: var(--primary);">Already have account? Login</a>
                    </div>
                </form>
                
                <!-- Agronomist Login -->
                <form id="agronomistLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="agroUsername">Username</label>
                        <input type="text" id="agroUsername" class="form-control" value="aaron_agronomy" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="agroPassword">Password</label>
                        <input type="password" id="agroPassword" class="form-control" value="9898" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-user-md"></i> Login as Agronomist
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Daily Sale Modal (Agronomist Only) - UPDATED -->
    <div class="modal" id="addSaleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Consultation Record</h3>
                <button class="close-modal" data-modal="addSaleModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addSaleForm">
                    <div class="form-group">
                        <label for="saleDate">Date</label>
                        <input type="date" id="saleDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleFarmer">Select Farmer</label>
                        <select id="saleFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                            <option value="external">Other Farmer (Not in Portal)</option>
                        </select>
                    </div>
                    
                    <!-- External farmer details (hidden by default) -->
                    <div id="externalFarmerDetails" style="display: none;">
                        <div class="form-group">
                            <label for="externalFarmerName">Farmer Name</label>
                            <input type="text" id="externalFarmerName" class="form-control" placeholder="Enter farmer name">
                        </div>
                        <div class="form-group">
                            <label for="externalFarmerPhone">Phone Number</label>
                            <input type="tel" id="externalFarmerPhone" class="form-control" placeholder="Enter phone number">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleDescription">Consultation Description</label>
                        <textarea id="saleDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="saleAmount">Total Fee (KSH)</label>
                            <input type="number" id="saleAmount" class="form-control" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="saleDeadline">Deadline</label>
                            <input type="date" id="saleDeadline" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleStatus">Status</label>
                        <select id="saleStatus" class="form-control" required>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="paid">Paid</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Consultation
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal (Farmer) -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Expense</h3>
                <button class="close-modal" data-modal="addExpenseModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addExpenseForm">
                    <div class="form-group">
                        <label for="expenseDate">Date</label>
                        <input type="date" id="expenseDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseCategory">Category</label>
                        <select id="expenseCategory" class="form-control" required>
                            <option value="">Select Category</option>
                            <option value="seeds">Seeds</option>
                            <option value="fertilizer">Fertilizer</option>
                            <option value="pesticides">Pesticides</option>
                            <option value="labor">Labor</option>
                            <option value="equipment">Equipment</option>
                            <option value="transport">Transport</option>
                            <option value="irrigation">Irrigation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseDescription">Description</label>
                        <input type="text" id="expenseDescription" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseAmount">Amount (KSH)</label>
                        <input type="number" id="expenseAmount" class="form-control" step="0.01" required>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Expense
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Task Modal (Agronomist) - UPDATED -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Consultation</h3>
                <button class="close-modal" data-modal="addTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="form-group">
                        <label for="taskFarmer">Select Farmer</label>
                        <select id="taskFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                            <option value="external">Other Farmer (Not in Portal)</option>
                        </select>
                    </div>
                    
                    <!-- External farmer details (hidden by default) -->
                    <div id="externalTaskFarmerDetails" style="display: none;">
                        <div class="form-group">
                            <label for="externalTaskFarmerName">Farmer Name</label>
                            <input type="text" id="externalTaskFarmerName" class="form-control" placeholder="Enter farmer name">
                        </div>
                        <div class="form-group">
                            <label for="externalTaskFarmerPhone">Phone Number</label>
                            <input type="tel" id="externalTaskFarmerPhone" class="form-control" placeholder="Enter phone number">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDate">Date</label>
                        <input type="date" id="taskDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Consultation Description</label>
                        <textarea id="taskDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskAmount">Total Payment (KSH)</label>
                            <input type="number" id="taskAmount" class="form-control" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="taskDeadline">Deadline</label>
                            <input type="date" id="taskDeadline" class="form-control">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskStatus">Status</label>
                        <select id="taskStatus" class="form-control" required>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="paid">Paid</option>
                            <option value="overdue">Overdue</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Consultation
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Farm Modal (Farmer) - UPDATED -->
    <div class="modal" id="addFarmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Farm</h3>
                <button class="close-modal" data-modal="addFarmModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addFarmForm">
                    <div class="form-group">
                        <label for="farmName">Farm Name</label>
                        <input type="text" id="farmName" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="farmSize">Size (acres)</label>
                            <input type="number" id="farmSize" class="form-control" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="farmLocation">Location</label>
                            <input type="text" id="farmLocation" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="farmSoil">Soil Type</label>
                        <select id="farmSoil" class="form-control" required>
                            <option value="">Select Soil Type</option>
                            <option value="loamy">Loamy</option>
                            <option value="clay">Clay</option>
                            <option value="sandy">Sandy</option>
                            <option value="silt">Silt</option>
                            <option value="clay_loam">Clay Loam</option>
                            <option value="sandy_loam">Sandy Loam</option>
                        </select>
                    </div>
                    
                    <div class="crop-fields">
                        <h4>Main Crops</h4>
                        <div id="cropFieldsContainer">
                            <div class="crop-field-item">
                                <input type="text" class="form-control crop-name" placeholder="Crop name" required>
                                <input type="number" class="form-control crop-acreage" placeholder="Acres" step="0.1" required>
                                <select class="form-control crop-status">
                                    <option value="planted">Planted</option>
                                    <option value="growing">Growing</option>
                                    <option value="harvested">Harvested</option>
                                    <option value="planned">Planned</option>
                                </select>
                                <button type="button" class="btn btn-danger btn-sm remove-crop">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm add-crop-btn" id="addCropField">
                            <i class="fas fa-plus"></i> Add Crop
                        </button>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="margin-top: 20px;">
                        <i class="fas fa-save"></i> Save Farm
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Report Modal (Agronomist) -->
    <div class="modal" id="createReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Farmer Report</h3>
                <button class="close-modal" data-modal="createReportModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createReportForm">
                    <div class="form-group">
                        <label for="reportFarmer">Select Farmer</label>
                        <select id="reportFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportTitle">Report Title</label>
                        <input type="text" id="reportTitle" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportType">Report Type</label>
                        <select id="reportType" class="form-control" required>
                            <option value="soil_analysis">Soil Analysis</option>
                            <option value="crop_health">Crop Health</option>
                            <option value="pest_control">Pest Control</option>
                            <option value="fertilizer">Fertilizer Recommendation</option>
                            <option value="general">General Advisory</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportDate">Report Date</label>
                        <input type="date" id="reportDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportFindings">Findings</label>
                        <textarea id="reportFindings" class="form-control" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportRecommendations">Recommendations</label>
                        <textarea id="reportRecommendations" class="form-control" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportStatus">Status</label>
                        <select id="reportStatus" class="form-control" required>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="requires_action">Requires Action</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-file-export"></i> Generate Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Upload PDF Modal (Agronomist) -->
    <div class="modal" id="uploadPdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload PDF for Farmer</h3>
                <button class="close-modal" data-modal="uploadPdfModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="uploadPdfForm">
                    <div class="form-group">
                        <label for="pdfFarmer">Select Farmer</label>
                        <select id="pdfFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pdfTitle">PDF Title</label>
                        <input type="text" id="pdfTitle" class="form-control" placeholder="e.g., Soil Analysis Report, Farming Guide" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="pdfDescription">Description</label>
                        <textarea id="pdfDescription" class="form-control" rows="3" placeholder="Brief description of the PDF content"></textarea>
                    </div>
                    
                    <div class="pdf-upload-container">
                        <i class="fas fa-file-pdf pdf-icon"></i>
                        <p>Upload PDF file (Max: 10MB)</p>
                        <label class="upload-btn">
                            <input type="file" id="pdfFile" accept=".pdf" required>
                            <i class="fas fa-upload"></i> Choose PDF File
                        </label>
                        <div id="pdfFileName" style="margin-top: 10px; color: var(--gray);"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pdfCategory">Category</label>
                        <select id="pdfCategory" class="form-control">
                            <option value="reports">Reports</option>
                            <option value="guides">Farming Guides</option>
                            <option value="certificates">Certificates</option>
                            <option value="market_info">Market Information</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-cloud-upload-alt"></i> Upload PDF
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Invoice Modal -->
    <div class="modal" id="createInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Invoice</h3>
                <button class="close-modal" data-modal="createInvoiceModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createInvoiceForm">
                    <div class="form-group">
                        <label for="invoiceFarmer">Select Farmer</label>
                        <select id="invoiceFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                            <option value="external">Other Farmer (Not in Portal)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceDate">Invoice Date</label>
                        <input type="date" id="invoiceDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceDueDate">Due Date</label>
                        <input type="date" id="invoiceDueDate" class="form-control" required>
                    </div>
                    
                    <div class="invoice-items" id="invoiceItems">
                        <h4>Invoice Items</h4>
                        <div class="invoice-item">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" class="form-control invoice-desc" required>
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-control invoice-qty" required>
                                </div>
                                <div class="form-group">
                                    <label>Unit Price (KSH)</label>
                                    <input type="number" class="form-control invoice-price" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" id="addInvoiceItem">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceNotes">Notes</label>
                        <textarea id="invoiceNotes" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-file-invoice-dollar"></i> Create Invoice
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- View Report Modal -->
    <div class="modal" id="viewReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Farm Report</h3>
                <button class="close-modal" data-modal="viewReportModal">&times;</button>
            </div>
            <div class="modal-body" id="reportContent">
                <!-- Report content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- View PDF Modal -->
    <div class="modal" id="viewPdfModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>PDF Document</h3>
                <button class="close-modal" data-modal="viewPdfModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="pdfViewerContent">
                    <!-- PDF info will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div class="modal" id="invoicePreviewModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Invoice Preview</h3>
                <button class="close-modal" data-modal="invoicePreviewModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="invoicePreviewContent">
                    <!-- Invoice will be loaded here -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" id="downloadInvoiceBtn">
                        <i class="fas fa-download"></i> Download Invoice
                    </button>
                    <button class="btn btn-success" id="printInvoiceBtn">
                        <i class="fas fa-print"></i> Print Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    // Agronomy System
    class AgronomySystem {
        constructor() {
            this.backendUrl = 'https://agronomy-backend-ehk1.onrender.com';
            this.currentUser = null;
            this.userType = null;
            this.currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            this.selectedAgronomist = null;
            this.initialize();
        }

        initialize() {
            this.setupEventListeners();
            this.checkLoginStatus();
            this.initializeData();
        }

        initializeData() {
            if (!localStorage.getItem('farmers')) {
                const defaultFarmers = [
                    {
                        id: 'FARM-001',
                        firstName: 'John',
                        lastName: 'Doe',
                        email: 'john@example.com',
                        phone: '0712345678',
                        location: 'Nairobi',
                        password: 'password123',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        agronomistId: null,
                        expenses: [],
                        farms: [],
                        reports: [],
                        invoices: [],
                        pdfs: []
                    },
                    {
                        id: 'FARM-002',
                        firstName: 'Jane',
                        lastName: 'Smith',
                        email: 'jane@example.com',
                        phone: '0723456789',
                        location: 'Kiambu',
                        password: 'password123',
                        createdAt: new Date().toISOString(),
                        status: 'active',
                        agronomistId: null,
                        expenses: [],
                        farms: [],
                        reports: [],
                        invoices: [],
                        pdfs: []
                    }
                ];
                localStorage.setItem('farmers', JSON.stringify(defaultFarmers));
            }
            
            if (!localStorage.getItem('agronomists')) {
                const defaultAgronomists = [
                    {
                        id: 'AGRO-001',
                        name: 'Aaron Muthini',
                        email: 'aaronmuthini0@gmail.com',
                        phone: '0700000000',
                        location: 'Makueni',
                        specialties: ['Soil Analysis', 'Crop Health', 'Pest Control'],
                        experience: '10 years',
                        rating: 4.8,
                        farmersCount: 25,
                        farmers: [],
                        profileImage: 'https://randomuser.me/api/portraits/men/32.jpg'
                    },
                    {
                        id: 'AGRO-002',
                        name: 'Dr. Jane Kamau',
                        email: 'jane.kamau@agroservices.co.ke',
                        phone: '0712345678',
                        location: 'Kiambu',
                        specialties: ['Organic Farming', 'Irrigation Systems', 'Market Access'],
                        experience: '8 years',
                        rating: 4.9,
                        farmersCount: 18,
                        farmers: [],
                        profileImage: 'https://randomuser.me/api/portraits/women/44.jpg'
                    },
                    {
                        id: 'AGRO-003',
                        name: 'Samuel Kiprop',
                        email: 'samuelk@agronomyhub.com',
                        phone: '0723456789',
                        location: 'Nakuru',
                        specialties: ['Crop Rotation', 'Soil Conservation', 'Climate Smart Agriculture'],
                        experience: '12 years',
                        rating: 4.7,
                        farmersCount: 32,
                        farmers: [],
                        profileImage: 'https://randomuser.me/api/portraits/men/67.jpg'
                    },
                    {
                        id: 'AGRO-004',
                        name: 'Grace Wanjiku',
                        email: 'gracew@farmadvisory.org',
                        phone: '0734567890',
                        location: 'Muranga',
                        specialties: ['Disease Management', 'Fertilizer Optimization', 'Youth in Agriculture'],
                        experience: '6 years',
                        rating: 4.6,
                        farmersCount: 15,
                        farmers: [],
                        profileImage: 'https://randomuser.me/api/portraits/women/68.jpg'
                    }
                ];
                localStorage.setItem('agronomists', JSON.stringify(defaultAgronomists));
            }
            
            const defaults = {
                tasks: [],
                systemReports: [],
                systemPdfs: [],
                externalInvoices: [],
                helpRequests: []
            };
            
            Object.keys(defaults).forEach(key => {
                if (!localStorage.getItem(key)) {
                    localStorage.setItem(key, JSON.stringify(defaults[key]));
                }
            });
        }

        setupEventListeners() {
            const menuToggle = document.getElementById('menuToggle');
            const navLinks = document.getElementById('navLinks');
            const navOverlay = document.getElementById('navOverlay');

            if (menuToggle) {
                menuToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    navLinks.classList.toggle('active');
                    navOverlay.classList.toggle('active');
                });
            }

            if (navOverlay) {
                navOverlay.addEventListener('click', () => {
                    navLinks.classList.remove('active');
                    navOverlay.classList.remove('active');
                });
            }

            document.querySelectorAll('.nav-links a').forEach(link => {
                link.addEventListener('click', () => {
                    navLinks.classList.remove('active');
                    navOverlay.classList.remove('active');
                });
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    navLinks.classList.remove('active');
                    navOverlay.classList.remove('active');
                }
            });

            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    this.handleLoginTab(e);
                });
            });

            document.getElementById('farmerLoginForm').addEventListener('submit', (e) => this.handleFarmerLogin(e));
            document.getElementById('agronomistLoginForm').addEventListener('submit', (e) => this.handleAgronomistLogin(e));
            document.getElementById('farmerSignupForm').addEventListener('submit', (e) => this.handleFarmerSignup(e));

            document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
            document.getElementById('navDashboard').addEventListener('click', (e) => this.loadDashboard(e));
            document.getElementById('navReports').addEventListener('click', (e) => this.loadReports(e));
            document.getElementById('navSales').addEventListener('click', (e) => this.loadSales(e));
            document.getElementById('navFarms').addEventListener('click', (e) => this.loadFarms(e));
            document.getElementById('navInvoices').addEventListener('click', (e) => this.loadInvoices(e));

            document.getElementById('showFarmerSignup').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('farmerLoginForm').style.display = 'none';
                document.getElementById('farmerSignupForm').style.display = 'block';
            });

            document.getElementById('showFarmerLogin').addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('farmerSignupForm').style.display = 'none';
                document.getElementById('farmerLoginForm').style.display = 'block';
            });

            const saleFarmer = document.getElementById('saleFarmer');
            if (saleFarmer) {
                saleFarmer.addEventListener('change', (e) => {
                    const externalDetails = document.getElementById('externalFarmerDetails');
                    if (e.target.value === 'external') {
                        externalDetails.style.display = 'block';
                    } else {
                        externalDetails.style.display = 'none';
                    }
                });
            }

            const taskFarmer = document.getElementById('taskFarmer');
            if (taskFarmer) {
                taskFarmer.addEventListener('change', (e) => {
                    const externalDetails = document.getElementById('externalTaskFarmerDetails');
                    if (e.target.value === 'external') {
                        externalDetails.style.display = 'block';
                    } else {
                        externalDetails.style.display = 'none';
                    }
                });
            }

            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const modalId = e.target.getAttribute('data-modal');
                    this.hideModal(modalId);
                });
            });

            const addInvoiceItem = document.getElementById('addInvoiceItem');
            if (addInvoiceItem) addInvoiceItem.addEventListener('click', () => this.addInvoiceItem());

            const pdfFile = document.getElementById('pdfFile');
            if (pdfFile) {
                pdfFile.addEventListener('change', function(e) {
                    const fileName = document.getElementById('pdfFileName');
                    if (this.files.length > 0) {
                        fileName.textContent = 'Selected: ' + this.files[0].name;
                        fileName.style.color = 'var(--success)';
                    } else {
                        fileName.textContent = 'No file selected';
                        fileName.style.color = 'var(--gray)';
                    }
                });
            }

            const addCropField = document.getElementById('addCropField');
            if (addCropField) {
                addCropField.addEventListener('click', () => this.addCropField());
            }

            document.addEventListener('click', (e) => {
                const target = e.target;
                
                if ((target.id === 'addSaleBtn' || target.closest('#addSaleBtn')) && this.userType === 'agronomist') {
                    e.preventDefault();
                    this.loadFarmersForSale();
                    this.showModal('addSaleModal');
                }
                
                if (target.id === 'createReportBtn' || target.closest('#createReportBtn')) {
                    e.preventDefault();
                    this.loadFarmersForReport();
                    this.showModal('createReportModal');
                }
                
                if (target.id === 'createInvoiceBtn' || target.closest('#createInvoiceBtn')) {
                    e.preventDefault();
                    this.loadFarmersForInvoice();
                    this.showModal('createInvoiceModal');
                }
                
                if ((target.id === 'addExpenseBtnMain' || target.closest('#addExpenseBtnMain')) && this.userType === 'farmer') {
                    e.preventDefault();
                    this.showModal('addExpenseModal');
                }
                
                if (target.id === 'addTaskBtn' || target.closest('#addTaskBtn')) {
                    e.preventDefault();
                    this.loadFarmersForTask();
                    this.showModal('addTaskModal');
                }
                
                if (target.id === 'uploadPdfBtn' || target.closest('#uploadPdfBtn')) {
                    e.preventDefault();
                    this.loadFarmersForPdfUpload();
                    this.showModal('uploadPdfModal');
                }
                
                if (target.id === 'viewMyPdfsBtn' || target.closest('#viewMyPdfsBtn')) {
                    e.preventDefault();
                    this.loadMyPdfs();
                }
                
                if (target.classList.contains('select-agronomist-btn')) {
                    e.preventDefault();
                    const agronomistId = target.dataset.id;
                    this.selectAgronomist(agronomistId);
                }

                if (target.classList.contains('remove-crop')) {
                    e.preventDefault();
                    target.closest('.crop-field-item').remove();
                }
            });

            const forms = {
                'addSaleForm': 'handleAddSale',
                'createReportForm': 'handleCreateReport',
                'createInvoiceForm': 'handleCreateInvoice',
                'addExpenseForm': 'handleAddExpense',
                'addTaskForm': 'handleAddTask',
                'uploadPdfForm': 'handleUploadPdf',
                'addFarmForm': 'handleAddFarm'
            };

            Object.entries(forms).forEach(([formId, handler]) => {
                const form = document.getElementById(formId);
                if (form) {
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this[handler](e);
                    });
                }
            });

            document.addEventListener('click', (e) => {
                const navLinks = document.getElementById('navLinks');
                const menuToggle = document.getElementById('menuToggle');
                if (!navLinks.contains(e.target) && !menuToggle.contains(e.target) && navLinks.classList.contains('active')) {
                    navLinks.classList.remove('active');
                    navOverlay.classList.remove('active');
                }
            });
        }

        addCropField() {
            const container = document.getElementById('cropFieldsContainer');
            const newField = document.createElement('div');
            newField.className = 'crop-field-item';
            newField.innerHTML = `
                <input type="text" class="form-control crop-name" placeholder="Crop name" required>
                <input type="number" class="form-control crop-acreage" placeholder="Acres" step="0.1" required>
                <select class="form-control crop-status">
                    <option value="planted">Planted</option>
                    <option value="growing">Growing</option>
                    <option value="harvested">Harvested</option>
                    <option value="planned">Planned</option>
                </select>
                <button type="button" class="btn btn-danger btn-sm remove-crop">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(newField);
        }

        getFarmerData(farmerId, dataType) {
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const farmer = farmers.find(f => f.id === farmerId);
            
            if (!farmer) {
                return [];
            }
            
            if (farmer[dataType]) {
                return farmer[dataType];
            }
            
            farmer[dataType] = [];
            this.saveAllFarmers(farmers);
            return [];
        }

        saveFarmerData(farmerId, dataType, data) {
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const farmerIndex = farmers.findIndex(f => f.id === farmerId);
            
            if (farmerIndex !== -1) {
                if (!farmers[farmerIndex][dataType]) {
                    farmers[farmerIndex][dataType] = [];
                }
                farmers[farmerIndex][dataType] = data;
                this.saveAllFarmers(farmers);
                return true;
            }
            return false;
        }

        saveAllFarmers(farmers) {
            localStorage.setItem('farmers', JSON.stringify(farmers));
        }

        handleLoginTab(e) {
            const tab = e.target;
            const type = tab.getAttribute('data-type');
            
            document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            if (type === 'farmer') {
                document.getElementById('farmerLoginForm').style.display = 'block';
                document.getElementById('farmerSignupForm').style.display = 'none';
                document.getElementById('agronomistLoginForm').style.display = 'none';
            } else {
                document.getElementById('farmerLoginForm').style.display = 'none';
                document.getElementById('farmerSignupForm').style.display = 'none';
                document.getElementById('agronomistLoginForm').style.display = 'block';
            }
        }

        async handleFarmerLogin(e) {
            e.preventDefault();
            const email = document.getElementById('farmerEmail').value;
            const password = document.getElementById('farmerPassword').value;

            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const farmer = farmers.find(f => f.email === email && f.password === password);
            
            if (farmer) {
                this.currentUser = farmer;
                this.userType = 'farmer';
                this.saveToLocalStorage();
                this.hideModal('loginModal');
                this.loadDashboard();
                this.updateInvoiceNotifications();
                this.showNotification('Login successful!', 'success');
                return;
            }

            try {
                const response = await fetch(this.backendUrl + '/farmers/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    this.currentUser = data;
                    this.userType = 'farmer';
                    this.saveToLocalStorage();
                    this.hideModal('loginModal');
                    this.loadDashboard();
                    this.updateInvoiceNotifications();
                    this.showNotification('Login successful!', 'success');
                } else {
                    this.showNotification('Invalid email or password', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                this.showNotification('Login failed. Please try again.', 'error');
            }
        }

        async handleAgronomistLogin(e) {
            e.preventDefault();
            const username = document.getElementById('agroUsername').value;
            const password = document.getElementById('agroPassword').value;

            if (username === 'aaron_agronomy' && password === '9898') {
                this.currentUser = {
                    id: 'AGRO-001',
                    name: 'Aaron Agronomist',
                    email: 'aaronmuthini0@gmail.com',
                    role: 'agronomist'
                };
                this.userType = 'agronomist';
                this.saveToLocalStorage();
                this.hideModal('loginModal');
                this.loadDashboard();
                this.updateInvoiceNotifications();
                this.showNotification('Welcome, Agronomist!', 'success');
            } else {
                this.showNotification('Invalid credentials', 'error');
            }
        }

        async handleFarmerSignup(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('signupFirstName').value.trim();
            const lastName = document.getElementById('signupLastName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const phone = document.getElementById('signupPhone').value.trim();
            const location = document.getElementById('signupLocation').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;

            if (!firstName || !lastName || !email || !phone || !location || !password || !confirmPassword) {
                this.showNotification('Please fill in all fields', 'error');
                return;
            }

            if (password !== confirmPassword) {
                this.showNotification('Passwords do not match', 'error');
                return;
            }

            if (password.length < 6) {
                this.showNotification('Password must be at least 6 characters', 'error');
                return;
            }

            if (!this.validateEmail(email)) {
                this.showNotification('Please enter a valid email address', 'error');
                return;
            }

            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            if (farmers.some(f => f.email.toLowerCase() === email.toLowerCase())) {
                this.showNotification('Email already registered. Please login instead.', 'error');
                return;
            }

            const farmerId = 'FARM-' + Date.now().toString().slice(-8);
            const newFarmer = {
                id: farmerId,
                firstName: firstName,
                lastName: lastName,
                email: email,
                phone: phone,
                location: location,
                password: password,
                createdAt: new Date().toISOString(),
                status: 'active',
                agronomistId: null,
                expenses: [],
                farms: [],
                reports: [],
                invoices: [],
                pdfs: []
            };

            farmers.push(newFarmer);
            localStorage.setItem('farmers', JSON.stringify(farmers));

            this.showNotification(`Registration successful! Your Farmer ID: ${farmerId}`, 'success');

            document.getElementById('farmerSignupForm').style.display = 'none';
            document.getElementById('farmerLoginForm').style.display = 'block';
            
            document.getElementById('farmerEmail').value = email;
            document.getElementById('farmerPassword').value = '';
        }

        validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        checkLoginStatus() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                this.currentUser = JSON.parse(userData);
                this.userType = localStorage.getItem('userType');
                this.hideModal('loginModal');
                this.loadDashboard();
                this.updateInvoiceNotifications();
            } else {
                this.showModal('loginModal');
            }
        }

        logout() {
            this.currentUser = null;
            this.userType = null;
            localStorage.removeItem('currentUser');
            localStorage.removeItem('userType');
            document.getElementById('navLinks').classList.remove('active');
            document.getElementById('navOverlay').classList.remove('active');
              
            this.showModal('loginModal');
            this.showNotification('Logged out successfully', 'info');
        }

        async loadDashboard(e = null) {
            if (e) e.preventDefault();
            
            let html = '';
            
            if (this.userType === 'farmer') {
                const expenses = this.getFarmerData(this.currentUser.id, 'expenses');
                const reports = this.getFarmerData(this.currentUser.id, 'reports');
                const pdfs = this.getFarmerData(this.currentUser.id, 'pdfs');
                const invoices = this.getFarmerData(this.currentUser.id, 'invoices');
                
                const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                const unreadInvoices = invoices.filter(inv => !inv.notified);
                
                document.getElementById('userAvatar').textContent = 
                    (this.currentUser.firstName?.[0] || 'F') + (this.currentUser.lastName?.[0] || '');
                document.getElementById('userName').textContent = 
                    `${this.currentUser.firstName} ${this.currentUser.lastName}`;
                document.getElementById('userRole').textContent = 'Farmer';
                
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navDashboard').classList.add('active');
                
                html = `
                    <div class="stats-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-money-bill-wave"></i> Total Expenses</h3>
                            </div>
                            <h2 style="color: var(--danger); margin: 20px 0;">KSH ${totalExpenses.toLocaleString()}</h2>
                            <p>All expenses</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-file-alt"></i> Reports</h3>
                            </div>
                            <h2 style="color: var(--info); margin: 20px 0;">${reports.length}</h2>
                            <p>Farm reports</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-receipt"></i> Invoices</h3>
                            </div>
                            <h2 style="color: var(--warning); margin: 20px 0;">${invoices.length}</h2>
                            <p>Total invoices</p>
                            ${unreadInvoices.length > 0 ? 
                                `<span class="badge badge-danger invoice-notification" style="position: absolute; top: -5px; right: -5px;">${unreadInvoices.length}</span>` : ''
                            }
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-file-pdf"></i> PDFs</h3>
                            </div>
                            <h2 style="color: var(--success); margin: 20px 0;">${pdfs.length}</h2>
                            <p>PDF documents</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        ${!this.currentUser.agronomistId ? `
                            <div class="card full-width-chart">
                                <div class="card-header">
                                    <h3><i class="fas fa-user-md"></i> Select Your Agronomist</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-info" onclick="system.showAgronomistComparison()">
                                            <i class="fas fa-chart-bar"></i> Compare
                                        </button>
                                    </div>
                                </div>
                                <div class="agronomist-selection-section" id="agronomistSelection">
                                    <!-- Agronomist selection will be loaded here -->
                                </div>
                            </div>
                        ` : `
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-user-md"></i> My Agronomist</h3>
                                </div>
                                <div id="myAgronomistInfo">
                                    <!-- Current agronomist info will be loaded here -->
                                </div>
                            </div>
                        `}
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-money-bill-wave"></i> Recent Expenses</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-danger" id="addExpenseBtnMain">
                                        <i class="fas fa-plus"></i> Add Expense
                                    </button>
                                </div>
                            </div>
                            <div class="expense-container">
                                ${expenses.length > 0 ? 
                                    expenses.slice(-3).reverse().map(exp => `
                                        <div class="expense-item">
                                            <span>${exp.description}</span>
                                            <span style="color: var(--danger);">KSH ${exp.amount.toLocaleString()}</span>
                                        </div>
                                    `).join('') : 
                                    '<p>No expenses recorded yet</p>'
                                }
                            </div>
                            <p style="margin-top: 10px; text-align: right;">
                                <strong>Total: KSH ${totalExpenses.toLocaleString()}</strong>
                            </p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-file-pdf"></i> PDF Documents</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-primary" id="viewMyPdfsBtn">
                                        <i class="fas fa-folder-open"></i> View PDFs
                                    </button>
                                </div>
                            </div>
                            <p>Access farming guides, reports, and certificates uploaded by your agronomist.</p>
                            <div style="margin-top: 10px;">
                                <span class="badge badge-info">
                                    <i class="fas fa-file-pdf"></i> ${pdfs.length} PDF Documents
                                </span>
                            </div>
                        </div>
                        
                        <div class="card full-width-chart">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-pie"></i> Expenses Overview</h3>
                            </div>
                            <div class="chart-container full-height">
                                <canvas id="expensesChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                
                if (!this.currentUser.agronomistId) {
                    this.loadAgronomistSelection();
                } else {
                    this.loadCurrentAgronomistInfo();
                }
                
                this.renderExpensesChart(expenses);
                
            } else if (this.userType === 'agronomist') {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                const systemReports = JSON.parse(localStorage.getItem('systemReports')) || [];
                const systemPdfs = JSON.parse(localStorage.getItem('systemPdfs')) || [];
                
                const myFarmers = farmers.filter(f => f.agronomistId === this.currentUser.id);
                const agronomistSales = tasks.filter(t => t.status === 'paid').reduce((sum, task) => sum + task.amount, 0);
                const agronomistExpenses = 0;
                const agronomistProfit = agronomistSales - agronomistExpenses;
                
                let totalAcres = 0;
                myFarmers.forEach(farmer => {
                    const farms = this.getFarmerData(farmer.id, 'farms');
                    totalAcres += farms.reduce((sum, farm) => sum + farm.size, 0);
                });
                
                document.getElementById('userAvatar').textContent = 'AA';
                document.getElementById('userName').textContent = 'Aaron Agronomist';
                document.getElementById('userRole').textContent = 'Agronomist';
                
                html = `
                    <div class="stats-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-users"></i> My Farmers</h3>
                            </div>
                            <h2 style="color: var(--success); margin: 20px 0;">${myFarmers.length}</h2>
                            <p>Farmers under management</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-money-bill-wave"></i> Consultation Sales</h3>
                            </div>
                            <h2 style="color: var(--primary); margin: 20px 0;">KSH ${agronomistSales.toLocaleString()}</h2>
                            <p>Total consultation fees</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-tasks"></i> My Profit</h3>
                            </div>
                            <h2 style="color: ${agronomistProfit >= 0 ? 'var(--success)' : 'var(--danger)'}; margin: 20px 0;">KSH ${agronomistProfit.toLocaleString()}</h2>
                            <p>Net earnings</p>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-farm"></i> Total Acres</h3>
                            </div>
                            <h2 style="color: var(--info); margin: 20px 0;">${totalAcres}</h2>
                            <p>Managed farmland</p>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-users"></i> My Farmers</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-info" onclick="system.toggleFarmersView()">
                                        <i class="fas fa-eye"></i> View More
                                    </button>
                                </div>
                            </div>
                            <div id="farmersTableContainer">
                                ${this.renderFarmersTable(myFarmers.slice(0, 3), true)}
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-tasks"></i> Recent Consultations</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-success" id="addTaskBtn">
                                        <i class="fas fa-plus"></i> Add Consultation
                                    </button>
                                </div>
                            </div>
                            <p>Record consultation sessions and payments.</p>
                            <div class="expense-container" style="margin-top: 15px;">
                                ${tasks.length > 0 ? 
                                    tasks.slice(-3).reverse().map(task => `
                                        <div class="expense-item">
                                            <span>${task.description.substring(0, 30)}...</span>
                                            <span style="color: var(--success);">KSH ${task.amount.toLocaleString()}</span>
                                        </div>
                                    `).join('') : 
                                    '<p>No consultations recorded yet</p>'
                                }
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-file-medical-alt"></i> Create Reports</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-success" id="createReportBtn">
                                        <i class="fas fa-plus"></i> New Report
                                    </button>
                                    <button class="btn btn-sm btn-primary" id="uploadPdfBtn">
                                        <i class="fas fa-upload"></i> Upload PDF
                                    </button>
                                </div>
                            </div>
                            <p>Create detailed reports and upload PDF documents for farmers.</p>
                            <div style="margin-top: 15px;">
                                <span class="badge badge-info">
                                    <i class="fas fa-file-alt"></i> ${systemReports.length} Reports
                                </span>
                                <span class="badge badge-warning" style="margin-left: 10px;">
                                    <i class="fas fa-file-pdf"></i> ${systemPdfs.length} PDFs
                                </span>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-receipt"></i> Invoices</h3>
                                <div class="card-actions">
                                    <button class="btn btn-sm btn-success" id="createInvoiceBtn">
                                        <i class="fas fa-plus"></i> Create Invoice
                                    </button>
                                </div>
                            </div>
                            <p>Create and manage invoices for farmers.</p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-sm btn-primary" onclick="system.downloadAllInvoices()">
                                    <i class="fas fa-download"></i> Download All Invoices
                                </button>
                            </div>
                        </div>
                        
                        <div class="card full-width-chart">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-area"></i> Consultation Performance</h3>
                            </div>
                            <div class="chart-container full-height">
                                <canvas id="agroChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                this.renderAgroChart(tasks);
            }
            
            document.getElementById('navLinks').classList.remove('active');
        }

        async loadSales(e = null) {
            if (e) e.preventDefault();
            
            if (this.userType === 'farmer') {
                this.loadDashboard();
                this.showNotification('Sales tracking is available to agronomists only', 'info');
                return;
            } else if (this.userType === 'agronomist') {
                const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                
                const tasksWithNames = tasks.map(task => {
                    let farmerName = 'Other Farmer';
                    if (task.farmerId !== 'external') {
                        const farmer = farmers.find(f => f.id === task.farmerId);
                        farmerName = farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Other Farmer';
                    } else {
                        farmerName = task.externalFarmerName || 'Other Farmer';
                    }
                    return {
                        ...task,
                        farmerName: farmerName
                    };
                });
                
                const totalSales = tasks.filter(t => t.status === 'paid').reduce((sum, task) => sum + task.amount, 0);
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-line"></i> Consultation Fees Overview</h3>
                            <div class="card-actions">
                                <button class="btn btn-success" id="addTaskBtn">
                                    <i class="fas fa-plus"></i> Add Consultation
                                </button>
                            </div>
                        </div>
                        
                        <div class="sales-summary">
                            <h3>Total Consultation Fees</h3>
                            <div class="total-sales">KSH ${totalSales.toLocaleString()}</div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Farmer</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Deadline</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                tasksWithNames.slice(-20).reverse().forEach(task => {
                    const isOverdue = task.deadline && new Date(task.deadline) < new Date() && task.status !== 'paid';
                    const deadlineDisplay = task.deadline ? new Date(task.deadline).toLocaleDateString() : 'N/A';
                    
                    html += `
                        <tr>
                            <td>${new Date(task.date).toLocaleDateString()}</td>
                            <td>${task.farmerName}</td>
                            <td>${task.description.substring(0, 50)}...</td>
                            <td>KSH ${task.amount.toFixed(2)}</td>
                            <td class="${isOverdue ? 'deadline-warning' : ''}">${deadlineDisplay}</td>
                            <td>
                                <span class="badge badge-${task.status === 'paid' ? 'success' : task.status === 'completed' ? 'warning' : task.status === 'overdue' ? 'danger' : 'info'}">
                                    ${task.status}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.viewTaskDetails('${task.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="system.deleteTask('${task.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="card" style="margin-top: 30px;">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-area"></i> Consultation Trends</h3>
                            </div>
                            <div class="chart-container full-height">
                                <canvas id="consultationChart"></canvas>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navSales').classList.add('active');
                
                this.renderConsultationChart(tasks);
                document.getElementById('navLinks').classList.remove('active');
            }
        }

        async loadFarms(e = null) {
            if (e) e.preventDefault();
            
            if (this.userType === 'farmer') {
                const farms = this.getFarmerData(this.currentUser.id, 'farms');
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-tractor"></i> My Farms</h3>
                            <div class="card-actions">
                                <button class="btn btn-success" onclick="system.showModal('addFarmModal')">
                                    <i class="fas fa-plus"></i> Add Farm
                                </button>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-farm"></i> Total Farms</h3>
                                </div>
                                <h2 style="color: var(--success); margin: 20px 0; font-size: 2.5rem;">${farms.length}</h2>
                                <p>Active farms</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-map-marker-alt"></i> Total Acres</h3>
                                </div>
                                <h2 style="color: var(--primary); margin: 20px 0; font-size: 2.5rem;">${farms.reduce((sum, farm) => sum + farm.size, 0)}</h2>
                                <p>Total farmland acreage</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-seedling"></i> Total Crops</h3>
                                </div>
                                <h2 style="color: var(--info); margin: 20px 0; font-size: 2.5rem;">${farms.reduce((sum, farm) => sum + (farm.crops ? farm.crops.length : 0), 0)}</h2>
                                <p>Different crops planted</p>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 30px;">
                            <div class="card-header">
                                <h3><i class="fas fa-list"></i> All Farms</h3>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Farm Name</th>
                                            <th>Location</th>
                                            <th>Size (acres)</th>
                                            <th>Soil Type</th>
                                            <th>Main Crops</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                farms.forEach(farm => {
                    const mainCrops = farm.crops ? farm.crops.map(crop => crop.name).join(', ') : 'No crops';
                    html += `
                        <tr>
                            <td><strong>${farm.name}</strong></td>
                            <td>${farm.location}</td>
                            <td>${farm.size}</td>
                            <td><span class="badge badge-info">${farm.soilType}</span></td>
                            <td>${mainCrops}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.viewFarmDetails('${farm.id}', '${this.currentUser.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
            } else if (this.userType === 'agronomist') {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const myFarmers = farmers.filter(f => f.agronomistId === this.currentUser.id);
                let allFarms = [];
                let totalAcres = 0;
                
                myFarmers.forEach(farmer => {
                    const farms = this.getFarmerData(farmer.id, 'farms');
                    allFarms = allFarms.concat(farms.map(farm => ({
                        ...farm,
                        farmerName: `${farmer.firstName} ${farmer.lastName}`,
                        farmerId: farmer.id
                    })));
                    totalAcres += farms.reduce((sum, farm) => sum + farm.size, 0);
                });
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-tractor"></i> Farms Overview</h3>
                            <div class="card-actions">
                                <span class="badge badge-success">
                                    <i class="fas fa-users"></i> ${myFarmers.length} Farmers
                                </span>
                                <span class="badge badge-primary" style="margin-left: 10px;">
                                    <i class="fas fa-farm"></i> ${allFarms.length} Farms
                                </span>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-users"></i> My Farmers</h3>
                                </div>
                                <h2 style="color: var(--success); margin: 20px 0; font-size: 2.5rem;">${myFarmers.length}</h2>
                                <p>Farmers under my management</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-farm"></i> Total Farms</h3>
                                </div>
                                <h2 style="color: var(--primary); margin: 20px 0; font-size: 2.5rem;">${allFarms.length}</h2>
                                <p>Active farms managed</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-map-marker-alt"></i> Total Acres</h3>
                                </div>
                                <h2 style="color: var(--info); margin: 20px 0; font-size: 2.5rem;">${totalAcres}</h2>
                                <p>Total farmland acreage</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-seedling"></i> Total Crops</h3>
                                </div>
                                <h2 style="color: var(--secondary); margin: 20px 0; font-size: 2.5rem;">
                                    ${allFarms.reduce((sum, farm) => sum + (farm.crops ? farm.crops.length : 0), 0)}
                                </h2>
                                <p>Different crops planted</p>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 30px;">
                            <div class="card-header">
                                <h3><i class="fas fa-list"></i> All Farms</h3>
                            </div>
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Farm Name</th>
                                            <th>Farmer</th>
                                            <th>Location</th>
                                            <th>Size (acres)</th>
                                            <th>Soil Type</th>
                                            <th>Main Crops</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                `;
                
                allFarms.forEach(farm => {
                    const mainCrops = farm.crops ? farm.crops.map(crop => crop.name).join(', ') : 'No crops';
                    html += `
                        <tr>
                            <td><strong>${farm.name}</strong></td>
                            <td>${farm.farmerName}</td>
                            <td>${farm.location}</td>
                            <td>${farm.size}</td>
                            <td><span class="badge badge-info">${farm.soilType}</span></td>
                            <td>${mainCrops}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.viewFarmDetails('${farm.id}', '${farm.farmerId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
            }
            
            document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
            document.getElementById('navFarms').classList.add('active');
            document.getElementById('navLinks').classList.remove('active');
        }

        async loadExpenses() {
            if (this.userType !== 'farmer') return;
            
            const expenses = this.getFarmerData(this.currentUser.id, 'expenses');
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-money-bill-wave"></i> My Expenses</h3>
                        <div class="card-actions">
                            <button class="btn btn-success" id="addExpenseBtnMain">
                                <i class="fas fa-plus"></i> Add Expense
                            </button>
                            <button class="btn btn-primary" onclick="system.downloadExpensesExcel()">
                                <i class="fas fa-download"></i> Export Excel
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Amount (KSH)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            expenses.slice(-20).reverse().forEach(expense => {
                html += `
                    <tr>
                        <td>${new Date(expense.date).toLocaleDateString()}</td>
                        <td><span class="badge badge-info">${expense.category}</span></td>
                        <td>${expense.description}</td>
                        <td style="color: var(--danger);">KSH ${expense.amount.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="system.deleteExpense('${expense.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            
            html += `
                            </tbody>
                            <tfoot>
                                <tr style="background-color: #f8f9fa; font-weight: bold;">
                                    <td colspan="3">Total Expenses</td>
                                    <td style="color: var(--danger);">KSH ${totalExpenses.toFixed(2)}</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="card" style="margin-top: 30px;">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-pie"></i> Expenses Breakdown</h3>
                        </div>
                        <div class="chart-container full-height">
                            <canvas id="expensesChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
            this.renderExpensesChart(expenses);
        }

        async loadReports(e = null) {
            if (e) e.preventDefault();
            
            if (this.userType === 'farmer') {
                const reports = this.getFarmerData(this.currentUser.id, 'reports');
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-file-medical-alt"></i> Farm Reports</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="system.downloadAllReports()">
                                    <i class="fas fa-download"></i> Download All
                                </button>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                `;
                
                reports.forEach(report => {
                    html += `
                        <div class="card">
                            <div class="card-header">
                                <h3>${report.title}</h3>
                                <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                    ${report.status}
                                </span>
                            </div>
                            <p><strong>Type:</strong> ${report.type.replace('_', ' ')}</p>
                            <p><strong>Date:</strong> ${new Date(report.date).toLocaleDateString()}</p>
                            <p><strong>Findings:</strong> ${report.findings.substring(0, 100)}...</p>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-info" onclick="system.viewReport('${report.id}', '${this.currentUser.id}')">
                                    <i class="fas fa-eye"></i> View Full Report
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
            } else if (this.userType === 'agronomist') {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const systemReports = JSON.parse(localStorage.getItem('systemReports')) || [];
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-file-alt"></i> All Reports</h3>
                            <div class="card-actions">
                                <button class="btn btn-success" id="createReportBtn">
                                    <i class="fas fa-plus"></i> Create Report
                                </button>
                                <button class="btn btn-primary" onclick="system.downloadAllReports()">
                                    <i class="fas fa-download"></i> Export All
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Farmer</th>
                                        <th>Report Title</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                systemReports.forEach(report => {
                    const farmer = farmers.find(f => f.id === report.farmerId);
                    html += `
                        <tr>
                            <td>${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</td>
                            <td>${report.title}</td>
                            <td>${report.type.replace('_', ' ')}</td>
                            <td>${new Date(report.date).toLocaleDateString()}</td>
                            <td>
                                <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                    ${report.status}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.viewReport('${report.id}', '${report.farmerId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="system.editReportStatus('${report.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
            }
            
            document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
            document.getElementById('navReports').classList.add('active');
            document.getElementById('navLinks').classList.remove('active');
        }

        async loadInvoices(e = null) {
            if (e) e.preventDefault();
            
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-receipt"></i> Invoices</h3>
                        ${this.userType === 'agronomist' ? `
                            <div class="card-actions">
                                <button class="btn btn-success" id="createInvoiceBtn">
                                    <i class="fas fa-plus"></i> Create Invoice
                                </button>
                                <button class="btn btn-primary" onclick="system.downloadAllInvoices()">
                                    <i class="fas fa-download"></i> Export All
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Farmer</th>
                                    <th>Date</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            if (this.userType === 'farmer') {
                const invoices = this.getFarmerData(this.currentUser.id, 'invoices');
                
                invoices.forEach(invoice => {
                    const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    
                    html += `
                        <tr>
                            <td>${invoice.id}</td>
                            <td>${this.currentUser.firstName} ${this.currentUser.lastName}</td>
                            <td>${new Date(invoice.date).toLocaleDateString()}</td>
                            <td>${new Date(invoice.dueDate).toLocaleDateString()}</td>
                            <td>KSH ${total.toFixed(2)}</td>
                            <td>
                                <span class="badge ${invoice.paid ? 'badge-success' : 'badge-warning'}">
                                    ${invoice.paid ? 'Paid' : 'Pending'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.previewInvoice('${invoice.id}', '${this.currentUser.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            } else if (this.userType === 'agronomist') {
                const allFarmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const externalInvoices = JSON.parse(localStorage.getItem('externalInvoices')) || [];
                let allInvoices = [];
                
                allFarmers.forEach(farmer => {
                    const invoices = this.getFarmerData(farmer.id, 'invoices');
                    allInvoices = allInvoices.concat(invoices.map(invoice => ({
                        ...invoice,
                        farmerName: `${farmer.firstName} ${farmer.lastName}`,
                        farmerId: farmer.id
                    })));
                });
                
                allInvoices = allInvoices.concat(externalInvoices.map(invoice => ({
                    ...invoice,
                    farmerName: invoice.externalName || 'Other Farmer',
                    farmerId: 'external'
                })));
                
                allInvoices.forEach(invoice => {
                    const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    
                    html += `
                        <tr>
                            <td>${invoice.id}</td>
                            <td>${invoice.farmerName}</td>
                            <td>${new Date(invoice.date).toLocaleDateString()}</td>
                            <td>${new Date(invoice.dueDate).toLocaleDateString()}</td>
                            <td>KSH ${total.toFixed(2)}</td>
                            <td>
                                <span class="badge ${invoice.paid ? 'badge-success' : 'badge-warning'}">
                                    ${invoice.paid ? 'Paid' : 'Pending'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.previewInvoice('${invoice.id}', '${invoice.farmerId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="system.editInvoice('${invoice.id}', '${invoice.farmerId}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
            document.getElementById('navInvoices').classList.add('active');
            document.getElementById('navLinks').classList.remove('active');
        }

        async handleAddSale(e) {
            e.preventDefault();
            
            if (!this.currentUser || this.userType !== 'agronomist') {
                this.showNotification('Only agronomists can add consultations', 'error');
                return;
            }
            
            const farmerSelect = document.getElementById('saleFarmer').value;
            let farmerId = farmerSelect;
            let externalFarmerName = '';
            let externalFarmerPhone = '';
            
            if (farmerSelect === 'external') {
                farmerId = 'external';
                externalFarmerName = document.getElementById('externalFarmerName').value;
                externalFarmerPhone = document.getElementById('externalFarmerPhone').value;
                
                if (!externalFarmerName) {
                    this.showNotification('Please enter farmer name', 'error');
                    return;
                }
            }
            
            const sale = {
                id: 'SALE-' + Date.now(),
                farmerId: farmerId,
                externalFarmerName: externalFarmerName,
                externalFarmerPhone: externalFarmerPhone,
                date: document.getElementById('saleDate').value,
                description: document.getElementById('saleDescription').value,
                amount: parseFloat(document.getElementById('saleAmount').value),
                deadline: document.getElementById('saleDeadline').value || null,
                status: document.getElementById('saleStatus').value,
                createdBy: this.currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            tasks.push(sale);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            this.hideModal('addSaleModal');
            this.loadDashboard();
            this.showNotification('Consultation added successfully!', 'success');
            
            document.getElementById('addSaleForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('saleDate').value = today;
            document.getElementById('externalFarmerDetails').style.display = 'none';
        }

        async handleAddExpense(e) {
            e.preventDefault();
            
            if (!this.currentUser || this.userType !== 'farmer') {
                this.showNotification('You must be logged in as a farmer to add expenses', 'error');
                return;
            }
            
            const expense = {
                id: 'EXP-' + Date.now(),
                farmerId: this.currentUser.id,
                date: document.getElementById('expenseDate').value,
                category: document.getElementById('expenseCategory').value,
                description: document.getElementById('expenseDescription').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                createdAt: new Date().toISOString()
            };
            
            const farmerExpenses = this.getFarmerData(this.currentUser.id, 'expenses');
            farmerExpenses.push(expense);
            this.saveFarmerData(this.currentUser.id, 'expenses', farmerExpenses);
            
            this.hideModal('addExpenseModal');
            this.loadDashboard();
            this.showNotification('Expense added successfully!', 'success');
            
            document.getElementById('addExpenseForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
        }

        async handleAddTask(e) {
            e.preventDefault();
            
            if (!this.currentUser || this.userType !== 'agronomist') {
                this.showNotification('Only agronomists can add consultations', 'error');
                return;
            }
            
            const farmerSelect = document.getElementById('taskFarmer').value;
            let farmerId = farmerSelect;
            let externalFarmerName = '';
            let externalFarmerPhone = '';
            
            if (farmerSelect === 'external') {
                farmerId = 'external';
                externalFarmerName = document.getElementById('externalTaskFarmerName').value;
                externalFarmerPhone = document.getElementById('externalTaskFarmerPhone').value;
                
                if (!externalFarmerName) {
                    this.showNotification('Please enter farmer name', 'error');
                    return;
                }
            }
            
            const task = {
                id: 'TASK-' + Date.now(),
                farmerId: farmerId,
                externalFarmerName: externalFarmerName,
                externalFarmerPhone: externalFarmerPhone,
                date: document.getElementById('taskDate').value,
                description: document.getElementById('taskDescription').value,
                amount: parseFloat(document.getElementById('taskAmount').value),
                deadline: document.getElementById('taskDeadline').value || null,
                status: document.getElementById('taskStatus').value,
                createdBy: this.currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            tasks.push(task);
            localStorage.setItem('tasks', JSON.stringify(tasks));
            
            this.hideModal('addTaskModal');
            this.loadDashboard();
            this.showNotification('Consultation added successfully!', 'success');
            
            document.getElementById('addTaskForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('taskDate').value = today;
            document.getElementById('externalTaskFarmerDetails').style.display = 'none';
        }

        async handleAddFarm(e) {
            e.preventDefault();
            
            if (!this.currentUser || this.userType !== 'farmer') {
                this.showNotification('You must be logged in as a farmer to add farms', 'error');
                return;
            }
            
            const crops = [];
            document.querySelectorAll('.crop-field-item').forEach(item => {
                const name = item.querySelector('.crop-name').value;
                const acreage = parseFloat(item.querySelector('.crop-acreage').value);
                const status = item.querySelector('.crop-status').value;
                
                if (name && acreage) {
                    crops.push({
                        name: name,
                        acreage: acreage,
                        status: status
                    });
                }
            });
            
            const farm = {
                id: 'FARM-' + Date.now(),
                farmerId: this.currentUser.id,
                name: document.getElementById('farmName').value,
                size: parseFloat(document.getElementById('farmSize').value),
                location: document.getElementById('farmLocation').value,
                soilType: document.getElementById('farmSoil').value,
                crops: crops,
                createdAt: new Date().toISOString()
            };
            
            const farmerFarms = this.getFarmerData(this.currentUser.id, 'farms');
            farmerFarms.push(farm);
            this.saveFarmerData(this.currentUser.id, 'farms', farmerFarms);
            
            this.hideModal('addFarmModal');
            this.loadDashboard();
            this.showNotification('Farm added successfully!', 'success');
            
            document.getElementById('addFarmForm').reset();
        }

        loadFarmersForReport() {
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const agronomists = JSON.parse(localStorage.getItem('agronomists')) || [];
            const currentAgronomist = agronomists.find(a => a.id === this.currentUser.id);
            
            const select = document.getElementById('reportFarmer');
            select.innerHTML = '<option value="">Select Farmer</option>';
            
            if (currentAgronomist && currentAgronomist.farmers) {
                currentAgronomist.farmers.forEach(farmerId => {
                    const farmer = farmers.find(f => f.id === farmerId);
                    if (farmer) {
                        const option = document.createElement('option');
                        option.value = farmer.id;
                        option.textContent = `${farmer.firstName} ${farmer.lastName} (${farmer.location})`;
                        select.appendChild(option);
                    }
                });
            }
            
            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
        }

        loadFarmersForInvoice() {
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const agronomists = JSON.parse(localStorage.getItem('agronomists')) || [];
            const currentAgronomist = agronomists.find(a => a.id === this.currentUser.id);
            
            const select = document.getElementById('invoiceFarmer');
            select.innerHTML = '<option value="">Select Farmer</option>';
            
            select.innerHTML += '<option value="external">Other Farmer (Not in Portal)</option>';
            
            if (currentAgronomist && currentAgronomist.farmers) {
                currentAgronomist.farmers.forEach(farmerId => {
                    const farmer = farmers.find(f => f.id === farmerId);
                    if (farmer) {
                        const option = document.createElement('option');
                        option.value = farmer.id;
                        option.textContent = `${farmer.firstName} ${farmer.lastName} (${farmer.location})`;
                        select.appendChild(option);
                    }
                });
            }
            
            const today = new Date().toISOString().split('T')[0];
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            const dueDateStr = dueDate.toISOString().split('T')[0];
            
            document.getElementById('invoiceDate').value = today;
            document.getElementById('invoiceDueDate').value = dueDateStr;
        }

        loadFarmersForTask() {
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const agronomists = JSON.parse(localStorage.getItem('agronomists')) || [];
            const currentAgronomist = agronomists.find(a => a.id === this.currentUser.id);
            
            const select = document.getElementById('taskFarmer');
            select.innerHTML = '<option value="">Select Farmer</option>';
            select.innerHTML += '<option value="external">Other Farmer (Not in Portal)</option>';
            
            if (currentAgronomist && currentAgronomist.farmers) {
                currentAgronomist.farmers.forEach(farmerId => {
                    const farmer = farmers.find(f => f.id === farmerId);
                    if (farmer) {
                        const option = document.createElement('option');
                        option.value = farmer.id;
                        option.textContent = `${farmer.firstName} ${farmer.lastName} (${farmer.location})`;
                        select.appendChild(option);
                    }
                });
            }
            
            document.getElementById('taskDate').value = new Date().toISOString().split('T')[0];
        }

        loadFarmersForPdfUpload() {
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const agronomists = JSON.parse(localStorage.getItem('agronomists')) || [];
            const currentAgronomist = agronomists.find(a => a.id === this.currentUser.id);
            
            const select = document.getElementById('pdfFarmer');
            select.innerHTML = '<option value="">Select Farmer</option>';
            
            if (currentAgronomist && currentAgronomist.farmers) {
                currentAgronomist.farmers.forEach(farmerId => {
                    const farmer = farmers.find(f => f.id === farmerId);
                    if (farmer) {
                        const option = document.createElement('option');
                        option.value = farmer.id;
                        option.textContent = `${farmer.firstName} ${farmer.lastName} (${farmer.location})`;
                        select.appendChild(option);
                    }
                });
            }
        }

        loadFarmersForSale() {
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const agronomists = JSON.parse(localStorage.getItem('agronomists')) || [];
            const currentAgronomist = agronomists.find(a => a.id === this.currentUser.id);
            
            const select = document.getElementById('saleFarmer');
            select.innerHTML = '<option value="">Select Farmer</option>';
            select.innerHTML += '<option value="external">Other Farmer (Not in Portal)</option>';
            
            if (currentAgronomist && currentAgronomist.farmers) {
                currentAgronomist.farmers.forEach(farmerId => {
                    const farmer = farmers.find(f => f.id === farmerId);
                    if (farmer) {
                        const option = document.createElement('option');
                        option.value = farmer.id;
                        option.textContent = `${farmer.firstName} ${farmer.lastName} (${farmer.location})`;
                        select.appendChild(option);
                    }
                });
            }
            
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
        }

        loadAgronomistSelection() {
            const agronomists = JSON.parse(localStorage.getItem('agronomists')) || [];
            const container = document.getElementById('agronomistSelection');
            
            if (!container) return;
            
            let html = '';
            
            if (agronomists.length === 0) {
                html = `
                    <div class="pdf-upload-container" style="background: white; text-align: center; padding: 40px 20px;">
                        <i class="fas fa-user-md" style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;"></i>
                        <h4>No Agronomists Available</h4>
                        <p>Agronomists will appear here when they register with the system.</p>
                        <p style="color: var(--gray); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> Contact admin for assistance
                        </p>
                    </div>
                `;
            } else {
                // Sort agronomists by rating (highest first)
                const sortedAgronomists = agronomists.sort((a, b) => b.rating - a.rating);
                
                html = `
                    <div style="margin-bottom: 20px; text-align: center;">
                        <h3 style="color: var(--primary);">Select Your Agronomist</h3>
                        <p style="color: var(--gray);">Choose from our certified agronomists to manage your farm</p>
                        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                            <span class="badge badge-info"><i class="fas fa-star"></i> ${sortedAgronomists.length} Available</span>
                            <span class="badge badge-success"><i class="fas fa-users"></i> ${sortedAgronomists.reduce((sum, a) => sum + (a.farmersCount || 0), 0)} Farmers Served</span>
                        </div>
                    </div>
                    
                    <div class="agronomist-grid">
                `;
                
                sortedAgronomists.forEach(agronomist => {
                    const isSelected = this.currentUser?.agronomistId === agronomist.id;
                    const stars = ''.repeat(Math.floor(agronomist.rating || 4)) + ''.repeat(5 - Math.floor(agronomist.rating || 4));
                    
                    html += `
                        <div class="agronomist-card ${isSelected ? 'selected' : ''}" onclick="system.selectAgronomist('${agronomist.id}')">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <div style="width: 60px; height: 60px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                                    <img src="${agronomist.profileImage}" alt="${agronomist.name}" 
                                         style="width: 100%; height: 100%; object-fit: cover;" 
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiMyRTdEMzIiLz4KPGNpcmNsZSBjeD0iMzAiIGN5PSIyNCIgcj0iOCIgb3BhY2l0eT0iMC42IiBmaWxsPSJ3aGl0ZSIvPgo8Y2lyY2xlIGN4PSIzMCIgY3k9IjQyIiByPSIxNCIgb3BhY2l0eT0iMC42IiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K'">
                                </div>
                                <div>
                                    <h4 style="margin: 0; color: var(--primary);">${agronomist.name}</h4>
                                    <div style="color: #FF9800; margin: 5px 0;">
                                        ${stars} <span style="color: var(--gray); font-size: 0.9em;">${agronomist.rating}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <p><i class="fas fa-map-marker-alt"></i> <strong>Location:</strong> ${agronomist.location}</p>
                                <p><i class="fas fa-graduation-cap"></i> <strong>Experience:</strong> ${agronomist.experience || '5+ years'}</p>
                                <p><i class="fas fa-users"></i> <strong>Farmers:</strong> ${agronomist.farmersCount || 0} served</p>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <strong>Specialties:</strong>
                                <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px;">
                                    ${agronomist.specialties.map(specialty => 
                                        `<span style="background: #e8f5e8; color: var(--primary); padding: 3px 8px; border-radius: 12px; font-size: 0.8em;">${specialty}</span>`
                                    ).join('')}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <p><i class="fas fa-envelope"></i> ${agronomist.email}</p>
                                <p><i class="fas fa-phone"></i> ${agronomist.phone}</p>
                            </div>
                            
                            ${isSelected ? 
                                `<button class="btn btn-success" style="width: 100%;">
                                    <i class="fas fa-check-circle"></i> Current Agronomist
                                </button>` :
                                `<button class="btn btn-primary select-agronomist-btn" data-id="${agronomist.id}" style="width: 100%;">
                                    <i class="fas fa-user-check"></i> Select Agronomist
                                </button>`
                            }
                            
                            <div style="margin-top: 10px; text-align: center;">
                                <small style="color: var(--gray);">
                                    <i class="fas fa-info-circle"></i> Click to select or view details
                                </small>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: center;">
                        <h4 style="color: var(--primary);">Need Help Choosing?</h4>
                        <p>All our agronomists are certified professionals. You can:</p>
                        <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-top: 15px;">
                            <button class="btn btn-sm btn-info" onclick="system.showAgronomistComparison()">
                                <i class="fas fa-chart-bar"></i> Compare Agronomists
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="system.contactAdminForHelp()">
                                <i class="fas fa-headset"></i> Get Recommendations
                            </button>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        showAgronomistComparison() {
            const agronomists = JSON.parse(localStorage.getItem('agronomists')) || [];
            const sortedAgronomists = agronomists.sort((a, b) => b.rating - a.rating);
            
            let html = `
                <div class="invoice">
                    <div class="invoice-header">
                        <h2>Agronomist Comparison</h2>
                        <p>Compare our certified agronomists to make the best choice</p>
                    </div>
                    
                    <div class="table-responsive" style="margin-top: 20px;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Agronomist</th>
                                    <th>Rating</th>
                                    <th>Experience</th>
                                    <th>Location</th>
                                    <th>Farmers Served</th>
                                    <th>Specialties</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            sortedAgronomists.forEach(agronomist => {
                const isSelected = this.currentUser?.agronomistId === agronomist.id;
                html += `
                    <tr>
                        <td>
                            <strong>${agronomist.name}</strong><br>
                            <small>${agronomist.email}</small>
                        </td>
                        <td>
                            <div style="color: #FF9800;">
                                 ${agronomist.rating}/5.0
                            </div>
                        </td>
                        <td>${agronomist.experience || '5+ years'}</td>
                        <td>${agronomist.location}</td>
                        <td>${agronomist.farmersCount || 0}</td>
                        <td>
                            <div style="max-width: 200px;">
                                ${agronomist.specialties.slice(0, 3).map(s => `<span class="badge badge-info" style="margin: 2px;">${s}</span>`).join('')}
                                ${agronomist.specialties.length > 3 ? `<span class="badge" style="margin: 2px;">+${agronomist.specialties.length - 3} more</span>` : ''}
                            </div>
                        </td>
                        <td>
                            ${isSelected ? 
                                `<span class="badge badge-success"><i class="fas fa-check"></i> Selected</span>` :
                                `<button class="btn btn-sm btn-primary" onclick="system.selectAgronomist('${agronomist.id}')">
                                    <i class="fas fa-user-check"></i> Select
                                </button>`
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f0f8ff; border-radius: 10px;">
                        <h4><i class="fas fa-lightbulb"></i> Choosing Tips:</h4>
                        <ul style="margin-left: 20px;">
                            <li><strong>Location:</strong> Choose an agronomist familiar with your region's climate</li>
                            <li><strong>Specialties:</strong> Match their expertise with your farming needs</li>
                            <li><strong>Rating:</strong> Higher-rated agronomists often have more satisfied clients</li>
                            <li><strong>Availability:</strong> Contact them directly to discuss availability</li>
                        </ul>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i> Close Comparison
                        </button>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 1000px;">
                    <div class="modal-header">
                        <h3>Compare Agronomists</h3>
                        <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${html}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        contactAdminForHelp() {
            const html = `
                <div class="invoice" style="text-align: center; padding: 30px;">
                    <div class="invoice-header">
                        <h2><i class="fas fa-headset"></i> Need Help Choosing?</h2>
                        <p>Our support team can help you select the best agronomist</p>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <i class="fas fa-user-tie" style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;"></i>
                        <h3>Contact Admin Support</h3>
                        <p>Get personalized recommendations based on:</p>
                        <ul style="text-align: left; display: inline-block; margin: 20px 0;">
                            <li>Your farm location and size</li>
                            <li>Crop types you're growing</li>
                            <li>Specific challenges you're facing</li>
                            <li>Your budget and goals</li>
                        </ul>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <h4>Contact Information</h4>
                        <div style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
                            <div>
                                <i class="fas fa-envelope"></i>
                                <strong>Email:</strong> support@mkulimadigital.com
                            </div>
                            <div>
                                <i class="fas fa-phone"></i>
                                <strong>Phone:</strong> 0700-123-456
                            </div>
                            <div>
                                <i class="fas fa-clock"></i>
                                <strong>Hours:</strong> Mon-Fri, 8AM-5PM
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-times"></i> Close
                        </button>
                        <button class="btn btn-success" onclick="system.sendHelpRequest()">
                            <i class="fas fa-paper-plane"></i> Send Help Request
                        </button>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Get Help Choosing</h3>
                        <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${html}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        sendHelpRequest() {
            const message = prompt("Please describe your farming needs and any specific requirements:");
            if (message) {
                const request = {
                    id: 'HELP-' + Date.now(),
                    farmerId: this.currentUser.id,
                    farmerName: `${this.currentUser.firstName} ${this.currentUser.lastName}`,
                    message: message,
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                // Store help requests in localStorage
                const helpRequests = JSON.parse(localStorage.getItem('helpRequests')) || [];
                helpRequests.push(request);
                localStorage.setItem('helpRequests', JSON.stringify(helpRequests));
                
                this.showNotification('Help request sent! Our team will contact you within 24 hours.', 'success');
                
                // Close modal
                document.querySelectorAll('.modal').forEach(modal => {
                    if (modal.style.display === 'flex') {
                        modal.remove();
                    }
                });
            }
        }

        selectAgronomist(agronomistId) {
            if (confirm("Are you sure you want to select this agronomist? This will assign them to manage your farm.")) {
                const agronomists = JSON.parse(localStorage.getItem('agronomists')) || [];
                const agronomist = agronomists.find(a => a.id === agronomistId);
                
                if (!agronomist) {
                    this.showNotification('Agronomist not found', 'error');
                    return;
                }
                
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const farmerIndex = farmers.findIndex(f => f.id === this.currentUser.id);
                
                if (farmerIndex !== -1) {
                    // Update farmer's agronomist
                    farmers[farmerIndex].agronomistId = agronomistId;
                    farmers[farmerIndex].agronomistSelectedAt = new Date().toISOString();
                    this.saveAllFarmers(farmers);
                    this.currentUser.agronomistId = agronomistId;
                    this.saveToLocalStorage();
                    
                    // Update agronomist's farmer list
                    const agroIndex = agronomists.findIndex(a => a.id === agronomistId);
                    if (agroIndex !== -1) {
                        if (!agronomists[agroIndex].farmers) {
                            agronomists[agroIndex].farmers = [];
                        }
                        if (!agronomists[agroIndex].farmers.includes(this.currentUser.id)) {
                            agronomists[agroIndex].farmers.push(this.currentUser.id);
                        }
                        // Increment farmers count
                        agronomists[agroIndex].farmersCount = (agronomists[agroIndex].farmersCount || 0) + 1;
                        localStorage.setItem('agronomists', JSON.stringify(agronomists));
                    }
                    
                    this.showNotification(`Successfully selected ${agronomist.name} as your agronomist! They will contact you soon.`, 'success');
                    
                    // Show confirmation modal
                    this.showAgronomistConfirmation(agronomist);
                }
            }
        }

        showAgronomistConfirmation(agronomist) {
            const html = `
                <div class="invoice" style="text-align: center; padding: 30px;">
                    <div class="invoice-header" style="background: var(--success);">
                        <h2><i class="fas fa-check-circle"></i> Agronomist Selected!</h2>
                        <p>Your farm is now under professional management</p>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <div style="width: 100px; height: 100px; border-radius: 50%; background: #f0f0f0; display: inline-flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 20px;">
                            <img src="${agronomist.profileImage}" alt="${agronomist.name}" 
                                 style="width: 100%; height: 100%; object-fit: cover;" 
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjUwIiBmaWxsPSIjMkU3RDMyIi8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNDAiIHI9IjEzIiBvcGFjaXR5PSIwLjYiIGZpbGw9IndoaXRlIi8+CjxjaXJjbGUgY3g9IjUwIiBjeT0iNzAiIHI9IjIzIiBvcGFjaXR5PSIwLjYiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo='">
                        </div>
                        <h3 style="color: var(--primary);">${agronomist.name}</h3>
                        <p><strong>Your assigned agronomist</strong></p>
                        
                        <div style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; text-align: left;">
                            <h4>What happens next:</h4>
                            <ol style="margin-left: 20px;">
                                <li>Your agronomist will contact you within 24 hours</li>
                                <li>They will schedule an initial farm assessment</li>
                                <li>You'll receive a personalized farming plan</li>
                                <li>Regular consultations and monitoring will begin</li>
                            </ol>
                        </div>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <h4>Agronomist Contact Details</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div>
                                <i class="fas fa-envelope"></i>
                                <p><small>Email</small><br><strong>${agronomist.email}</strong></p>
                            </div>
                            <div>
                                <i class="fas fa-phone"></i>
                                <p><small>Phone</small><br><strong>${agronomist.phone}</strong></p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="system.loadDashboard()" style="width: 100%;">
                            <i class="fas fa-home"></i> Return to Dashboard
                        </button>
                        <button class="btn btn-secondary" onclick="this.parentElement.parentElement.parentElement.remove()" style="width: 100%; margin-top: 10px;">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Agronomist Selected</h3>
                        <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${html}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        loadCurrentAgronomistInfo() {
            if (!this.currentUser.agronomistId || this.userType !== 'farmer') return;
            
            const agronomists = JSON.parse(localStorage.getItem('agronomists')) || [];
            const agronomist = agronomists.find(a => a.id === this.currentUser.agronomistId);
            
            if (!agronomist) return;
            
            const container = document.getElementById('myAgronomistInfo');
            if (!container) return;
            
            const stars = ''.repeat(Math.floor(agronomist.rating || 4)) + ''.repeat(5 - Math.floor(agronomist.rating || 4));
            
            const html = `
                <div style="text-align: center; padding: 15px;">
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: #f0f0f0; overflow: hidden; flex-shrink: 0;">
                            <img src="${agronomist.profileImage}" alt="${agronomist.name}" 
                                 style="width: 100%; height: 100%; object-fit: cover;"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiMyRTdEMzIiLz4KPGNpcmNsZSBjeD0iNDAiIGN5PSIzMiIgcj0iMTAiIG9wYWNpdHk9IjAuNiIgZmlsbD0id2hpdGUiLz4KPGNpcmNsZSBjeD0iNDAiIGN5PSI1NiIgcj0iMTgiIG9wYWNpdHk9IjAuNiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg=='">
                        </div>
                        <div style="text-align: left;">
                            <h4 style="margin: 0; color: var(--primary);">${agronomist.name}</h4>
                            <div style="color: #FF9800; margin: 5px 0;">
                                ${stars} <span style="color: var(--gray);">${agronomist.rating}/5.0</span>
                            </div>
                            <p style="margin: 5px 0;"><i class="fas fa-map-marker-alt"></i> ${agronomist.location}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <div style="color: var(--gray); font-size: 0.9rem;">Experience</div>
                            <div style="font-weight: bold; color: var(--primary);">${agronomist.experience}</div>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px;">
                            <div style="color: var(--gray); font-size: 0.9rem;">Farmers</div>
                            <div style="font-weight: bold; color: var(--success);">${agronomist.farmersCount || 0}</div>
                        </div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <strong>Contact:</strong>
                        <p style="margin: 5px 0;"><i class="fas fa-envelope"></i> ${agronomist.email}</p>
                        <p style="margin: 5px 0;"><i class="fas fa-phone"></i> ${agronomist.phone}</p>
                    </div>
                    
                    <button class="btn btn-sm btn-secondary" onclick="system.changeAgronomist()" style="margin-top: 10px;">
                        <i class="fas fa-exchange-alt"></i> Change Agronomist
                    </button>
                </div>
            `;
            
            container.innerHTML = html;
        }

        changeAgronomist() {
            if (confirm("Are you sure you want to change your agronomist? This will remove your current agronomist and you'll need to select a new one.")) {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const farmerIndex = farmers.findIndex(f => f.id === this.currentUser.id);
                
                if (farmerIndex !== -1) {
                    farmers[farmerIndex].agronomistId = null;
                    this.saveAllFarmers(farmers);
                    this.currentUser.agronomistId = null;
                    this.saveToLocalStorage();
                    
                    this.loadDashboard();
                    this.showNotification('Agronomist removed. Please select a new one.', 'info');
                }
            }
        }

        async handleCreateReport(e) {
            e.preventDefault();
            
            if (!this.currentUser || this.userType !== 'agronomist') {
                this.showNotification('Only agronomists can create reports', 'error');
                return;
            }
            
            const includePdf = confirm('Would you like to also save this as a PDF?');
            
            const report = {
                id: 'REPORT-' + Date.now(),
                farmerId: document.getElementById('reportFarmer').value,
                title: document.getElementById('reportTitle').value,
                type: document.getElementById('reportType').value,
                date: document.getElementById('reportDate').value,
                findings: document.getElementById('reportFindings').value,
                recommendations: document.getElementById('reportRecommendations').value,
                status: document.getElementById('reportStatus').value,
                createdBy: this.currentUser.id,
                createdAt: new Date().toISOString()
            };
            
            const systemReports = JSON.parse(localStorage.getItem('systemReports')) || [];
            systemReports.push(report);
            localStorage.setItem('systemReports', JSON.stringify(systemReports));
            
            const farmerReports = this.getFarmerData(report.farmerId, 'reports');
            farmerReports.push(report);
            this.saveFarmerData(report.farmerId, 'reports', farmerReports);
            
            if (includePdf) {
                const pdf = {
                    id: 'PDF-' + Date.now(),
                    farmerId: report.farmerId,
                    title: report.title,
                    description: `Report: ${report.type} - ${report.date}`,
                    category: 'reports',
                    fileName: `report_${report.id}.pdf`,
                    fileSize: '100KB',
                    hasData: true,
                    uploadedBy: this.currentUser.id,
                    uploadedAt: new Date().toISOString(),
                    downloaded: false,
                    pdfText: `Report Title: ${report.title}\n\nType: ${report.type}\nDate: ${report.date}\nStatus: ${report.status}\n\nFINDINGS:\n${report.findings}\n\nRECOMMENDATIONS:\n${report.recommendations}`
                };
                
                const systemPdfs = JSON.parse(localStorage.getItem('systemPdfs')) || [];
                systemPdfs.push(pdf);
                localStorage.setItem('systemPdfs', JSON.stringify(systemPdfs));
                
                const farmerPdfs = this.getFarmerData(report.farmerId, 'pdfs');
                farmerPdfs.push(pdf);
                this.saveFarmerData(report.farmerId, 'pdfs', farmerPdfs);
            }
            
            this.hideModal('createReportModal');
            this.loadDashboard();
            this.showNotification('Report created successfully!' + (includePdf ? ' (PDF also created)' : ''), 'success');
            
            document.getElementById('createReportForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
        }

        async handleUploadPdf(e) {
            e.preventDefault();
            
            if (!this.currentUser || this.userType !== 'agronomist') {
                this.showNotification('Only agronomists can upload PDFs', 'error');
                return;
            }
            
            const fileInput = document.getElementById('pdfFile');
            if (!fileInput.files.length) {
                this.showNotification('Please select a PDF file', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            if (file.type !== 'application/pdf') {
                this.showNotification('Only PDF files are allowed', 'error');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                this.showNotification('File size must be less than 10MB', 'error');
                return;
            }
            
            // Use FileReader to read as ArrayBuffer instead of Data URL to avoid size issues
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const arrayBuffer = event.target.result;
                    
                    const pdf = {
                        id: 'PDF-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                        farmerId: document.getElementById('pdfFarmer').value,
                        title: document.getElementById('pdfTitle').value,
                        description: document.getElementById('pdfDescription').value,
                        category: document.getElementById('pdfCategory').value,
                        fileName: file.name,
                        fileSize: this.formatFileSize(file.size),
                        hasData: true,
                        uploadedBy: this.currentUser.id,
                        uploadedAt: new Date().toISOString(),
                        downloaded: false,
                        // Store only metadata, not the actual file content
                        fileData: {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            lastModified: file.lastModified
                        }
                    };
                    
                    // For larger files, we don't store the actual content in localStorage
                    // Instead, we simulate it with a placeholder
                    if (file.size < 2 * 1024 * 1024) { // 2MB limit for localStorage
                        // Convert ArrayBuffer to Base64 for small files
                        const binary = new Uint8Array(arrayBuffer);
                        let binaryString = '';
                        for (let i = 0; i < binary.length; i++) {
                            binaryString += String.fromCharCode(binary[i]);
                        }
                        pdf.base64Data = btoa(binaryString);
                    }
                    
                    const systemPdfs = JSON.parse(localStorage.getItem('systemPdfs')) || [];
                    systemPdfs.push(pdf);
                    localStorage.setItem('systemPdfs', JSON.stringify(systemPdfs));
                    
                    const farmerPdfs = this.getFarmerData(pdf.farmerId, 'pdfs');
                    farmerPdfs.push(pdf);
                    this.saveFarmerData(pdf.farmerId, 'pdfs', farmerPdfs);
                    
                    this.hideModal('uploadPdfModal');
                    this.showNotification(`PDF "${file.name}" uploaded successfully!`, 'success');
                    
                    document.getElementById('uploadPdfForm').reset();
                    document.getElementById('pdfFileName').textContent = '';
                    
                } catch (error) {
                    console.error('PDF upload error:', error);
                    this.showNotification('Failed to upload PDF. File might be too large for browser storage.', 'error');
                }
            };
            
            reader.onerror = () => {
                this.showNotification('Error reading PDF file', 'error');
            };
            
            // Read as ArrayBuffer for better handling
            reader.readAsArrayBuffer(file);
        }

        formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        addInvoiceItem() {
            const container = document.getElementById('invoiceItems');
            const newItem = document.createElement('div');
            newItem.className = 'invoice-item';
            newItem.style.marginTop = '10px';
            newItem.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" class="form-control invoice-desc" placeholder="Description" required>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control invoice-qty" placeholder="Qty" required>
                    </div>
                    <div class="form-group">
                        <input type="number" class="form-control invoice-price" placeholder="Unit Price (KSH)" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            container.insertBefore(newItem, document.getElementById('addInvoiceItem'));
        }

        async handleCreateInvoice(e) {
            e.preventDefault();
            
            if (!this.currentUser || this.userType !== 'agronomist') {
                this.showNotification('Only agronomists can create invoices', 'error');
                return;
            }
            
            const items = [];
            document.querySelectorAll('.invoice-item').forEach(item => {
                const desc = item.querySelector('.invoice-desc')?.value;
                const qty = parseFloat(item.querySelector('.invoice-qty')?.value);
                const price = parseFloat(item.querySelector('.invoice-price')?.value);
                
                if (desc && qty && price) {
                    items.push({
                        description: desc,
                        quantity: qty,
                        price: price
                    });
                }
            });
            
            if (items.length === 0) {
                this.showNotification('Please add at least one invoice item', 'error');
                return;
            }
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span> Creating...';
            submitBtn.disabled = true;
            
            try {
                const farmerId = document.getElementById('invoiceFarmer').value;
                const invoice = {
                    id: 'INV-' + Date.now(),
                    farmerId: farmerId,
                    date: document.getElementById('invoiceDate').value,
                    dueDate: document.getElementById('invoiceDueDate').value,
                    items: items,
                    notes: document.getElementById('invoiceNotes').value,
                    createdBy: this.currentUser.id,
                    paid: false,
                    notified: false,
                    createdAt: new Date().toISOString()
                };
                
                if (farmerId === 'external') {
                    invoice.external = true;
                    invoice.externalName = prompt('Enter farmer name:') || 'Other Farmer';
                    invoice.externalEmail = prompt('Enter farmer email (optional):') || '';
                    invoice.externalPhone = prompt('Enter farmer phone (optional):') || '';
                    invoice.externalLocation = prompt('Enter farmer location (optional):') || '';
                    
                    const externalInvoices = JSON.parse(localStorage.getItem('externalInvoices')) || [];
                    externalInvoices.push(invoice);
                    localStorage.setItem('externalInvoices', JSON.stringify(externalInvoices));
                } else {
                    const farmerInvoices = this.getFarmerData(farmerId, 'invoices');
                    farmerInvoices.push(invoice);
                    this.saveFarmerData(farmerId, 'invoices', farmerInvoices);
                }
                
                this.hideModal('createInvoiceModal');
                this.updateInvoiceNotifications();
                this.previewInvoice(invoice.id, farmerId);
                this.showNotification('Invoice created successfully!', 'success');
                
            } catch (error) {
                console.error('Invoice creation error:', error);
                this.showNotification('Failed to create invoice', 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        deleteExpense(expenseId) {
            if (!this.currentUser || this.userType !== 'farmer') return;
            
            const expenses = this.getFarmerData(this.currentUser.id, 'expenses');
            const filteredExpenses = expenses.filter(e => e.id !== expenseId);
            this.saveFarmerData(this.currentUser.id, 'expenses', filteredExpenses);
            this.loadExpenses();
            this.showNotification('Expense deleted!', 'success');
        }

        deleteTask(taskId) {
            if (!this.currentUser || this.userType !== 'agronomist') return;
            
            const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            const filteredTasks = tasks.filter(t => t.id !== taskId);
            localStorage.setItem('tasks', JSON.stringify(filteredTasks));
            this.loadSales();
            this.showNotification('Consultation deleted!', 'success');
        }

        viewTaskDetails(taskId) {
            const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            let html = `
                <div class="invoice">
                    <div class="invoice-header">
                        <div>
                            <h2>Consultation Details</h2>
                            <p><strong>Date:</strong> ${new Date(task.date).toLocaleDateString()}</p>
                        </div>
                        <div style="text-align: right;">
                            <span class="badge badge-${task.status === 'paid' ? 'success' : task.status === 'completed' ? 'warning' : task.status === 'overdue' ? 'danger' : 'info'}">
                                ${task.status}
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>Farmer Information</h4>
                        ${task.farmerId === 'external' ? `
                            <p><strong>Name:</strong> ${task.externalFarmerName || 'Other Farmer'}</p>
                            <p><strong>Phone:</strong> ${task.externalFarmerPhone || 'Not provided'}</p>
                            <p><strong>Type:</strong> External Farmer</p>
                        ` : `
                            <p><strong>Farmer ID:</strong> ${task.farmerId}</p>
                            <p><strong>Type:</strong> Portal Farmer</p>
                        `}
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>Consultation Details</h4>
                        <p><strong>Description:</strong> ${task.description}</p>
                        <p><strong>Amount:</strong> KSH ${task.amount.toFixed(2)}</p>
                        ${task.deadline ? `<p><strong>Deadline:</strong> ${new Date(task.deadline).toLocaleDateString()}</p>` : ''}
                        <p><strong>Created:</strong> ${new Date(task.createdAt).toLocaleDateString()}</p>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Consultation Details</h3>
                        <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${html}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async downloadPdf(pdfId, farmerId) {
            const pdfs = this.getFarmerData(farmerId, 'pdfs');
            const pdf = pdfs.find(p => p.id === pdfId);
            
            if (!pdf) {
                this.showNotification('PDF not found', 'error');
                return;
            }
            
            pdf.downloaded = true;
            pdf.downloadedAt = new Date().toISOString();
            this.saveFarmerData(farmerId, 'pdfs', pdfs);
            
            try {
                if (pdf.base64Data) {
                    // For small files stored in localStorage
                    const binaryString = atob(pdf.base64Data);
                    const binary = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        binary[i] = binaryString.charCodeAt(i);
                    }
                    const blob = new Blob([binary], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = pdf.fileName || pdf.title.replace(/[^a-z0-9]/gi, '_') + '.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } else {
                    // For larger files, create a simulated PDF
                    const pdfContent = this.generatePdfContent(pdf);
                    const blob = new Blob([pdfContent], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = pdf.fileName || pdf.title.replace(/[^a-z0-9]/gi, '_') + '.pdf';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
                
                this.showNotification(`PDF "${pdf.title}" downloaded successfully!`, 'success');
                this.hideModal('viewPdfModal');
                
                setTimeout(() => {
                    if (this.userType === 'farmer') {
                        this.loadMyPdfs();
                    }
                }, 500);
                
            } catch (error) {
                console.error('PDF download error:', error);
                this.showNotification('Failed to download PDF', 'error');
            }
        }

        generatePdfContent(pdf) {
            const title = pdf.title || 'Document';
            const description = pdf.description || '';
            const date = new Date(pdf.uploadedAt).toLocaleDateString();
            
            return `%PDF-1.4
1 0 obj
<<
  /Type /Catalog
  /Pages 2 0 R
>>
endobj
2 0 obj
<<
  /Type /Pages
  /Kids [3 0 R]
  /Count 1
>>
endobj
3 0 obj
<<
  /Type /Page
  /Parent 2 0 R
  /MediaBox [0 0 612 792]
  /Contents 4 0 R
  /Resources <<
    /Font <<
      /F1 5 0 R
    >>
  >>
>>
endobj
4 0 obj
<<
  /Length 500
>>
stream
BT
/F1 24 Tf
72 720 Td
(${title}) Tj
ET
BT
/F1 12 Tf
72 680 Td
(Uploaded: ${date}) Tj
ET
BT
/F1 12 Tf
72 650 Td
(Description: ${description}) Tj
ET
BT
/F1 12 Tf
72 600 Td
(--- Content Begins ---) Tj
ET
BT
/F1 10 Tf
72 550 Td
(This PDF document contains the original content as uploaded.) Tj
ET
BT
/F1 10 Tf
72 530 Td
(File: ${pdf.fileName || 'document.pdf'}) Tj
ET
BT
/F1 10 Tf
72 510 Td
(Size: ${pdf.fileSize}) Tj
ET
BT
/F1 10 Tf
72 490 Td
(Category: ${pdf.category}) Tj
ET
BT
/F1 12 Tf
72 450 Td
(--- End of Document ---) Tj
ET
endstream
endobj
5 0 obj
<<
  /Type /Font
  /Subtype /Type1
  /BaseFont /Helvetica
>>
endobj
xref
0 6
0000000000 65535 f
0000000010 00000 n
0000000053 00000 n
0000000112 00000 n
0000000200 00000 n
0000001000 00000 n
trailer
<<
  /Size 6
  /Root 1 0 R
>>
startxref
1500
%%EOF`;
        }

        previewInvoice(invoiceId, farmerId) {
            let invoice, farmer;
            
            if (farmerId === 'external') {
                const externalInvoices = JSON.parse(localStorage.getItem('externalInvoices')) || [];
                invoice = externalInvoices.find(i => i.id === invoiceId);
                farmer = {
                    firstName: invoice?.externalName || 'Other',
                    lastName: 'Farmer',
                    email: invoice?.externalEmail || '',
                    phone: invoice?.externalPhone || '',
                    location: invoice?.externalLocation || ''
                };
            } else {
                const invoices = this.getFarmerData(farmerId, 'invoices');
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                invoice = invoices.find(i => i.id === invoiceId);
                farmer = farmers.find(f => f.id === farmerId);
            }
            
            if (!invoice) return;
            
            const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            
            if (farmerId !== 'external') {
                invoice.notified = true;
                this.saveFarmerData(farmerId, 'invoices', invoices);
            }
            this.updateInvoiceNotifications();
            
            let html = `
                <div class="invoice">
                    <div class="invoice-logo">
                        <img src="aaron logo.webp" alt="Aaron Agronomy Services" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNDUiIGZpbGw9IiMyRTdEMzIiLz4KICA8dGV4dCB4PSI1MCIgeT0iNTUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+QUFTPC90ZXh0Pgo8L3N2Zz4K'">
                    </div>
                    
                    <div class="invoice-header" style="text-align: center; margin-bottom: 30px;">
                        <h2>AARON AGRONOMY SERVICES</h2>
                        <p>P.O Box 55-90300, Makueni</p>
                        <p>Email: aaronmuthini0@gmail.com | Phone: 0700000000</p>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 30px;">
                        <h3 style="color: var(--secondary);">INVOICE</h3>
                    </div>
                    
                    <div class="invoice-details">
                        <div class="invoice-from" style="flex: 1;">
                            <h4>From:</h4>
                            <p><strong>Aaron Agronomy Services</strong></p>
                            <p>P.O Box 55-90300, Makueni</p>
                            <p>Email: aaronmuthini0@gmail.com</p>
                            <p>Phone: 0700000000</p>
                        </div>
                        
                        <div class="invoice-to" style="flex: 1;">
                            <h4>To:</h4>
                            <p><strong>${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Farmer'}</strong></p>
                            <p>${farmer?.email || ''}</p>
                            <p>${farmer?.phone || ''}</p>
                            <p>${farmer?.location || ''}</p>
                        </div>
                        
                        <div class="invoice-info" style="flex: 1;">
                            <p><strong>Invoice No:</strong> ${invoice.id}</p>
                            <p><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                            <p><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString()}</p>
                            <span class="badge ${invoice.paid ? 'badge-success' : 'badge-warning'}">
                                ${invoice.paid ? 'PAID' : 'PENDING'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="invoice-items" style="margin: 30px 0;">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price (KSH)</th>
                                    <th>Subtotal (KSH)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            invoice.items.forEach(item => {
                const subtotal = item.quantity * item.price;
                html += `
                    <tr>
                        <td>${item.description}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price.toFixed(2)}</td>
                        <td>${subtotal.toFixed(2)}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="invoice-total">
                        <h3>Total Amount: KSH ${total.toFixed(2)}</h3>
                        <p style="color: var(--gray); font-size: 0.9em;">All amounts in Kenyan Shillings</p>
                    </div>
                    
                    ${invoice.notes ? `
                        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                            <h4>Notes:</h4>
                            <p>${invoice.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div class="invoice-footer" style="margin-top: 40px;">
                        <p><strong>Thank you for your business!</strong></p>
                        <p>If you have any questions kindly contact aaronmuthini0@gmail.com</p>
                        <p style="margin-top: 10px; color: var(--gray); font-size: 0.9em;">
                            This is an electronic invoice. No physical copy will be sent.
                        </p>
                    </div>
                </div>
            `;
            
            document.getElementById('invoicePreviewContent').innerHTML = html;
            this.showModal('invoicePreviewModal');
            
            document.getElementById('downloadInvoiceBtn').onclick = () => this.downloadInvoicePDF(invoiceId, farmerId);
            document.getElementById('printInvoiceBtn').onclick = () => {
                window.print();
            };
        }

        downloadInvoicePDF(invoiceId, farmerId) {
            let invoice, farmer;
            
            if (farmerId === 'external') {
                const externalInvoices = JSON.parse(localStorage.getItem('externalInvoices')) || [];
                invoice = externalInvoices.find(i => i.id === invoiceId);
                farmer = {
                    firstName: invoice?.externalName || 'Other',
                    lastName: 'Farmer',
                    email: invoice?.externalEmail || '',
                    phone: invoice?.externalPhone || '',
                    location: invoice?.externalLocation || ''
                };
            } else {
                const invoices = this.getFarmerData(farmerId, 'invoices');
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                invoice = invoices.find(i => i.id === invoiceId);
                farmer = farmers.find(f => f.id === farmerId);
            }
            
            if (!invoice) return;
            
            const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            
            // Create a clean HTML for the invoice only
            const invoiceHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 40px;
                            color: #333;
                        }
                        .invoice-container {
                            max-width: 800px;
                            margin: 0 auto;
                            border: 1px solid #ddd;
                            padding: 30px;
                            background: white;
                        }
                        .invoice-header {
                            background: #4CAF50;
                            color: white;
                            padding: 20px;
                            text-align: center;
                            margin-bottom: 30px;
                            border-radius: 8px 8px 0 0;
                        }
                        .invoice-details {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 30px;
                            flex-wrap: wrap;
                        }
                        .invoice-from, .invoice-to {
                            flex: 1;
                            min-width: 200px;
                        }
                        .invoice-items {
                            margin: 30px 0;
                            width: 100%;
                            border-collapse: collapse;
                        }
                        .invoice-items th {
                            background: #f5f5f5;
                            padding: 12px;
                            text-align: left;
                            border-bottom: 2px solid #ddd;
                        }
                        .invoice-items td {
                            padding: 10px;
                            border-bottom: 1px solid #ddd;
                        }
                        .invoice-total {
                            text-align: right;
                            margin-top: 30px;
                            padding-top: 20px;
                            border-top: 2px solid #ddd;
                        }
                        .invoice-footer {
                            text-align: center;
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 1px solid #ddd;
                            font-style: italic;
                            color: #666;
                        }
                        .badge {
                            padding: 5px 10px;
                            border-radius: 20px;
                            font-size: 0.8rem;
                            font-weight: bold;
                        }
                        .badge-success {
                            background: #4CAF50;
                            color: white;
                        }
                        .badge-warning {
                            background: #FF9800;
                            color: white;
                        }
                        @media print {
                            body { margin: 0; }
                            .invoice-header {
                                background: #4CAF50 !important;
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="invoice-container">
                        <div class="invoice-header">
                            <h2>AARON AGRONOMY SERVICES</h2>
                            <p>P.O Box 55-90300, Makueni | Email: aaronmuthini0@gmail.com | Phone: 0700000000</p>
                            <h3>INVOICE</h3>
                        </div>
                        
                        <div class="invoice-details">
                            <div class="invoice-from">
                                <h4>From:</h4>
                                <p><strong>Aaron Agronomy Services</strong></p>
                                <p>P.O Box 55-90300, Makueni</p>
                                <p>Email: aaronmuthini0@gmail.com</p>
                                <p>Phone: 0700000000</p>
                            </div>
                            
                            <div class="invoice-to">
                                <h4>To:</h4>
                                <p><strong>${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Farmer'}</strong></p>
                                <p>${farmer?.email || ''}</p>
                                <p>${farmer?.phone || ''}</p>
                                <p>${farmer?.location || ''}</p>
                            </div>
                            
                            <div class="invoice-info">
                                <p><strong>Invoice No:</strong> ${invoice.id}</p>
                                <p><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                                <p><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString()}</p>
                                <span class="badge ${invoice.paid ? 'badge-success' : 'badge-warning'}">
                                    ${invoice.paid ? 'PAID' : 'PENDING'}
                                </span>
                            </div>
                        </div>
                        
                        <table class="invoice-items">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit Price (KSH)</th>
                                    <th>Subtotal (KSH)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>${item.price.toFixed(2)}</td>
                                        <td>${(item.quantity * item.price).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        
                        <div class="invoice-total">
                            <h3>Total Amount: KSH ${total.toFixed(2)}</h3>
                            <p style="color: #666; font-size: 0.9em;">All amounts in Kenyan Shillings</p>
                        </div>
                        
                        ${invoice.notes ? `
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                <h4>Notes:</h4>
                                <p>${invoice.notes}</p>
                            </div>
                        ` : ''}
                        
                        <div class="invoice-footer">
                            <p><strong>Thank you for your business!</strong></p>
                            <p>If you have any questions kindly contact aaronmuthini0@gmail.com</p>
                            <p style="margin-top: 10px; color: #666; font-size: 0.9em;">
                                This is an electronic invoice. No physical copy will be sent.
                            </p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Create a blob and download
            const blob = new Blob([invoiceHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `invoice_${invoiceId}.html`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.showNotification('Invoice downloaded as HTML!', 'success');
        }

          viewReport(reportId, farmerId) {
            let reports;
            if (this.userType === 'agronomist') {
                reports = JSON.parse(localStorage.getItem('systemReports')) || [];
            } else {
                reports = this.getFarmerData(farmerId, 'reports');
            }
            
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const report = reports.find(r => r.id === reportId);
            const farmer = farmers.find(f => f.id === farmerId);
            
            if (!report) return;
            
            let html = `
                <div class="invoice">
                    <div class="invoice-header">
                        <div>
                            <h2>${report.title}</h2>
                            <p><strong>Farmer:</strong> ${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</p>
                        </div>
                        <div style="text-align: right;">
                            <p><strong>Date:</strong> ${new Date(report.date).toLocaleDateString()}</p>
                            <p><strong>Type:</strong> ${report.type.replace('_', ' ')}</p>
                            <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                ${report.status}
                            </span>
                        </div>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <h4>Findings</h4>
                        <p style="white-space: pre-wrap;">${report.findings}</p>
                    </div>
                    
                    <div style="margin: 30px 0;">
                        <h4>Recommendations</h4>
                        <p style="white-space: pre-wrap;">${report.recommendations}</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="system.downloadReport('${report.id}', '${farmerId}')">
                            <i class="fas fa-download"></i> Download Report
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = html;
            this.showModal('viewReportModal');
        }

        renderExpensesChart(expenses) {
            const ctx = document.getElementById('expensesChart')?.getContext('2d');
            if (!ctx) return;
            
            const categoryData = {};
            expenses.forEach(expense => {
                categoryData[expense.category] = (categoryData[expense.category] || 0) + expense.amount;
            });
            
            const labels = Object.keys(categoryData);
            const data = labels.map(label => categoryData[label]);
            
            const backgroundColors = labels.map((_, index) => {
                const hue = (index * 137) % 360;
                return `hsla(${hue}, 70%, 60%, 0.7)`;
            });
            
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: KSH ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        renderConsultationChart(tasks) {
            const ctx = document.getElementById('consultationChart')?.getContext('2d');
            if (!ctx) return;
            
            const monthlyData = {};
            
            tasks.forEach(task => {
                const monthYear = task.date.slice(0, 7);
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { 
                        paid: 0, 
                        pending: 0, 
                        completed: 0,
                        overdue: 0
                    };
                }
                
                if (task.status === 'paid') {
                    monthlyData[monthYear].paid += task.amount;
                } else if (task.status === 'pending') {
                    monthlyData[monthYear].pending += task.amount;
                } else if (task.status === 'overdue') {
                    monthlyData[monthYear].overdue += task.amount;
                } else {
                    monthlyData[monthYear].completed += task.amount;
                }
            });
            
            const labels = Object.keys(monthlyData).sort();
            const paidData = labels.map(label => monthlyData[label].paid);
            const pendingData = labels.map(label => monthlyData[label].pending);
            const completedData = labels.map(label => monthlyData[label].completed);
            const overdueData = labels.map(label => monthlyData[label].overdue);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(label => {
                        const [year, month] = label.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [
                        {
                            label: 'Paid (KSH)',
                            data: paidData,
                            backgroundColor: '#4CAF50',
                            borderColor: '#4CAF50',
                            borderWidth: 1
                        },
                        {
                            label: 'Pending (KSH)',
                            data: pendingData,
                            backgroundColor: '#FF9800',
                            borderColor: '#FF9800',
                            borderWidth: 1
                        },
                        {
                            label: 'Completed (KSH)',
                            data: completedData,
                            backgroundColor: '#2196F3',
                            borderColor: '#2196F3',
                            borderWidth: 1
                        },
                        {
                            label: 'Overdue (KSH)',
                            data: overdueData,
                            backgroundColor: '#D32F2F',
                            borderColor: '#D32F2F',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: false,
                            ticks: {
                                callback: function(value) {
                                    return 'KSH ' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            stacked: false
                        }
                    }
                }
            });
        }

        renderAgroChart(tasks) {
            const ctx = document.getElementById('agroChart')?.getContext('2d');
            if (!ctx) return;
            
            const monthlyData = {};
            
            tasks.forEach(task => {
                const monthYear = task.date.slice(0, 7);
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { 
                        sales: 0, 
                        count: 0 
                    };
                }
                monthlyData[monthYear].sales += task.amount;
                monthlyData[monthYear].count += 1;
            });
            
            const labels = Object.keys(monthlyData).sort();
            const salesData = labels.map(label => monthlyData[label].sales);
            const countData = labels.map(label => monthlyData[label].count);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(label => {
                        const [year, month] = label.split('-');
                        return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                    }),
                    datasets: [
                        {
                            label: 'Consultation Fees (KSH)',
                            data: salesData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Number of Consultations',
                            data: countData,
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            tension: 0.4,
                            fill: true,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Fees (KSH)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return 'KSH ' + value.toLocaleString();
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Number of Consultations'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        updateInvoiceNotifications() {
            if (this.userType !== 'farmer') return;
            
            const invoices = this.getFarmerData(this.currentUser.id, 'invoices');
            const notificationBadge = document.getElementById('invoiceNotification');
            
            const newInvoices = invoices.filter(inv => !inv.notified);
            
            if (newInvoices.length > 0) {
                notificationBadge.textContent = newInvoices.length;
                notificationBadge.style.display = 'flex';
                notificationBadge.classList.add('invoice-notification');
                
                const navInvoices = document.getElementById('navInvoices');
                navInvoices.classList.add('has-notification');
            } else {
                notificationBadge.style.display = 'none';
                notificationBadge.classList.remove('invoice-notification');
                const navInvoices = document.getElementById('navInvoices');
                navInvoices.classList.remove('has-notification');
            }
        }

        downloadExpensesExcel() {
            if (this.userType !== 'farmer') return;
            
            const expenses = this.getFarmerData(this.currentUser.id, 'expenses');
            let csv = 'Date,Category,Description,Amount (KSH)\n';
            
            expenses.forEach(expense => {
                csv += `${expense.date},${expense.category},"${expense.description}",${expense.amount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            this.showNotification('Expenses exported successfully!', 'success');
        }

        showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('navLinks').classList.remove('active');
                document.getElementById('navOverlay').classList.remove('active');
            }
        }

        hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; 
                     background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'}; 
                     color: white; padding: 15px 20px; border-radius: 5px; 
                     box-shadow: 0 5px 15px rgba(0,0,0,0.2); min-width: 250px; max-width: 300px;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        saveToLocalStorage() {
            localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
            localStorage.setItem('userType', this.userType);
        }

        renderFarmersTable(farmers, showOnlyNames = false) {
            if (farmers.length === 0) {
                return '<p>No farmers registered yet.</p>';
            }
            
            if (showOnlyNames) {
                let html = '<div style="max-height: 200px; overflow-y: auto;">';
                farmers.forEach(farmer => {
                    html += `
                        <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                            <strong>${farmer.firstName} ${farmer.lastName}</strong>
                            <span style="color: #666; font-size: 0.9em; margin-left: 10px;">${farmer.location}</span>
                        </div>
                    `;
                });
                html += '</div>';
                return html;
            }
            
            let html = '<div class="table-responsive"><table class="table"><thead><tr>';
            html += '<th>Name</th><th>Email</th><th>Phone</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            
            farmers.forEach(farmer => {
                html += `
                    <tr>
                        <td><strong>${farmer.firstName} ${farmer.lastName}</strong></td>
                        <td>${farmer.email}</td>
                        <td>${farmer.phone || 'N/A'}</td>
                        <td>${farmer.location}</td>
                        <td>
                            <span class="badge badge-${farmer.status === 'active' ? 'success' : farmer.status === 'pending' ? 'warning' : 'danger'}">
                                ${farmer.status || 'active'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="system.viewFarmerDetails('${farmer.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            return html;
        }

        toggleFarmersView() {
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const myFarmers = farmers.filter(f => f.agronomistId === this.currentUser.id);
            const container = document.getElementById('farmersTableContainer');
            const button = event.target;
            
            if (!container || !button) return;
            
            const isShowingAll = button.innerHTML.includes('View Less');
            
            if (isShowingAll) {
                container.innerHTML = this.renderFarmersTable(myFarmers.slice(0, 3), true);
                button.innerHTML = '<i class="fas fa-eye"></i> View More';
                button.classList.remove('btn-warning');
                button.classList.add('btn-info');
            } else {
                container.innerHTML = this.renderFarmersTable(myFarmers, false);
                button.innerHTML = '<i class="fas fa-eye-slash"></i> View Less';
                button.classList.remove('btn-info');
                button.classList.add('btn-warning');
            }
        }

        getTopLocations(farms) {
            const locationCount = {};
            farms.forEach(farm => {
                locationCount[farm.location] = (locationCount[farm.location] || 0) + 1;
            });
            
            const sortedLocations = Object.entries(locationCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            return sortedLocations.map(([location, count]) => `
                <div style="margin-bottom: 10px;">
                    <span>${location}</span>
                    <span style="float: right; color: var(--primary);">${count} farms</span>
                </div>
            `).join('');
        }

        loadMyPdfs() {
            if (this.userType !== 'farmer') return;
            
            const pdfs = this.getFarmerData(this.currentUser.id, 'pdfs');
            
            let html = `
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-file-pdf"></i> My PDF Documents</h3>
                        <div class="card-actions">
                            <span class="badge badge-info">${pdfs.length} PDFs</span>
                        </div>
                    </div>
                    
                    <div class="pdf-list">
            `;
            
            if (pdfs.length === 0) {
                html += `
                    <div class="pdf-upload-container" style="background: white; text-align: center; padding: 40px 20px;">
                        <i class="fas fa-file-pdf pdf-icon" style="font-size: 4rem; color: var(--danger); margin-bottom: 20px;"></i>
                        <h4>No PDFs Available</h4>
                        <p>Your agronomist hasn't uploaded any PDFs for you yet.</p>
                        <p style="color: var(--gray); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> PDFs will appear here when uploaded
                        </p>
                    </div>
                `;
            } else {
                const sortedPdfs = pdfs.sort((a, b) => 
                    new Date(b.uploadedAt) - new Date(a.uploadedAt)
                );
                
                sortedPdfs.forEach(pdf => {
                    const uploadedDate = new Date(pdf.uploadedAt).toLocaleDateString();
                    const isDownloaded = pdf.downloaded ? ' ' : '';
                    
                    html += `
                        <div class="pdf-item">
                            <div class="pdf-info">
                                <i class="fas fa-file-pdf pdf-icon" style="color: ${pdf.downloaded ? 'var(--success)' : 'var(--danger)'};"></i>
                                <div>
                                    <strong>${pdf.title}</strong><br>
                                    <small>${pdf.description || 'No description'}</small><br>
                                    <small style="color: var(--gray);">
                                        ${pdf.fileSize}  Uploaded: ${uploadedDate}  ${isDownloaded}${pdf.downloaded ? 'Downloaded' : 'Not downloaded'}
                                    </small>
                                </div>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-info" onclick="system.previewPdf('${pdf.id}', '${this.currentUser.id}')">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <button class="btn btn-sm btn-success" onclick="system.downloadPdf('${pdf.id}', '${this.currentUser.id}')">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += `
                    </div>
                    <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <p><strong>Total PDFs:</strong> ${pdfs.length}</p>
                        <p><small style="color: var(--gray);">PDFs are stored securely and can be downloaded anytime</small></p>
                    </div>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = html;
            document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
            this.showNotification(`Loaded ${pdfs.length} PDF document(s)`, 'info');
        }

        previewPdf(pdfId, farmerId) {
            const pdfs = this.getFarmerData(farmerId, 'pdfs');
            const pdf = pdfs.find(p => p.id === pdfId);
            
            if (!pdf) {
                this.showNotification('PDF not found', 'error');
                return;
            }
            
            const uploadedDate = new Date(pdf.uploadedAt).toLocaleDateString();
            const downloadedDate = pdf.downloaded ? new Date(pdf.downloadedAt).toLocaleDateString() : 'Not downloaded yet';
            
            let html = `
                <div class="invoice">
                    <div class="invoice-header">
                        <div>
                            <h2><i class="fas fa-file-pdf pdf-icon"></i> ${pdf.title}</h2>
                            <p><strong>Description:</strong> ${pdf.description || 'No description provided'}</p>
                        </div>
                        <div style="text-align: right;">
                            <p><strong>Category:</strong> ${pdf.category.replace('_', ' ')}</p>
                            <p><strong>Uploaded:</strong> ${uploadedDate}</p>
                        </div>
                    </div>
                    
                    <div class="pdf-upload-container" style="background: white; margin: 30px 0; text-align: center;">
                        <i class="fas fa-file-pdf pdf-icon" style="font-size: 5rem; color: var(--danger); margin: 20px 0;"></i>
                        <h3>${pdf.fileName}</h3>
                        <div style="display: flex; justify-content: center; gap: 20px; margin: 15px 0;">
                            <span class="badge badge-info">${pdf.fileSize}</span>
                            <span class="badge ${pdf.downloaded ? 'badge-success' : 'badge-warning'}">
                                ${pdf.downloaded ? ' Downloaded' : 'Not Downloaded'}
                            </span>
                        </div>
                        <p style="color: var(--gray); margin-top: 10px;">
                            <i class="fas fa-info-circle"></i> ${pdf.downloaded ? 
                                `Downloaded on ${downloadedDate}` : 
                                'Click Download to save this PDF to your device'}
                        </p>
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4>PDF Information</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                            <div><strong>File Name:</strong><br>${pdf.fileName}</div>
                            <div><strong>File Size:</strong><br>${pdf.fileSize}</div>
                            <div><strong>Upload Date:</strong><br>${uploadedDate}</div>
                            <div><strong>Status:</strong><br>${pdf.downloaded ? 'Downloaded' : 'Available'}</div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="system.downloadPdf('${pdf.id}', '${farmerId}')">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                        <button class="btn btn-secondary" onclick="window.print()">
                            <i class="fas fa-print"></i> Print Document
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('pdfViewerContent').innerHTML = html;
            this.showModal('viewPdfModal');
        }

        viewFarmDetails(farmId, farmerId) {
            const farms = this.getFarmerData(farmerId, 'farms');
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const reports = this.getFarmerData(farmerId, 'reports');
            
            const farm = farms.find(f => f.id === farmId);
            const farmer = farmers.find(f => f.id === farmerId);
            const farmReports = reports.filter(r => r.farmId === farmId);
            
            let html = `
                <div class="invoice">
                    <div class="invoice-header">
                        <div>
                            <h2>${farm.name}</h2>
                            <p><strong>Farmer:</strong> ${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</p>
                        </div>
                        <div style="text-align: right;">
                            <span class="badge badge-success">${farm.size} acres</span>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>Farm Details</h4>
                        <p><strong>Location:</strong> ${farm.location}</p>
                        <p><strong>Soil Type:</strong> ${farm.soilType}</p>
                        <p><strong>Created:</strong> ${new Date(farm.createdAt).toLocaleDateString()}</p>
                    </div>
                    
                    ${farm.crops && farm.crops.length > 0 ? `
                        <div style="margin: 20px 0;">
                            <h4>Main Crops</h4>
                            <table class="table" style="margin-top: 10px;">
                                <thead>
                                    <tr>
                                        <th>Crop</th>
                                        <th>Acreage</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${farm.crops.map(crop => `
                                        <tr>
                                            <td>${crop.name}</td>
                                            <td>${crop.acreage} acres</td>
                                            <td><span class="badge badge-info">${crop.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                    
                    <div style="margin: 20px 0;">
                        <h4>Farmer Contact</h4>
                        <p><strong>Email:</strong> ${farmer?.email || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${farmer?.phone || 'N/A'}</p>
                        <p><strong>Location:</strong> ${farmer?.location || 'N/A'}</p>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>Farm Reports</h4>
                        ${farmReports.length > 0 ? 
                            farmReports.map(report => `
                                <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                    <strong>${report.title}</strong><br>
                                    <small>${report.type.replace('_', ' ')} - ${new Date(report.date).toLocaleDateString()}</small>
                                    <button class="btn btn-sm btn-info" onclick="system.viewReport('${report.id}', '${farmerId}')" style="float: right;">
                                        <i class="fas fa-eye"></i> View
                                    </button>
                                </div>
                            `).join('') : 
                            '<p>No reports for this farm yet.</p>'
                        }
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Farm Details</h3>
                        <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${html}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        viewFarmerDetails(farmerId) {
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const farmer = farmers.find(f => f.id === farmerId);
            if (!farmer) return;
            
            const farms = this.getFarmerData(farmerId, 'farms');
            const reports = this.getFarmerData(farmerId, 'reports');
            
            const totalAcres = farms.reduce((sum, farm) => sum + farm.size, 0);
            const totalCrops = farms.reduce((sum, farm) => sum + (farm.crops ? farm.crops.length : 0), 0);
            
            let html = `
                <div class="invoice">
                    <div class="invoice-header">
                        <div>
                            <h2>${farmer.firstName} ${farmer.lastName}</h2>
                            <p><strong>Farmer ID:</strong> ${farmer.id}</p>
                        </div>
                        <div style="text-align: right;">
                            <span class="badge badge-${farmer.status === 'active' ? 'success' : farmer.status === 'pending' ? 'warning' : 'danger'}">
                                ${farmer.status || 'active'}
                            </span>
                            </div>
                    
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>Contact Information</h4>
                        <p><strong>Email:</strong> ${farmer.email}</p>
                        <p><strong>Phone:</strong> ${farmer.phone || 'N/A'}</p>
                        <p><strong>Location:</strong> ${farmer.location}</p>
                        <p><strong>Registered:</strong> ${new Date(farmer.createdAt).toLocaleDateString()}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h5 style="color: var(--info); margin-bottom: 5px;">${farms.length}</h5>
                            <small>Active Farms</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h5 style="color: var(--success); margin-bottom: 5px;">${totalAcres}</h5>
                            <small>Total Acres</small>
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                            <h5 style="color: var(--primary); margin-bottom: 5px;">${totalCrops}</h5>
                            <small>Total Crops</small>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <h4>Farms</h4>
                        ${farms.length > 0 ? 
                            farms.map(farm => `
                                <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                    <strong>${farm.name}</strong> - ${farm.size} acres<br>
                                    <small>${farm.location} | ${farm.soilType} soil</small>
                                    ${farm.crops && farm.crops.length > 0 ? 
                                        `<br><small><strong>Crops:</strong> ${farm.crops.map(c => c.name).join(', ')}</small>` : 
                                        ''
                                    }
                                </div>
                            `).join('') : 
                            '<p>No farms registered yet.</p>'
                        }
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Farmer Details</h3>
                        <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${html}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        editReportStatus(reportId) {
            const systemReports = JSON.parse(localStorage.getItem('systemReports')) || [];
            const report = systemReports.find(r => r.id === reportId);
            
            if (!report) return;
            
            const newStatus = prompt('Update report status (pending/approved/requires_action):', report.status || 'pending');
            
            if (newStatus && ['pending', 'approved', 'requires_action'].includes(newStatus.toLowerCase())) {
                report.status = newStatus.toLowerCase();
                localStorage.setItem('systemReports', JSON.stringify(systemReports));
                
                const farmerReports = this.getFarmerData(report.farmerId, 'reports');
                const farmerReport = farmerReports.find(r => r.id === reportId);
                if (farmerReport) {
                    farmerReport.status = newStatus.toLowerCase();
                    this.saveFarmerData(report.farmerId, 'reports', farmerReports);
                }
                
                this.loadReports();
                this.showNotification('Report status updated!', 'success');
            }
        }

        editInvoice(invoiceId, farmerId) {
            let invoice;
            
            if (farmerId === 'external') {
                const externalInvoices = JSON.parse(localStorage.getItem('externalInvoices')) || [];
                invoice = externalInvoices.find(i => i.id === invoiceId);
            } else {
                const invoices = this.getFarmerData(farmerId, 'invoices');
                invoice = invoices.find(i => i.id === invoiceId);
            }
            
            if (!invoice) return;
            
            const paid = confirm('Mark this invoice as paid?');
            
            if (paid !== null) {
                invoice.paid = paid;
                
                if (farmerId === 'external') {
                    const externalInvoices = JSON.parse(localStorage.getItem('externalInvoices')) || [];
                    localStorage.setItem('externalInvoices', JSON.stringify(externalInvoices));
                } else {
                    this.saveFarmerData(farmerId, 'invoices', invoices);
                }
                
                this.updateInvoiceNotifications();
                this.loadInvoices();
                this.showNotification('Invoice updated!', 'success');
            }
        }

        downloadAllInvoices() {
            if (this.userType !== 'agronomist') return;
            
            const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
            const externalInvoices = JSON.parse(localStorage.getItem('externalInvoices')) || [];
            let csv = 'Invoice ID,Farmer,Date,Due Date,Amount,Status,Items\n';
            
            farmers.forEach(farmer => {
                const invoices = this.getFarmerData(farmer.id, 'invoices');
                invoices.forEach(invoice => {
                    const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    const itemsStr = invoice.items.map(item => `${item.description} (${item.quantity} x KSH ${item.price})`).join('; ');
                    csv += `${invoice.id},"${farmer.firstName} ${farmer.lastName}",${invoice.date},${invoice.dueDate},${total},${invoice.paid ? 'Paid' : 'Pending'},"${itemsStr}"\n`;
                });
            });
            
            externalInvoices.forEach(invoice => {
                const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                const itemsStr = invoice.items.map(item => `${item.description} (${item.quantity} x KSH ${item.price})`).join('; ');
                csv += `${invoice.id},"${invoice.externalName || 'Other Farmer'}",${invoice.date},${invoice.dueDate},${total},${invoice.paid ? 'Paid' : 'Pending'},"${itemsStr}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoices_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            this.showNotification('Invoices exported successfully!', 'success');
        }

        downloadAllReports() {
            let reports;
            if (this.userType === 'farmer') {
                reports = this.getFarmerData(this.currentUser.id, 'reports');
            } else {
                reports = JSON.parse(localStorage.getItem('systemReports')) || [];
            }
            
            let csv = 'Report ID,Title,Type,Date,Status,Findings,Recommendations\n';
            
            reports.forEach(report => {
                csv += `${report.id},"${report.title}",${report.type},${report.date},${report.status},"${report.findings.replace(/"/g, '""')}","${report.recommendations.replace(/"/g, '""')}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reports_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            this.showNotification('Reports exported successfully!', 'success');
        }

        downloadReport(reportId, farmerId) {
            let reports;
            if (this.userType === 'agronomist') {
                reports = JSON.parse(localStorage.getItem('systemReports')) || [];
            } else {
                reports = this.getFarmerData(farmerId, 'reports');
            }
            
            const report = reports.find(r => r.id === reportId);
            
            if (!report) return;
            
            const content = `
                Report: ${report.title}
                Type: ${report.type}
                Date: ${report.date}
                Status: ${report.status}
                
                FINDINGS:
                ${report.findings}
                
                RECOMMENDATIONS:
                ${report.recommendations}
            `;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `report_${reportId}.txt`;
            a.click();
            
            this.showNotification('Report downloaded!', 'success');
        }
    }

    // Initialize the system
    const system = new AgronomySystem();
    window.system = system;

    // Set default dates on load
    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date().toISOString().split('T')[0];
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        const nextWeekStr = nextWeek.toISOString().split('T')[0];
        
        ['expenseDate', 'taskDate', 'reportDate', 'saleDate', 'taskDeadline', 'saleDeadline'].forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                if (id.includes('Deadline')) {
                    input.value = nextWeekStr;
                } else {
                    input.value = today;
                }
            }
        });
        
        setTimeout(() => {
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    if (input.id.includes('Deadline')) {
                        input.value = nextWeekStr;
                    } else {
                        input.value = today;
                    }
                }
            });
        }, 100);
    });

    // Close modals when clicking outside
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });

    // Handle window resize for responsive design
    window.addEventListener('resize', () => {
        const navLinks = document.getElementById('navLinks');
        if (window.innerWidth > 768 && navLinks.classList.contains('active')) {
            navLinks.classList.remove('active');
            document.getElementById('navOverlay').classList.remove('active');
        }
    });
</script>
</body>
</html>
