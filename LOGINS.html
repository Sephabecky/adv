<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaron Agronomy System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2E7D32;
            --primary-light: #4CAF50;
            --primary-dark: #1B5E20;
            --secondary: #FF9800;
            --light: #F5F5F5;
            --dark: #333333;
            --gray: #757575;
            --light-gray: #EEEEEE;
            --danger: #D32F2F;
            --success: #388E3C;
            --warning: #F57C00;
            --info: #1976D2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header and Navigation */
        .main-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: white;
        }

        .logo-img {
            height: 50px;
            width: 50px;
            background-color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
        }

        .logo-img img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            margin-bottom: 2px;
        }

        .logo-text p {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .nav-links .active {
            background-color: rgba(255,255,255,0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: white;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Content */
        .main-content {
            padding: 30px 0;
            min-height: calc(100vh - 80px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            padding: 25px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .card-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            text-decoration: none;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th {
            background-color: rgba(46, 125, 50, 0.05);
            color: var(--primary);
            font-weight: 600;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .table tr:hover {
            background-color: rgba(46, 125, 50, 0.02);
        }

        /* Status Badges */
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background-color: rgba(56, 142, 60, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--danger);
        }

        .badge-info {
            background-color: rgba(25, 118, 210, 0.1);
            color: var(--info);
        }

        /* Login Page */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            padding: 40px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .login-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: var(--light-gray);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .login-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-body {
            padding: 30px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        /* Invoice */
        .invoice {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .invoice-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .invoice-items {
            margin: 30px 0;
        }

        .invoice-total {
            text-align: right;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--light-gray);
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .login-card {
                padding: 25px;
                margin: 20px;
            }
            
            .modal-content {
                width: 95%;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .card-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="container header-container">
            <header>
        <div class="container header-container">
            <a href="index.html" class="logo">
                <div class="logo-img">
                    <img src="aaron logo.webp" alt="Aaron Agronomy Services Logo" onerror="this.style.display='none'">
        
                </div>  
            </a>
        </header>
  
            <nav class="nav-links">
                <a href="#" id="navDashboard" class="active"><i class="fas fa-home"></i> Dashboard</a>
                <a href="#" id="navReports"><i class="fas fa-file-alt"></i> Reports</a>
                <a href="#" id="navSales"><i class="fas fa-chart-line"></i> Sales</a>
                <a href="#" id="navFarms"><i class="fas fa-tractor"></i> Farms</a>
                <a href="#" id="navInvoices"><i class="fas fa-receipt"></i> Invoices</a>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName">User</div>
                        <small id="userRole">Role</small>
                    </div>
                    <button class="btn btn-sm btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content container" id="mainContent">
        <!-- Dashboard will be loaded here -->
    </main>

    <!-- Login Modal -->
    <div class="modal" id="loginModal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="login-header">
                    <h2>Aaron Agronomy System</h2>
                    <p>Select your login type</p>
                </div>
                
                <div class="login-tabs">
                    <div class="login-tab active" data-type="farmer">Farmer</div>
                    <div class="login-tab" data-type="agronomist">Agronomist</div>
                </div>
                
                <!-- Farmer Login -->
                <form id="farmerLoginForm">
                    <div class="form-group">
                        <label for="farmerEmail">Email Address</label>
                        <input type="email" id="farmerEmail" class="form-control" placeholder="farmer@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="farmerPassword">Password</label>
                        <input type="password" id="farmerPassword" class="form-control" placeholder="Enter password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Login as Farmer
                    </button>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" id="showFarmerSignup" style="color: var(--primary);">Don't have account? Sign up</a>
                    </div>
                </form>
                
                <!-- Farmer Signup -->
                <form id="farmerSignupForm" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="signupFirstName">First Name</label>
                            <input type="text" id="signupFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="signupLastName">Last Name</label>
                            <input type="text" id="signupLastName" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPhone">Phone Number</label>
                        <input type="tel" id="signupPhone" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupLocation">Location</label>
                        <input type="text" id="signupLocation" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="signupPassword">Password</label>
                            <input type="password" id="signupPassword" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="signupConfirmPassword">Confirm Password</label>
                            <input type="password" id="signupConfirmPassword" class="form-control" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-user-plus"></i> Create Farmer Account
                    </button>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" id="showFarmerLogin" style="color: var(--primary);">Already have account? Login</a>
                    </div>
                </form>
                
                <!-- Agronomist Login -->
                <form id="agronomistLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="agroUsername">Username</label>
                        <input type="text" id="agroUsername" class="form-control" value="aaron_agronomy" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="agroPassword">Password</label>
                        <input type="password" id="agroPassword" class="form-control" value="9898" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-user-md"></i> Login as Agronomist
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Daily Sale Modal -->
    <div class="modal" id="addSaleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Daily Sales Record</h3>
                <button class="close-modal" data-modal="addSaleModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addSaleForm">
                    <div class="form-group">
                        <label for="saleDate">Date</label>
                        <input type="date" id="saleDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleCrop">Crop Type</label>
                        <select id="saleCrop" class="form-control" required>
                            <option value="">Select Crop</option>
                            <option value="maize">Maize</option>
                            <option value="wheat">Wheat</option>
                            <option value="coffee">Coffee</option>
                            <option value="tea">Tea</option>
                            <option value="beans">Beans</option>
                            <option value="vegetables">Vegetables</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="saleQuantity">Quantity (kg)</label>
                            <input type="number" id="saleQuantity" class="form-control" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="salePrice">Price per Kg ($)</label>
                            <input type="number" id="salePrice" class="form-control" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleTotal">Total Sales ($)</label>
                        <input type="number" id="saleTotal" class="form-control" step="0.01" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleExpenses">Expenses ($)</label>
                        <input type="number" id="saleExpenses" class="form-control" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleProfit">Profit ($)</label>
                        <input type="number" id="saleProfit" class="form-control" step="0.01" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleNotes">Notes</label>
                        <textarea id="saleNotes" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Daily Record
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Farm Modal -->
    <div class="modal" id="addFarmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Farm</h3>
                <button class="close-modal" data-modal="addFarmModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addFarmForm">
                    <div class="form-group">
                        <label for="farmName">Farm Name</label>
                        <input type="text" id="farmName" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="farmSize">Size (acres)</label>
                            <input type="number" id="farmSize" class="form-control" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="farmLocation">Location</label>
                            <input type="text" id="farmLocation" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="farmCrops">Main Crops</label>
                        <input type="text" id="farmCrops" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="farmSoil">Soil Type</label>
                        <select id="farmSoil" class="form-control" required>
                            <option value="">Select Soil Type</option>
                            <option value="loamy">Loamy</option>
                            <option value="clay">Clay</option>
                            <option value="sandy">Sandy</option>
                            <option value="silt">Silt</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Farm
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Report Modal (Agronomist) -->
    <div class="modal" id="createReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Farmer Report</h3>
                <button class="close-modal" data-modal="createReportModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createReportForm">
                    <div class="form-group">
                        <label for="reportFarmer">Select Farmer</label>
                        <select id="reportFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportTitle">Report Title</label>
                        <input type="text" id="reportTitle" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportType">Report Type</label>
                        <select id="reportType" class="form-control" required>
                            <option value="soil_analysis">Soil Analysis</option>
                            <option value="crop_health">Crop Health</option>
                            <option value="pest_control">Pest Control</option>
                            <option value="fertilizer">Fertilizer Recommendation</option>
                            <option value="general">General Advisory</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportDate">Report Date</label>
                        <input type="date" id="reportDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportFindings">Findings</label>
                        <textarea id="reportFindings" class="form-control" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportRecommendations">Recommendations</label>
                        <textarea id="reportRecommendations" class="form-control" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportStatus">Status</label>
                        <select id="reportStatus" class="form-control" required>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="requires_action">Requires Action</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-file-export"></i> Generate Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Invoice Modal -->
    <div class="modal" id="createInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Invoice</h3>
                <button class="close-modal" data-modal="createInvoiceModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createInvoiceForm">
                    <div class="form-group">
                        <label for="invoiceFarmer">Select Farmer</label>
                        <select id="invoiceFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceDate">Invoice Date</label>
                        <input type="date" id="invoiceDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceDueDate">Due Date</label>
                        <input type="date" id="invoiceDueDate" class="form-control" required>
                    </div>
                    
                    <div class="invoice-items" id="invoiceItems">
                        <h4>Invoice Items</h4>
                        <div class="invoice-item">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" class="form-control invoice-desc" required>
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-control invoice-qty" required>
                                </div>
                                <div class="form-group">
                                    <label>Price ($)</label>
                                    <input type="number" class="form-control invoice-price" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" id="addInvoiceItem">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceNotes">Notes</label>
                        <textarea id="invoiceNotes" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-file-invoice-dollar"></i> Create Invoice
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- View Report Modal -->
    <div class="modal" id="viewReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Farm Report</h3>
                <button class="close-modal" data-modal="viewReportModal">&times;</button>
            </div>
            <div class="modal-body" id="reportContent">
                <!-- Report content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div class="modal" id="invoicePreviewModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Invoice Preview</h3>
                <button class="close-modal" data-modal="invoicePreviewModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="invoicePreviewContent">
                    <!-- Invoice will be loaded here -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" id="downloadInvoiceBtn">
                        <i class="fas fa-download"></i> Download as PDF
                    </button>
                    <button class="btn btn-success" id="printInvoiceBtn">
                        <i class="fas fa-print"></i> Print Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Agronomy System
        class AgronomySystem {
            constructor() {
                this.backendUrl = 'https://agronomy-backend-ehk1.onrender.com';
                this.currentUser = null;
                this.userType = null;
                this.initialize();
            }

            initialize() {
                this.setupEventListeners();
                this.checkLoginStatus();
            }

            setupEventListeners() {
                // Login/Signup tabs
                document.querySelectorAll('.login-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.handleLoginTab(e);
                    });
                });

                // Login forms
                document.getElementById('farmerLoginForm').addEventListener('submit', (e) => this.handleFarmerLogin(e));
                document.getElementById('agronomistLoginForm').addEventListener('submit', (e) => this.handleAgronomistLogin(e));
                document.getElementById('farmerSignupForm').addEventListener('submit', (e) => this.handleFarmerSignup(e));

                // Navigation
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('navDashboard').addEventListener('click', (e) => this.loadDashboard(e));
                document.getElementById('navReports').addEventListener('click', (e) => this.loadReports(e));
                document.getElementById('navSales').addEventListener('click', (e) => this.loadSales(e));
                document.getElementById('navFarms').addEventListener('click', (e) => this.loadFarms(e));
                document.getElementById('navInvoices').addEventListener('click', (e) => this.loadInvoices(e));

                // Show/hide signup
                document.getElementById('showFarmerSignup').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('farmerLoginForm').style.display = 'none';
                    document.getElementById('farmerSignupForm').style.display = 'block';
                });

                document.getElementById('showFarmerLogin').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('farmerSignupForm').style.display = 'none';
                    document.getElementById('farmerLoginForm').style.display = 'block';
                });

                // Sale form calculations
                document.getElementById('saleQuantity').addEventListener('input', () => this.calculateSaleTotal());
                document.getElementById('salePrice').addEventListener('input', () => this.calculateSaleTotal());
                document.getElementById('saleExpenses').addEventListener('input', () => this.calculateProfit());

                // Modal close buttons
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const modalId = e.target.getAttribute('data-modal');
                        this.hideModal(modalId);
                    });
                });

                // Add sale button
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'addSaleBtn' || e.target.closest('#addSaleBtn')) {
                        this.showModal('addSaleModal');
                    }
                    if (e.target.id === 'addFarmBtn' || e.target.closest('#addFarmBtn')) {
                        this.showModal('addFarmModal');
                    }
                    if (e.target.id === 'addInvoiceItem') {
                        this.addInvoiceItem();
                    }
                    if (e.target.id === 'createReportBtn' || e.target.closest('#createReportBtn')) {
                        this.loadFarmersForReport();
                        this.showModal('createReportModal');
                    }
                    if (e.target.id === 'createInvoiceBtn' || e.target.closest('#createInvoiceBtn')) {
                        this.loadFarmersForInvoice();
                        this.showModal('createInvoiceModal');
                    }
                    if (e.target.id === 'toggleFarmersViewBtn' || e.target.closest('#toggleFarmersViewBtn')) {
                        this.toggleFarmersView();
                    }
                });

                // Form submissions
                document.getElementById('addSaleForm').addEventListener('submit', (e) => this.handleAddSale(e));
                document.getElementById('addFarmForm').addEventListener('submit', (e) => this.handleAddFarm(e));
                document.getElementById('createReportForm').addEventListener('submit', (e) => this.handleCreateReport(e));
                document.getElementById('createInvoiceForm').addEventListener('submit', (e) => this.handleCreateInvoice(e));
            }

            handleLoginTab(e) {
                const tab = e.target;
                const type = tab.getAttribute('data-type');
                
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                if (type === 'farmer') {
                    document.getElementById('farmerLoginForm').style.display = 'block';
                    document.getElementById('agronomistLoginForm').style.display = 'none';
                } else {
                    document.getElementById('farmerLoginForm').style.display = 'none';
                    document.getElementById('agronomistLoginForm').style.display = 'block';
                }
            }

            async handleFarmerLogin(e) {
                e.preventDefault();
                const email = document.getElementById('farmerEmail').value;
                const password = document.getElementById('farmerPassword').value;

                try {
                    const response = await this.apiRequest('/farmers/login', 'POST', { email, password });
                    
                    if (response.success) {
                        this.currentUser = response.data;
                        this.userType = 'farmer';
                        this.saveToLocalStorage();
                        this.hideModal('loginModal');
                        this.loadDashboard();
                        this.showNotification('Login successful!', 'success');
                    } else {
                        this.showNotification(response.message || 'Login failed', 'error');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    // Fallback to localStorage for demo
                    const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                    const farmer = farmers.find(f => f.email === email && f.password === password);
                    
                    if (farmer) {
                        this.currentUser = farmer;
                        this.userType = 'farmer';
                        this.saveToLocalStorage();
                        this.hideModal('loginModal');
                        this.loadDashboard();
                        this.showNotification('Login successful!', 'success');
                    } else {
                        this.showNotification('Invalid email or password', 'error');
                    }
                }
            }

            async handleAgronomistLogin(e) {
                e.preventDefault();
                const username = document.getElementById('agroUsername').value;
                const password = document.getElementById('agroPassword').value;

                // Hardcoded agronomist credentials for demo
                if (username === 'aaron_agronomy' && password === '9898') {
                    this.currentUser = {
                        id: 'AGRO-001',
                        name: 'Aaron Agronomist',
                        email: 'agronomist@aaronsystem.com',
                        role: 'agronomist'
                    };
                    this.userType = 'agronomist';
                    this.saveToLocalStorage();
                    this.hideModal('loginModal');
                    this.loadDashboard();
                    this.showNotification('Welcome, Agronomist!', 'success');
                } else {
                    this.showNotification('Invalid credentials', 'error');
                }
            }

            async handleFarmerSignup(e) {
                e.preventDefault();
                const formData = {
                    firstName: document.getElementById('signupFirstName').value,
                    lastName: document.getElementById('signupLastName').value,
                    email: document.getElementById('signupEmail').value,
                    phone: document.getElementById('signupPhone').value,
                    location: document.getElementById('signupLocation').value,
                    password: document.getElementById('signupPassword').value
                };

                if (formData.password !== document.getElementById('signupConfirmPassword').value) {
                    this.showNotification('Passwords do not match', 'error');
                    return;
                }

                try {
                    const response = await this.apiRequest('/farmers/register', 'POST', formData);
                    
                    if (response.success) {
                        this.showNotification('Account created successfully!', 'success');
                        // Switch to login form
                        document.getElementById('farmerSignupForm').style.display = 'none';
                        document.getElementById('farmerLoginForm').style.display = 'block';
                        document.getElementById('farmerEmail').value = formData.email;
                    } else {
                        this.showNotification(response.message || 'Registration failed', 'error');
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    // Fallback to localStorage for demo
                    const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                    const farmerId = 'FARM-' + Date.now().toString().slice(-6);
                    const newFarmer = {
                        id: farmerId,
                        ...formData,
                        createdAt: new Date().toISOString(),
                        status: 'active'
                    };
                    
                    farmers.push(newFarmer);
                    localStorage.setItem('farmers', JSON.stringify(farmers));
                    localStorage.setItem('farms', JSON.stringify([]));
                    localStorage.setItem('sales', JSON.stringify([]));
                    localStorage.setItem('reports', JSON.stringify([]));
                    localStorage.setItem('invoices', JSON.stringify([]));
                    
                    this.showNotification('Account created successfully! Farmer ID: ' + farmerId, 'success');
                    document.getElementById('farmerSignupForm').style.display = 'none';
                    document.getElementById('farmerLoginForm').style.display = 'block';
                    document.getElementById('farmerEmail').value = formData.email;
                }
            }

            checkLoginStatus() {
                const userData = localStorage.getItem('currentUser');
                if (userData) {
                    this.currentUser = JSON.parse(userData);
                    this.userType = localStorage.getItem('userType');
                    this.hideModal('loginModal');
                    this.loadDashboard();
                } else {
                    this.showModal('loginModal');
                }
            }

            logout() {
                this.currentUser = null;
                this.userType = null;
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userType');
                this.showModal('loginModal');
                this.showNotification('Logged out successfully', 'info');
            }

            async loadDashboard(e = null) {
                if (e) e.preventDefault();
                
                let html = '';
                
                if (this.userType === 'farmer') {
                    const sales = JSON.parse(localStorage.getItem('sales')) || [];
                    const farms = JSON.parse(localStorage.getItem('farms')) || [];
                    const reports = JSON.parse(localStorage.getItem('reports')) || [];
                    
                    const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
                    const totalExpenses = sales.reduce((sum, sale) => sum + sale.expenses, 0);
                    const totalProfit = totalSales - totalExpenses;
                    
                    // Update user info
                    document.getElementById('userAvatar').textContent = 
                        (this.currentUser.firstName?.[0] || 'F') + (this.currentUser.lastName?.[0] || '');
                    document.getElementById('userName').textContent = 
                        `${this.currentUser.firstName} ${this.currentUser.lastName}`;
                    document.getElementById('userRole').textContent = 'Farmer';
                    
                    // Update navigation
                    document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                    document.getElementById('navDashboard').classList.add('active');
                    
                    html = `
                        <div class="stats-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-dollar-sign"></i> Total Sales</h3>
                                </div>
                                <h2 style="color: var(--success); margin: 20px 0;">$${totalSales.toFixed(2)}</h2>
                                <p>All time sales</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-line"></i> Total Profit</h3>
                                </div>
                                <h2 style="color: var(--primary); margin: 20px 0;">$${totalProfit.toFixed(2)}</h2>
                                <p>Net profit</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-tractor"></i> Farms</h3>
                                </div>
                                <h2 style="color: var(--info); margin: 20px 0;">${farms.length}</h2>
                                <p>Active farms</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-file-alt"></i> Reports</h3>
                                </div>
                                <h2 style="color: var(--warning); margin: 20px 0;">${reports.filter(r => r.farmerId === this.currentUser.id).length}</h2>
                                <p>Agronomist reports</p>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-bar"></i> Recent Sales</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="addSaleBtn">
                                            <i class="fas fa-plus"></i> Add Sale
                                        </button>
                                    </div>
                                </div>
                                ${this.renderRecentSales(sales.slice(-5).reverse())}
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-tractor"></i> My Farms</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="addFarmBtn">
                                            <i class="fas fa-plus"></i> Add Farm
                                        </button>
                                    </div>
                                </div>
                                ${this.renderFarmsList(farms)}
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-file-medical-alt"></i> Recent Reports</h3>
                                </div>
                                ${this.renderRecentReports(reports.filter(r => r.farmerId === this.currentUser.id).slice(-3).reverse())}
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-pie"></i> Profit Analysis</h3>
                                </div>
                                <div class="chart-container">
                                    <canvas id="profitChart"></canvas>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('mainContent').innerHTML = html;
                    this.renderProfitChart(sales);
                    
                } else if (this.userType === 'agronomist') {
                    const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                    const sales = JSON.parse(localStorage.getItem('sales')) || [];
                    const reports = JSON.parse(localStorage.getItem('reports')) || [];
                    
                    const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
                    const totalProfit = sales.reduce((sum, sale) => sum + (sale.total - sale.expenses), 0);
                    
                    // Update user info
                    document.getElementById('userAvatar').textContent = 'AA';
                    document.getElementById('userName').textContent = 'Aaron Agronomist';
                    document.getElementById('userRole').textContent = 'Agronomist';
                    
                    html = `
                        <div class="stats-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-users"></i> Total Farmers</h3>
                                </div>
                                <h2 style="color: var(--success); margin: 20px 0;">${farmers.length}</h2>
                                <p>Registered farmers</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-line"></i> System Profit</h3>
                                </div>
                                <h2 style="color: var(--primary); margin: 20px 0;">$${totalProfit.toFixed(2)}</h2>
                                <p>Total system profit</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-file-alt"></i> Reports</h3>
                                </div>
                                <h2 style="color: var(--info); margin: 20px 0;">${reports.length}</h2>
                                <p>Reports generated</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-dollar-sign"></i> Total Sales</h3>
                                </div>
                                <h2 style="color: var(--warning); margin: 20px 0;">$${totalSales.toFixed(2)}</h2>
                                <p>All farmers sales</p>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-users"></i> Farmers Management</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="toggleFarmersViewBtn">
                                            <i class="fas fa-eye"></i> View More
                                        </button>
                                    </div>
                                </div>
                                <div id="farmersTableContainer">
                                    ${this.renderFarmersTable(farmers.slice(0, 5), false)}
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-file-medical-alt"></i> Create Reports</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="createReportBtn">
                                            <i class="fas fa-plus"></i> New Report
                                        </button>
                                    </div>
                                </div>
                                <p>Create detailed reports for farmers with findings and recommendations.</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-sm btn-primary" onclick="system.downloadAllReports()">
                                        <i class="fas fa-download"></i> Download All Reports
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-bar"></i> Sales Overview</h3>
                                </div>
                                <div class="chart-container">
                                    <canvas id="agroSalesChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-receipt"></i> Invoices</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="createInvoiceBtn">
                                            <i class="fas fa-plus"></i> Create Invoice
                                        </button>
                                    </div>
                                </div>
                                <p>Create and manage invoices for farmers.</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-sm btn-primary" onclick="system.downloadAllInvoices()">
                                        <i class="fas fa-download"></i> Download All Invoices
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('mainContent').innerHTML = html;
                    this.renderAgroSalesChart(sales);
                }
            }

            toggleFarmersView() {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const container = document.getElementById('farmersTableContainer');
                const button = document.getElementById('toggleFarmersViewBtn');
                
                if (!container || !button) return;
                
                const isShowingAll = button.innerHTML.includes('View Less');
                
                if (isShowingAll) {
                    // Show limited view (names only)
                    container.innerHTML = this.renderFarmersTable(farmers.slice(0, 5), true);
                    button.innerHTML = '<i class="fas fa-eye"></i> View More';
                    button.classList.remove('btn-warning');
                    button.classList.add('btn-success');
                } else {
                    // Show all records with full details
                    container.innerHTML = this.renderFarmersTable(farmers, false);
                    button.innerHTML = '<i class="fas fa-eye-slash"></i> View Less';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-warning');
                }
            }

            async loadSales(e = null) {
                if (e) e.preventDefault();
                
                if (this.userType !== 'farmer') return;
                
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-line"></i> Daily Sales Tracking</h3>
                            <div class="card-actions">
                                <button class="btn btn-success" id="addSaleBtn">
                                    <i class="fas fa-plus"></i> Add Daily Sale
                                </button>
                                <button class="btn btn-primary" onclick="system.downloadSalesExcel()">
                                    <i class="fas fa-download"></i> Export Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Crop</th>
                                        <th>Quantity (kg)</th>
                                        <th>Price/Kg</th>
                                        <th>Total Sales</th>
                                        <th>Expenses</th>
                                        <th>Profit</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                sales.forEach(sale => {
                    const profit = sale.total - sale.expenses;
                    html += `
                        <tr>
                            <td>${new Date(sale.date).toLocaleDateString()}</td>
                            <td>${sale.crop}</td>
                            <td>${sale.quantity}</td>
                            <td>$${sale.pricePerKg.toFixed(2)}</td>
                            <td>$${sale.total.toFixed(2)}</td>
                            <td>$${sale.expenses.toFixed(2)}</td>
                            <td><span class="badge ${profit >= 0 ? 'badge-success' : 'badge-danger'}">$${profit.toFixed(2)}</span></td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="system.deleteSale('${sale.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="card" style="margin-top: 30px;">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-area"></i> Sales & Profit Chart</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navSales').classList.add('active');
                
                this.renderSalesChart(sales);
            }

            async loadFarms(e = null) {
                if (e) e.preventDefault();
                
                if (this.userType !== 'farmer') return;
                
                const farms = JSON.parse(localStorage.getItem('farms')) || [];
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-tractor"></i> Farm Management</h3>
                            <div class="card-actions">
                                <button class="btn btn-success" id="addFarmBtn">
                                    <i class="fas fa-plus"></i> Add Farm
                                </button>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                `;
                
                farms.forEach(farm => {
                    const farmReports = reports.filter(r => r.farmId === farm.id);
                    html += `
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-farm"></i> ${farm.name}</h3>
                                <span class="badge badge-success">${farm.size} acres</span>
                            </div>
                            <p><strong>Location:</strong> ${farm.location}</p>
                            <p><strong>Crops:</strong> ${farm.crops}</p>
                            <p><strong>Soil Type:</strong> ${farm.soilType}</p>
                            
                            <div style="margin-top: 15px;">
                                <h4>Farm Reports</h4>
                                ${farmReports.length > 0 ? 
                                    farmReports.map(report => `
                                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                            <strong>${report.title}</strong><br>
                                            <small>${new Date(report.date).toLocaleDateString()}</small>
                                            <button class="btn btn-sm btn-info" onclick="system.viewReport('${report.id}')" style="float: right;">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </div>
                                    `).join('') : 
                                    '<p>No reports yet</p>'
                                }
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navFarms').classList.add('active');
            }

            async loadReports(e = null) {
                if (e) e.preventDefault();
                
                if (this.userType === 'farmer') {
                    const reports = JSON.parse(localStorage.getItem('reports')) || [];
                    const farmerReports = reports.filter(r => r.farmerId === this.currentUser.id);
                    
                    let html = `
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-file-medical-alt"></i> Farm Reports</h3>
                                <div class="card-actions">
                                    <button class="btn btn-primary" onclick="system.downloadAllReports()">
                                        <i class="fas fa-download"></i> Download All
                                    </button>
                                </div>
                            </div>
                            
                            <div class="dashboard-grid">
                    `;
                    
                    farmerReports.forEach(report => {
                        html += `
                            <div class="card">
                                <div class="card-header">
                                    <h3>${report.title}</h3>
                                    <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                        ${report.status}
                                    </span>
                                </div>
                                <p><strong>Type:</strong> ${report.type.replace('_', ' ')}</p>
                                <p><strong>Date:</strong> ${new Date(report.date).toLocaleDateString()}</p>
                                <p><strong>Findings:</strong> ${report.findings.substring(0, 100)}...</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-info" onclick="system.viewReport('${report.id}')">
                                        <i class="fas fa-eye"></i> View Full Report
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('mainContent').innerHTML = html;
                } else if (this.userType === 'agronomist') {
                    const reports = JSON.parse(localStorage.getItem('reports')) || [];
                    const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                    
                    let html = `
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-file-alt"></i> All Reports</h3>
                                <div class="card-actions">
                                    <button class="btn btn-success" id="createReportBtn">
                                        <i class="fas fa-plus"></i> Create Report
                                    </button>
                                    <button class="btn btn-primary" onclick="system.downloadAllReports()">
                                        <i class="fas fa-download"></i> Export All
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Farmer</th>
                                            <th>Report Title</th>
                                            <th>Type</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    reports.forEach(report => {
                        const farmer = farmers.find(f => f.id === report.farmerId);
                        html += `
                            <tr>
                                <td>${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</td>
                                <td>${report.title}</td>
                                <td>${report.type.replace('_', ' ')}</td>
                                <td>${new Date(report.date).toLocaleDateString()}</td>
                                <td>
                                    <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                        ${report.status}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="system.viewReport('${report.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="system.editReportStatus('${report.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('mainContent').innerHTML = html;
                }
                
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navReports').classList.add('active');
            }

            async loadInvoices(e = null) {
                if (e) e.preventDefault();
                
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-receipt"></i> Invoices</h3>
                            ${this.userType === 'agronomist' ? `
                                <div class="card-actions">
                                    <button class="btn btn-success" id="createInvoiceBtn">
                                        <i class="fas fa-plus"></i> Create Invoice
                                    </button>
                                    <button class="btn btn-primary" onclick="system.downloadAllInvoices()">
                                        <i class="fas fa-download"></i> Export All
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Farmer</th>
                                        <th>Date</th>
                                        <th>Due Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                const userInvoices = this.userType === 'farmer' 
                    ? invoices.filter(inv => inv.farmerId === this.currentUser.id)
                    : invoices;
                
                userInvoices.forEach(invoice => {
                    const farmer = farmers.find(f => f.id === invoice.farmerId);
                    const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    
                    html += `
                        <tr>
                            <td>${invoice.id}</td>
                            <td>${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</td>
                            <td>${new Date(invoice.date).toLocaleDateString()}</td>
                            <td>${new Date(invoice.dueDate).toLocaleDateString()}</td>
                            <td>$${total.toFixed(2)}</td>
                            <td>
                                <span class="badge ${invoice.paid ? 'badge-success' : 'badge-warning'}">
                                    ${invoice.paid ? 'Paid' : 'Pending'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.previewInvoice('${invoice.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${this.userType === 'agronomist' ? `
                                    <button class="btn btn-sm btn-warning" onclick="system.editInvoice('${invoice.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navInvoices').classList.add('active');
            }

            // Helper methods
            calculateSaleTotal() {
                const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
                const price = parseFloat(document.getElementById('salePrice').value) || 0;
                const total = quantity * price;
                document.getElementById('saleTotal').value = total.toFixed(2);
                this.calculateProfit();
            }

            calculateProfit() {
                const total = parseFloat(document.getElementById('saleTotal').value) || 0;
                const expenses = parseFloat(document.getElementById('saleExpenses').value) || 0;
                const profit = total - expenses;
                document.getElementById('saleProfit').value = profit.toFixed(2);
            }

            async handleAddSale(e) {
                e.preventDefault();
                
                const sale = {
                    id: 'SALE-' + Date.now(),
                    farmerId: this.currentUser.id,
                    date: document.getElementById('saleDate').value,
                    crop: document.getElementById('saleCrop').value,
                    quantity: parseFloat(document.getElementById('saleQuantity').value),
                    pricePerKg: parseFloat(document.getElementById('salePrice').value),
                    total: parseFloat(document.getElementById('saleTotal').value),
                    expenses: parseFloat(document.getElementById('saleExpenses').value),
                    profit: parseFloat(document.getElementById('saleProfit').value),
                    notes: document.getElementById('saleNotes').value,
                    createdAt: new Date().toISOString()
                };
                
                try {
                    const response = await this.apiRequest('/sales', 'POST', sale);
                    
                    if (response.success) {
                        const sales = JSON.parse(localStorage.getItem('sales')) || [];
                        sales.push(sale);
                        localStorage.setItem('sales', JSON.stringify(sales));
                        
                        this.hideModal('addSaleModal');
                        this.loadDashboard();
                        this.showNotification('Daily sale record added!', 'success');
                    }
                } catch (error) {
                    console.error('Error adding sale:', error);
                    // Fallback to localStorage
                    const sales = JSON.parse(localStorage.getItem('sales')) || [];
                    sales.push(sale);
                    localStorage.setItem('sales', JSON.stringify(sales));
                    
                    this.hideModal('addSaleModal');
                    this.loadDashboard();
                    this.showNotification('Daily sale record added!', 'success');
                }
            }

            async handleAddFarm(e) {
                e.preventDefault();
                
                const farm = {
                    id: 'FARM-' + Date.now(),
                    farmerId: this.currentUser.id,
                    name: document.getElementById('farmName').value,
                    size: parseFloat(document.getElementById('farmSize').value),
                    location: document.getElementById('farmLocation').value,
                    crops: document.getElementById('farmCrops').value,
                    soilType: document.getElementById('farmSoil').value,
                    createdAt: new Date().toISOString()
                };
                
                try {
                    const response = await this.apiRequest('/farms', 'POST', farm);
                    
                    if (response.success) {
                        const farms = JSON.parse(localStorage.getItem('farms')) || [];
                        farms.push(farm);
                        localStorage.setItem('farms', JSON.stringify(farms));
                        
                        this.hideModal('addFarmModal');
                        this.loadDashboard();
                        this.showNotification('Farm added successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error adding farm:', error);
                    // Fallback to localStorage
                    const farms = JSON.parse(localStorage.getItem('farms')) || [];
                    farms.push(farm);
                    localStorage.setItem('farms', JSON.stringify(farms));
                    
                    this.hideModal('addFarmModal');
                    this.loadDashboard();
                    this.showNotification('Farm added successfully!', 'success');
                }
            }

            loadFarmersForReport() {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const select = document.getElementById('reportFarmer');
                select.innerHTML = '<option value="">Select Farmer</option>';
                
                farmers.forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.id;
                    option.textContent = `${farmer.firstName} ${farmer.lastName} (${farmer.email})`;
                    select.appendChild(option);
                });
            }

            async handleCreateReport(e) {
                e.preventDefault();
                
                const report = {
                    id: 'REPORT-' + Date.now(),
                    farmerId: document.getElementById('reportFarmer').value,
                    title: document.getElementById('reportTitle').value,
                    type: document.getElementById('reportType').value,
                    date: document.getElementById('reportDate').value,
                    findings: document.getElementById('reportFindings').value,
                    recommendations: document.getElementById('reportRecommendations').value,
                    status: document.getElementById('reportStatus').value,
                    createdBy: this.currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                try {
                    const response = await this.apiRequest('/reports', 'POST', report);
                    
                    if (response.success) {
                        const reports = JSON.parse(localStorage.getItem('reports')) || [];
                        reports.push(report);
                        localStorage.setItem('reports', JSON.stringify(reports));
                        
                        this.hideModal('createReportModal');
                        this.loadDashboard();
                        this.showNotification('Report created successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error creating report:', error);
                    // Fallback to localStorage
                    const reports = JSON.parse(localStorage.getItem('reports')) || [];
                    reports.push(report);
                    localStorage.setItem('reports', JSON.stringify(reports));
                    
                    this.hideModal('createReportModal');
                    this.loadDashboard();
                    this.showNotification('Report created successfully!', 'success');
                }
            }

            loadFarmersForInvoice() {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const select = document.getElementById('invoiceFarmer');
                select.innerHTML = '<option value="">Select Farmer</option>';
                
                farmers.forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.id;
                    option.textContent = `${farmer.firstName} ${farmer.lastName} (${farmer.email})`;
                    select.appendChild(option);
                });
                
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                const dueDateStr = dueDate.toISOString().split('T')[0];
                
                document.getElementById('invoiceDate').value = today;
                document.getElementById('invoiceDueDate').value = dueDateStr;
            }

            addInvoiceItem() {
                const container = document.getElementById('invoiceItems');
                const newItem = document.createElement('div');
                newItem.className = 'invoice-item';
                newItem.style.marginTop = '10px';
                newItem.innerHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" class="form-control invoice-desc" placeholder="Description" required>
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-control invoice-qty" placeholder="Qty" required>
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-control invoice-price" placeholder="Price" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.parentElement.remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.insertBefore(newItem, document.getElementById('addInvoiceItem'));
            }

            async handleCreateInvoice(e) {
                e.preventDefault();
                
                const items = [];
                document.querySelectorAll('.invoice-item').forEach(item => {
                    const desc = item.querySelector('.invoice-desc').value;
                    const qty = parseFloat(item.querySelector('.invoice-qty').value);
                    const price = parseFloat(item.querySelector('.invoice-price').value);
                    
                    if (desc && qty && price) {
                        items.push({
                            description: desc,
                            quantity: qty,
                            price: price
                        });
                    }
                });
                
                if (items.length === 0) {
                    this.showNotification('Please add at least one invoice item', 'error');
                    return;
                }
                
                const invoice = {
                    id: 'INV-' + Date.now(),
                    farmerId: document.getElementById('invoiceFarmer').value,
                    date: document.getElementById('invoiceDate').value,
                    dueDate: document.getElementById('invoiceDueDate').value,
                    items: items,
                    notes: document.getElementById('invoiceNotes').value,
                    createdBy: this.currentUser.id,
                    paid: false,
                    createdAt: new Date().toISOString()
                };
                
                try {
                    const response = await this.apiRequest('/invoices', 'POST', invoice);
                    
                    if (response.success) {
                        const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                        invoices.push(invoice);
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                        
                        this.hideModal('createInvoiceModal');
                        this.previewInvoice(invoice.id);
                        this.showNotification('Invoice created successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error creating invoice:', error);
                    // Fallback to localStorage
                    const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                    invoices.push(invoice);
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    
                    this.hideModal('createInvoiceModal');
                    this.previewInvoice(invoice.id);
                    this.showNotification('Invoice created successfully!', 'success');
                }
            }

            viewReport(reportId) {
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                const report = reports.find(r => r.id === reportId);
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const farmer = farmers.find(f => f.id === report.farmerId);
                
                if (!report) return;
                
                let html = `
                    <div class="invoice">
                        <div class="invoice-header">
                            <div>
                                <h2>${report.title}</h2>
                                <p><strong>Farmer:</strong> ${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>Date:</strong> ${new Date(report.date).toLocaleDateString()}</p>
                                <p><strong>Type:</strong> ${report.type.replace('_', ' ')}</p>
                                <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                    ${report.status}
                                </span>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h4>Findings</h4>
                            <p style="white-space: pre-wrap;">${report.findings}</p>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h4>Recommendations</h4>
                            <p style="white-space: pre-wrap;">${report.recommendations}</p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-primary" onclick="system.downloadReport('${report.id}')">
                                <i class="fas fa-download"></i> Download Report
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportContent').innerHTML = html;
                this.showModal('viewReportModal');
            }

            viewFarmerDetails(farmerId) {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                const farms = JSON.parse(localStorage.getItem('farms')) || [];
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                
                const farmer = farmers.find(f => f.id === farmerId);
                if (!farmer) return;
                
                const farmerSales = sales.filter(s => s.farmerId === farmerId);
                const farmerFarms = farms.filter(f => f.farmerId === farmerId);
                const farmerReports = reports.filter(r => r.farmerId === farmerId);
                
                const totalSales = farmerSales.reduce((sum, sale) => sum + sale.total, 0);
                const totalProfit = farmerSales.reduce((sum, sale) => sum + (sale.total - sale.expenses), 0);
                
                let html = `
                    <div class="invoice">
                        <div class="invoice-header">
                            <div>
                                <h2>${farmer.firstName} ${farmer.lastName}</h2>
                                <p><strong>Farmer ID:</strong> ${farmer.id}</p>
                            </div>
                            <div style="text-align: right;">
                                <span class="badge badge-${farmer.status === 'active' ? 'success' : farmer.status === 'pending' ? 'warning' : 'danger'}">
                                    ${farmer.status || 'active'}
                                </span>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h4>Contact Information</h4>
                            <p><strong>Email:</strong> ${farmer.email}</p>
                            <p><strong>Phone:</strong> ${farmer.phone || 'N/A'}</p>
                            <p><strong>Location:</strong> ${farmer.location}</p>
                            <p><strong>Registered:</strong> ${new Date(farmer.createdAt).toLocaleDateString()}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: var(--success); margin-bottom: 5px;">$${totalSales.toFixed(2)}</h5>
                                <small>Total Sales</small>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: var(--primary); margin-bottom: 5px;">$${totalProfit.toFixed(2)}</h5>
                                <small>Total Profit</small>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: var(--info); margin-bottom: 5px;">${farmerFarms.length}</h5>
                                <small>Active Farms</small>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h4>Farms</h4>
                            ${farmerFarms.length > 0 ? 
                                farmerFarms.map(farm => `
                                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                        <strong>${farm.name}</strong> - ${farm.size} acres<br>
                                        <small>${farm.location} | ${farm.crops} | ${farm.soilType} soil</small>
                                    </div>
                                `).join('') : 
                                '<p>No farms registered yet.</p>'
                            }
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h4>Recent Reports</h4>
                            ${farmerReports.length > 0 ? 
                                farmerReports.slice(-3).reverse().map(report => `
                                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                        <strong>${report.title}</strong>
                                        <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}" style="float: right;">
                                            ${report.status}
                                        </span><br>
                                        <small>${report.type.replace('_', ' ')} - ${new Date(report.date).toLocaleDateString()}</small>
                                    </div>
                                `).join('') : 
                                '<p>No reports available.</p>'
                            }
                        </div>
                    </div>
                `;
                
                // Create a modal for farmer details
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Farmer Details</h3>
                            <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${html}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            previewInvoice(invoiceId) {
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const invoice = invoices.find(i => i.id === invoiceId);
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const farmer = farmers.find(f => f.id === invoice.farmerId);
                const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                
                let html = `
                    <div class="invoice">
                        <div class="invoice-header">
                            <div>
                                <h2>Invoice #${invoice.id}</h2>
                                <p><strong>To:</strong> ${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</p>
                                <p>${farmer?.email || ''}</p>
                                <p>${farmer?.phone || ''}</p>
                                <p>${farmer?.location || ''}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                                <p><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString()}</p>
                                <span class="badge ${invoice.paid ? 'badge-success' : 'badge-warning'}">
                                    ${invoice.paid ? 'PAID' : 'PENDING'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="invoice-items">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                invoice.items.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.description}</td>
                            <td>${item.quantity}</td>
                            <td>$${item.price.toFixed(2)}</td>
                            <td>$${(item.quantity * item.price).toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="invoice-total">
                            <h3>Total: $${total.toFixed(2)}</h3>
                        </div>
                        
                        ${invoice.notes ? `
                            <div style="margin-top: 30px;">
                                <h4>Notes</h4>
                                <p>${invoice.notes}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                document.getElementById('invoicePreviewContent').innerHTML = html;
                this.showModal('invoicePreviewModal');
                
                // Setup download and print buttons
                document.getElementById('downloadInvoiceBtn').onclick = () => this.downloadInvoice(invoiceId);
                document.getElementById('printInvoiceBtn').onclick = () => window.print();
            }

            // Download methods
            downloadSalesExcel() {
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                let csv = 'Date,Crop,Quantity (kg),Price/Kg,Total Sales,Expenses,Profit,Notes\n';
                
                sales.forEach(sale => {
                    const profit = sale.total - sale.expenses;
                    csv += `${sale.date},${sale.crop},${sale.quantity},${sale.pricePerKg},${sale.total},${sale.expenses},${profit},"${sale.notes}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sales_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                this.showNotification('Sales data exported successfully!', 'success');
            }

            downloadAllReports() {
                const reports = this.userType === 'farmer' 
                    ? JSON.parse(localStorage.getItem('reports')).filter(r => r.farmerId === this.currentUser.id)
                    : JSON.parse(localStorage.getItem('reports')) || [];
                
                let csv = 'Report ID,Title,Type,Date,Status,Findings,Recommendations\n';
                
                reports.forEach(report => {
                    csv += `${report.id},"${report.title}",${report.type},${report.date},${report.status},"${report.findings.replace(/"/g, '""')}","${report.recommendations.replace(/"/g, '""')}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reports_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                this.showNotification('Reports exported successfully!', 'success');
            }

            downloadAllInvoices() {
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                let csv = 'Invoice ID,Farmer ID,Date,Due Date,Amount,Status,Items\n';
                
                invoices.forEach(invoice => {
                    const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    const itemsStr = invoice.items.map(item => `${item.description} (${item.quantity} x $${item.price})`).join('; ');
                    csv += `${invoice.id},${invoice.farmerId},${invoice.date},${invoice.dueDate},${total},${invoice.paid ? 'Paid' : 'Pending'},"${itemsStr}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoices_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                this.showNotification('Invoices exported successfully!', 'success');
            }

            downloadReport(reportId) {
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                const report = reports.find(r => r.id === reportId);
                
                if (!report) return;
                
                const content = `
                    Report: ${report.title}
                    Type: ${report.type}
                    Date: ${report.date}
                    Status: ${report.status}
                    
                    FINDINGS:
                    ${report.findings}
                    
                    RECOMMENDATIONS:
                    ${report.recommendations}
                `;
                
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${reportId}.txt`;
                a.click();
                
                this.showNotification('Report downloaded!', 'success');
            }

            downloadInvoice(invoiceId) {
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const invoice = invoices.find(i => i.id === invoiceId);
                
                if (!invoice) return;
                
                let content = `
                    INVOICE #${invoice.id}
                    Date: ${invoice.date}
                    Due Date: ${invoice.dueDate}
                    Status: ${invoice.paid ? 'PAID' : 'PENDING'}
                    
                    ITEMS:
                `;
                
                invoice.items.forEach(item => {
                    content += `${item.description} - ${item.quantity} x $${item.price} = $${(item.quantity * item.price).toFixed(2)}\n`;
                });
                
                const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                content += `\nTOTAL: $${total.toFixed(2)}`;
                
                if (invoice.notes) {
                    content += `\n\nNOTES:\n${invoice.notes}`;
                }
                
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice_${invoiceId}.txt`;
                a.click();
                
                this.showNotification('Invoice downloaded!', 'success');
            }

            // Chart rendering methods
            renderProfitChart(sales) {
                const ctx = document.getElementById('profitChart')?.getContext('2d');
                if (!ctx) return;
                
                // Group by month
                const monthlyData = {};
                sales.forEach(sale => {
                    const date = new Date(sale.date);
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { sales: 0, profit: 0 };
                    }
                    
                    monthlyData[monthYear].sales += sale.total;
                    monthlyData[monthYear].profit += (sale.total - sale.expenses);
                });
                
                const labels = Object.keys(monthlyData).sort();
                const salesData = labels.map(label => monthlyData[label].sales);
                const profitData = labels.map(label => monthlyData[label].profit);
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Sales',
                                data: salesData,
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Profit',
                                data: profitData,
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderSalesChart(sales) {
                const ctx = document.getElementById('salesChart')?.getContext('2d');
                if (!ctx) return;
                
                // Sort by date and take last 30 days
                const sortedSales = [...sales].sort((a, b) => new Date(a.date) - new Date(b.date));
                const recentSales = sortedSales.slice(-30);
                
                const labels = recentSales.map(s => new Date(s.date).toLocaleDateString());
                const salesData = recentSales.map(s => s.total);
                const profitData = recentSales.map(s => s.total - s.expenses);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Sales',
                                data: salesData,
                                backgroundColor: 'rgba(76, 175, 80, 0.7)',
                                borderColor: '#4CAF50',
                                borderWidth: 1
                            },
                            {
                                label: 'Profit',
                                data: profitData,
                                backgroundColor: 'rgba(33, 150, 243, 0.7)',
                                borderColor: '#2196F3',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderAgroSalesChart(sales) {
                const ctx = document.getElementById('agroSalesChart')?.getContext('2d');
                if (!ctx) return;
                
                // Group by crop
                const cropData = {};
                sales.forEach(sale => {
                    if (!cropData[sale.crop]) {
                        cropData[sale.crop] = { sales: 0, profit: 0 };
                    }
                    
                    cropData[sale.crop].sales += sale.total;
                    cropData[sale.crop].profit += (sale.total - sale.expenses);
                });
                
                const labels = Object.keys(cropData);
                const salesData = labels.map(crop => cropData[crop].sales);
                const profitData = labels.map(crop => cropData[crop].profit);
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: salesData,
                            backgroundColor: [
                                '#4CAF50',
                                '#2196F3',
                                '#FF9800',
                                '#9C27B0',
                                '#009688',
                                '#795548'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            // UI Helper methods
            showModal(modalId) {
                document.getElementById(modalId).style.display = 'flex';
            }

            hideModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; 
                         background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'}; 
                         color: white; padding: 15px 20px; border-radius: 5px; 
                         box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                        ${message}
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            saveToLocalStorage() {
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                localStorage.setItem('userType', this.userType);
            }

            async apiRequest(endpoint, method = 'GET', data = null) {
                const url = this.backendUrl + endpoint;
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(url, options);
                return await response.json();
            }

            // Render helper methods
            renderRecentSales(sales) {
                if (sales.length === 0) {
                    return '<p>No sales records yet. Add your first sale!</p>';
                }
                
                let html = '';
                sales.forEach(sale => {
                    const profit = sale.total - sale.expenses;
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${sale.crop}</strong>
                                <span>$${sale.total.toFixed(2)}</span>
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${new Date(sale.date).toLocaleDateString()} | 
                                Profit: <span class="${profit >= 0 ? 'text-success' : 'text-danger'}">$${profit.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
                
                return html;
            }

            renderFarmsList(farms) {
                if (farms.length === 0) {
                    return '<p>No farms added yet. Add your first farm!</p>';
                }
                
                let html = '';
                farms.forEach(farm => {
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${farm.name}</strong>
                                <span class="badge badge-info">${farm.size} acres</span>
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${farm.location} | ${farm.crops}
                            </div>
                        </div>
                    `;
                });
                
                return html;
            }

            renderRecentReports(reports) {
                if (reports.length === 0) {
                    return '<p>No reports yet. Reports will appear here from your agronomist.</p>';
                }
                
                let html = '';
                reports.forEach(report => {
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${report.title}</strong>
                                <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                    ${report.status}
                                </span>
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${new Date(report.date).toLocaleDateString()} | ${report.type.replace('_', ' ')}
                            </div>
                        </div>
                    `;
                });
                
                return html;
            }

            renderFarmersTable(farmers, showOnlyNames = false) {
                if (farmers.length === 0) {
                    return '<p>No farmers registered yet.</p>';
                }
                
                if (showOnlyNames) {
                    // Show only names in a simple list
                    let html = '<div style="max-height: 200px; overflow-y: auto;">';
                    farmers.forEach(farmer => {
                        html += `
                            <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                <strong>${farmer.firstName} ${farmer.lastName}</strong>
                                <span style="color: #666; font-size: 0.9em; margin-left: 10px;">${farmer.location}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    return html;
                }
                
                // Show full table with all details
                let html = '<div class="table-responsive"><table class="table"><thead><tr>';
                html += '<th>Name</th><th>Email</th><th>Phone</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                farmers.forEach(farmer => {
                    html += `
                        <tr>
                            <td><strong>${farmer.firstName} ${farmer.lastName}</strong></td>
                            <td>${farmer.email}</td>
                            <td>${farmer.phone || 'N/A'}</td>
                            <td>${farmer.location}</td>
                            <td>
                                <span class="badge badge-${farmer.status === 'active' ? 'success' : farmer.status === 'pending' ? 'warning' : 'danger'}">
                                    ${farmer.status || 'active'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.viewFarmerDetails('${farmer.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" onclick="system.editFarmerStatus('${farmer.id}')" title="Edit Status">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                return html;
            }

            // Additional methods
            deleteSale(saleId) {
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                const filteredSales = sales.filter(s => s.id !== saleId);
                localStorage.setItem('sales', JSON.stringify(filteredSales));
                this.loadSales();
                this.showNotification('Sale record deleted!', 'success');
            }

            editFarmerStatus(farmerId) {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const farmer = farmers.find(f => f.id === farmerId);
                
                if (!farmer) return;
                
                const newStatus = prompt('Update farmer status (active/pending/inactive):', farmer.status || 'active');
                
                if (newStatus && ['active', 'pending', 'inactive'].includes(newStatus.toLowerCase())) {
                    farmer.status = newStatus.toLowerCase();
                    localStorage.setItem('farmers', JSON.stringify(farmers));
                    this.loadDashboard();
                    this.showNotification('Farmer status updated!', 'success');
                }
            }

            editReportStatus(reportId) {
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                const report = reports.find(r => r.id === reportId);
                
                if (!report) return;
                
                const newStatus = prompt('Update report status (pending/approved/requires_action):', report.status || 'pending');
                
                if (newStatus && ['pending', 'approved', 'requires_action'].includes(newStatus.toLowerCase())) {
                    report.status = newStatus.toLowerCase();
                    localStorage.setItem('reports', JSON.stringify(reports));
                    this.loadReports();
                    this.showNotification('Report status updated!', 'success');
                }
            }

            editInvoice(invoiceId) {
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const invoice = invoices.find(i => i.id === invoiceId);
                
                if (!invoice) return;
                
                const paid = confirm('Mark this invoice as paid?');
                
                if (paid !== null) {
                    invoice.paid = paid;
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    this.loadInvoices();
                    this.showNotification('Invoice updated!', 'success');
                }
            }
        }

        // Initialize the system
        const system = new AgronomySystem();
        window.system = system; // Make it globally available for onclick handlers

        // Set default date for sale form
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('saleDate');
            if (dateInput) {
                dateInput.value = today;
                dateInput.max = today;
            }
            
            const reportDate = document.getElementById('reportDate');
            if (reportDate) {
                reportDate.value = today;
            }
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });
    </script>
</body>
</html>
