<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aaron Agronomy System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2E7D32;
            --primary-light: #4CAF50;
            --primary-dark: #1B5E20;
            --secondary: #FF9800;
            --light: #F5F5F5;
            --dark: #333333;
            --gray: #757575;
            --light-gray: #EEEEEE;
            --danger: #D32F2F;
            --success: #388E3C;
            --warning: #F57C00;
            --info: #1976D2;
            --invoice-bg: #FFFDE7;
            --invoice-header: #4CAF50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header and Navigation */
        .main-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: var(--secondary);
            padding: 10px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 3px solid var(--secondary);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: var(--secondary);
        }

        .logo-img {
            height: 50px;
            width: 50px;
            background-color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px;
            border: 2px solid var(--secondary);
        }

        .logo-img img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        .logo-text {
            text-align: left;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            margin-bottom: 2px;
            color: var(--secondary);
            font-weight: bold;
        }

        .logo-text p {
            font-size: 0.85rem;
            opacity: 0.9;
            color: white;
        }

        .system-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--secondary);
            text-align: center;
            flex: 1;
            margin: 0 15px;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
            white-space: nowrap;
        }

        .nav-links a:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .nav-links .active {
            background-color: rgba(255,255,255,0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 20px;
            flex-wrap: wrap;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: white;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .main-content {
            padding: 25px 0;
            min-height: calc(100vh - 80px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .card-header h3 {
            color: var(--primary);
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-info {
            background-color: var(--info);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* Tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            min-width: 600px;
        }

        .table th {
            background-color: rgba(46, 125, 50, 0.05);
            color: var(--primary);
            font-weight: 600;
            text-align: left;
            padding: 12px 15px;
            border-bottom: 2px solid var(--light-gray);
        }

        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--light-gray);
        }

        .table tr:hover {
            background-color: rgba(46, 125, 50, 0.02);
        }

        /* Status Badges */
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background-color: rgba(56, 142, 60, 0.1);
            color: var(--success);
        }

        .badge-warning {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .badge-danger {
            background-color: rgba(211, 47, 47, 0.1);
            color: var(--danger);
        }

        .badge-info {
            background-color: rgba(25, 118, 210, 0.1);
            color: var(--info);
        }

        /* Login Page */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            padding: 30px;
            margin: 20px;
        }

        .login-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .login-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            background: var(--light-gray);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .login-tab.active {
            background: var(--primary);
            color: white;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
        }

        .modal-body {
            padding: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
            line-height: 1;
        }

        /* Invoice */
        .invoice {
            background: var(--invoice-bg);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 2px solid var(--primary);
        }

        .invoice-header {
            background: var(--invoice-header);
            padding: 20px;
            border-radius: 8px 8px 0 0;
            color: white;
            margin: -25px -25px 20px -25px;
        }

        .invoice-company {
            text-align: center;
            margin-bottom: 30px;
        }

        .invoice-company h2 {
            color: var(--secondary);
            margin-bottom: 5px;
        }

        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .invoice-from, .invoice-to {
            flex: 1;
            min-width: 200px;
        }

        .invoice-items {
            margin: 25px 0;
        }

        .invoice-total {
            text-align: right;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid var(--light-gray);
        }

        .invoice-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--light-gray);
            font-style: italic;
            color: var(--gray);
        }

        /* Expense Container */
        .expense-container {
            background: #FFF3E0;
            border: 1px solid #FFB74D;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .expense-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #FFE0B2;
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* PDF Upload/Download Styles */
        .pdf-upload-container {
            border: 2px dashed var(--primary-light);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 15px 0;
            background-color: rgba(76, 175, 80, 0.05);
        }

        .pdf-preview {
            margin-top: 15px;
            padding: 10px;
            background: var(--light-gray);
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-icon {
            color: var(--danger);
            font-size: 1.5rem;
        }

        .upload-btn {
            background-color: var(--primary);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            margin-top: 10px;
        }

        .upload-btn input[type="file"] {
            display: none;
        }

        .pdf-list {
            margin-top: 20px;
        }

        .pdf-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--light-gray);
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .pdf-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Month Selector */
        .month-selector {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .month-btn {
            padding: 8px 15px;
            background: var(--light-gray);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .month-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Mobile Navigation */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 10px;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .header-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .logo, .system-title, .nav-links {
                width: 100%;
                justify-content: center;
            }
            
            .logo {
                justify-content: flex-start;
            }
            
            .system-title {
                text-align: center;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
            
            .nav-links {
                flex-direction: column;
                width: 100%;
                display: none;
                margin-top: 15px;
            }
            
            .nav-links.active {
                display: flex;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .invoice-details {
                flex-direction: column;
            }
            
            .modal-content {
                margin: 10px;
            }
            
            .table {
                min-width: 300px;
            }
            
            .table th, .table td {
                padding: 8px 10px;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .card-actions {
                flex-direction: column;
                width: 100%;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
                margin-bottom: 5px;
            }
            
            .user-info {
                flex-direction: column;
                text-align: center;
                padding: 10px;
            }
            
            .invoice-header h2 {
                font-size: 1.2rem;
            }
            
            .invoice-company h2 {
                font-size: 1.3rem;
            }
        }

        @media (max-width: 360px) {
            .container {
                padding: 0 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .login-card {
                padding: 20px;
            }
        }

        /* Print Styles */
        @media print {
            .main-header, .modal-header, .btn {
                display: none !important;
            }
            
            .modal {
                position: static;
                background: none;
            }
            
            .modal-content {
                box-shadow: none;
                max-height: none;
            }
            
            .invoice {
                border: none;
                box-shadow: none;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="container header-container">
            <a href="#" class="logo">
                <div class="logo-img">
                    <img src="aaron logo.webp" alt="Aaron Agronomy Services Logo" onerror="this.style.display='none'">
                </div>
            
            <div class="system-title">MKULIMA DIGITAL FARMER</div>
            
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <nav class="nav-links" id="navLinks">
                <a href="#" id="navDashboard" class="active"><i class="fas fa-home"></i> Dashboard</a>
                <a href="#" id="navReports"><i class="fas fa-file-alt"></i> Reports</a>
                <a href="#" id="navSales"><i class="fas fa-chart-line"></i> Sales</a>
                <a href="#" id="navFarms"><i class="fas fa-tractor"></i> Farms</a>
                <a href="#" id="navInvoices">
                    <i class="fas fa-receipt"></i> Invoices
                    <span class="notification-badge" id="invoiceNotification" style="display: none;">0</span>
                </a>
                
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div id="userName">User</div>
                        <small id="userRole">Role</small>
                    </div>
                    <button class="btn btn-sm btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content container" id="mainContent">
        <!-- Dashboard will be loaded here -->
    </main>

    <!-- Login Modal -->
    <div class="modal" id="loginModal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-body">
                <div class="login-header">
                    <h2>MKULIMA DIGITAL FARMER</h2>
                    <p>Aaron Agronomy System</p>
                </div>
                
                <div class="login-tabs">
                    <div class="login-tab active" data-type="farmer">Farmer</div>
                    <div class="login-tab" data-type="agronomist">Agronomist</div>
                </div>
                
                <!-- Farmer Login -->
                <form id="farmerLoginForm">
                    <div class="form-group">
                        <label for="farmerEmail">Email Address</label>
                        <input type="email" id="farmerEmail" class="form-control" placeholder="farmer@email.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="farmerPassword">Password</label>
                        <input type="password" id="farmerPassword" class="form-control" placeholder="Enter password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Login as Farmer
                    </button>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" id="showFarmerSignup" style="color: var(--primary);">Don't have account? Sign up</a>
                    </div>
                </form>
                
                <!-- Farmer Signup -->
                <form id="farmerSignupForm" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="signupFirstName">First Name</label>
                            <input type="text" id="signupFirstName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="signupLastName">Last Name</label>
                            <input type="text" id="signupLastName" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupEmail">Email Address</label>
                        <input type="email" id="signupEmail" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupPhone">Phone Number</label>
                        <input type="tel" id="signupPhone" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="signupLocation">Location</label>
                        <input type="text" id="signupLocation" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="signupPassword">Password</label>
                            <input type="password" id="signupPassword" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="signupConfirmPassword">Confirm Password</label>
                            <input type="password" id="signupConfirmPassword" class="form-control" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-user-plus"></i> Create Farmer Account
                    </button>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" id="showFarmerLogin" style="color: var(--primary);">Already have account? Login</a>
                    </div>
                </form>
                
                <!-- Agronomist Login -->
                <form id="agronomistLoginForm" style="display: none;">
                    <div class="form-group">
                        <label for="agroUsername">Username</label>
                        <input type="text" id="agroUsername" class="form-control" value="aaron_agronomy" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="agroPassword">Password</label>
                        <input type="password" id="agroPassword" class="form-control" value="9898" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-user-md"></i> Login as Agronomist
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Daily Sale Modal -->
    <div class="modal" id="addSaleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Daily Sales Record</h3>
                <button class="close-modal" data-modal="addSaleModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addSaleForm">
                    <div class="form-group">
                        <label for="saleDate">Date</label>
                        <input type="date" id="saleDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleCrop">Crop Type</label>
                        <select id="saleCrop" class="form-control" required>
                            <option value="">Select Crop</option>
                            <option value="pixie">Pixie</option>
                            <option value="mango">Mango</option>
                            <option value="Avocado">Avocado</option>
                            <option value="Lemon">Lemon</option>
                            <option value="Pawpaw">Pawpaw</option>
                            <option value="maize">Maize</option>
                            <option value="wheat">Wheat</option>
                            <option value="coffee">Coffee</option>
                            <option value="tea">Tea</option>
                            <option value="beans">Beans</option>
                            <option value="vegetables">Vegetables</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="saleQuantity">Quantity (kg)</label>
                            <input type="number" id="saleQuantity" class="form-control" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="salePrice">Price per Kg (KSH)</label>
                            <input type="number" id="salePrice" class="form-control" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleTotal">Total Sales (KSH)</label>
                        <input type="number" id="saleTotal" class="form-control" step="0.01" readonly>
                    </div>
                    
                    <div class="expense-container">
                        <h4><i class="fas fa-money-bill-wave"></i> Expenses</h4>
                        <div id="expenseItems">
                            <div class="expense-item">
                                <input type="text" class="form-control expense-desc" placeholder="Expense Description" style="flex: 2;">
                                <input type="number" class="form-control expense-amount" placeholder="Amount (KSH)" step="0.01" style="flex: 1; margin-left: 10px;">
                                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove()" style="margin-left: 10px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" id="addExpenseBtn" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i> Add Expense
                        </button>
                        <div class="form-group" style="margin-top: 15px;">
                            <label for="totalExpenses">Total Expenses (KSH)</label>
                            <input type="number" id="totalExpenses" class="form-control" step="0.01" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleProfit">Profit (KSH)</label>
                        <input type="number" id="saleProfit" class="form-control" step="0.01" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="saleNotes">Notes</label>
                        <textarea id="saleNotes" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Daily Record
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Expense Modal (Farmer) -->
    <div class="modal" id="addExpenseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Expense</h3>
                <button class="close-modal" data-modal="addExpenseModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addExpenseForm">
                    <div class="form-group">
                        <label for="expenseDate">Date</label>
                        <input type="date" id="expenseDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseCategory">Category</label>
                        <select id="expenseCategory" class="form-control" required>
                            <option value="">Select Category</option>
                            <option value="seeds">Seeds</option>
                            <option value="fertilizer">Fertilizer</option>
                            <option value="pesticides">Pesticides</option>
                            <option value="labor">Labor</option>
                            <option value="equipment">Equipment</option>
                            <option value="transport">Transport</option>
                            <option value="irrigation">Irrigation</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseDescription">Description</label>
                        <input type="text" id="expenseDescription" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseAmount">Amount (KSH)</label>
                        <input type="number" id="expenseAmount" class="form-control" step="0.01" required>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Expense
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Task Modal (Agronomist) -->
    <div class="modal" id="addTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Task & Payment</h3>
                <button class="close-modal" data-modal="addTaskModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="form-group">
                        <label for="taskFarmer">Select Farmer</label>
                        <select id="taskFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDate">Date</label>
                        <input type="date" id="taskDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Task Description</label>
                        <textarea id="taskDescription" class="form-control" rows="3" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskHours">Hours Worked</label>
                            <input type="number" id="taskHours" class="form-control" step="0.5" required>
                        </div>
                        <div class="form-group">
                            <label for="taskRate">Rate per Hour (KSH)</label>
                            <input type="number" id="taskRate" class="form-control" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskPayment">Total Payment (KSH)</label>
                        <input type="number" id="taskPayment" class="form-control" step="0.01" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskStatus">Status</label>
                        <select id="taskStatus" class="form-control" required>
                            <option value="pending">Pending</option>
                            <option value="completed">Completed</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Task
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Farm Modal -->
    <div class="modal" id="addFarmModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Farm</h3>
                <button class="close-modal" data-modal="addFarmModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addFarmForm">
                    <div class="form-group">
                        <label for="farmName">Farm Name</label>
                        <input type="text" id="farmName" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="farmSize">Size (acres)</label>
                            <input type="number" id="farmSize" class="form-control" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="farmLocation">Location</label>
                            <input type="text" id="farmLocation" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="farmCrops">Main Crops</label>
                        <input type="text" id="farmCrops" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="farmSoil">Soil Type</label>
                        <select id="farmSoil" class="form-control" required>
                            <option value="">Select Soil Type</option>
                            <option value="loamy">Loamy</option>
                            <option value="clay">Clay</option>
                            <option value="sandy">Sandy</option>
                            <option value="silt">Silt</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Save Farm
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Report Modal (Agronomist) -->
    <div class="modal" id="createReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Farmer Report</h3>
                <button class="close-modal" data-modal="createReportModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createReportForm">
                    <div class="form-group">
                        <label for="reportFarmer">Select Farmer</label>
                        <select id="reportFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportTitle">Report Title</label>
                        <input type="text" id="reportTitle" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportType">Report Type</label>
                        <select id="reportType" class="form-control" required>
                            <option value="soil_analysis">Soil Analysis</option>
                            <option value="crop_health">Crop Health</option>
                            <option value="pest_control">Pest Control</option>
                            <option value="fertilizer">Fertilizer Recommendation</option>
                            <option value="general">General Advisory</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportDate">Report Date</label>
                        <input type="date" id="reportDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportFindings">Findings</label>
                        <textarea id="reportFindings" class="form-control" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportRecommendations">Recommendations</label>
                        <textarea id="reportRecommendations" class="form-control" rows="4" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="reportStatus">Status</label>
                        <select id="reportStatus" class="form-control" required>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="requires_action">Requires Action</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-file-export"></i> Generate Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Upload PDF Modal (Agronomist) -->
    <div class="modal" id="uploadPdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload PDF for Farmer</h3>
                <button class="close-modal" data-modal="uploadPdfModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="uploadPdfForm">
                    <div class="form-group">
                        <label for="pdfFarmer">Select Farmer</label>
                        <select id="pdfFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pdfTitle">PDF Title</label>
                        <input type="text" id="pdfTitle" class="form-control" placeholder="e.g., Soil Analysis Report, Farming Guide" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="pdfDescription">Description</label>
                        <textarea id="pdfDescription" class="form-control" rows="3" placeholder="Brief description of the PDF content"></textarea>
                    </div>
                    
                    <div class="pdf-upload-container">
                        <i class="fas fa-file-pdf pdf-icon"></i>
                        <p>Upload PDF file (Max: 10MB)</p>
                        <label class="upload-btn">
                            <input type="file" id="pdfFile" accept=".pdf" required>
                            <i class="fas fa-upload"></i> Choose PDF File
                        </label>
                        <div id="pdfFileName" style="margin-top: 10px; color: var(--gray);"></div>
                    </div>
                    
                    <div class="form-group">
                        <label for="pdfCategory">Category</label>
                        <select id="pdfCategory" class="form-control">
                            <option value="reports">Reports</option>
                            <option value="guides">Farming Guides</option>
                            <option value="certificates">Certificates</option>
                            <option value="market_info">Market Information</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <button type="submit" class="btn btn-success" style="width: 100%;">
                        <i class="fas fa-cloud-upload-alt"></i> Upload PDF
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Create Invoice Modal -->
    <div class="modal" id="createInvoiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Invoice</h3>
                <button class="close-modal" data-modal="createInvoiceModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createInvoiceForm">
                    <div class="form-group">
                        <label for="invoiceFarmer">Select Farmer</label>
                        <select id="invoiceFarmer" class="form-control" required>
                            <option value="">Select Farmer</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceDate">Invoice Date</label>
                        <input type="date" id="invoiceDate" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceDueDate">Due Date</label>
                        <input type="date" id="invoiceDueDate" class="form-control" required>
                    </div>
                    
                    <div class="invoice-items" id="invoiceItems">
                        <h4>Invoice Items</h4>
                        <div class="invoice-item">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Description</label>
                                    <input type="text" class="form-control invoice-desc" required>
                                </div>
                                <div class="form-group">
                                    <label>Quantity</label>
                                    <input type="number" class="form-control invoice-qty" required>
                                </div>
                                <div class="form-group">
                                    <label>Unit Price (KSH)</label>
                                    <input type="number" class="form-control invoice-price" step="0.01" required>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-secondary" id="addInvoiceItem">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="invoiceNotes">Notes</label>
                        <textarea id="invoiceNotes" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-file-invoice-dollar"></i> Create Invoice
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- View Report Modal -->
    <div class="modal" id="viewReportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Farm Report</h3>
                <button class="close-modal" data-modal="viewReportModal">&times;</button>
            </div>
            <div class="modal-body" id="reportContent">
                <!-- Report content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- View PDF Modal -->
    <div class="modal" id="viewPdfModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>PDF Document</h3>
                <button class="close-modal" data-modal="viewPdfModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="pdfViewerContent">
                    <!-- PDF info will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Invoice Preview Modal -->
    <div class="modal" id="invoicePreviewModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Invoice Preview</h3>
                <button class="close-modal" data-modal="invoicePreviewModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="invoicePreviewContent">
                    <!-- Invoice will be loaded here -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-primary" id="downloadInvoiceBtn">
                        <i class="fas fa-download"></i> Download as PDF
                    </button>
                    <button class="btn btn-success" id="printInvoiceBtn">
                        <i class="fas fa-print"></i> Print Invoice
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Agronomy System
        class AgronomySystem {
            constructor() {
                this.backendUrl = 'https://agronomy-backend-ehk1.onrender.com';
                this.currentUser = null;
                this.userType = null;
                this.currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
                this.initialize();
            }

            initialize() {
                this.setupEventListeners();
                this.checkLoginStatus();
                this.initializeData();
            }

            initializeData() {
                // Initialize localStorage with default data if empty
                if (!localStorage.getItem('farmers')) {
                    localStorage.setItem('farmers', JSON.stringify([]));
                }
                if (!localStorage.getItem('sales')) {
                    localStorage.setItem('sales', JSON.stringify([]));
                }
                if (!localStorage.getItem('expenses')) {
                    localStorage.setItem('expenses', JSON.stringify([]));
                }
                if (!localStorage.getItem('farms')) {
                    localStorage.setItem('farms', JSON.stringify([]));
                }
                if (!localStorage.getItem('reports')) {
                    localStorage.setItem('reports', JSON.stringify([]));
                }
                if (!localStorage.getItem('invoices')) {
                    localStorage.setItem('invoices', JSON.stringify([]));
                }
                if (!localStorage.getItem('tasks')) {
                    localStorage.setItem('tasks', JSON.stringify([]));
                }
                if (!localStorage.getItem('pdfs')) {
                    localStorage.setItem('pdfs', JSON.stringify([]));
                }
            }

            setupEventListeners() {
                // Menu toggle for mobile
                document.getElementById('menuToggle').addEventListener('click', () => {
                    document.getElementById('navLinks').classList.toggle('active');
                });

                // Login/Signup tabs
                document.querySelectorAll('.login-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.handleLoginTab(e);
                    });
                });

                // Login forms
                document.getElementById('farmerLoginForm').addEventListener('submit', (e) => this.handleFarmerLogin(e));
                document.getElementById('agronomistLoginForm').addEventListener('submit', (e) => this.handleAgronomistLogin(e));
                document.getElementById('farmerSignupForm').addEventListener('submit', (e) => this.handleFarmerSignup(e));

                // Navigation
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                document.getElementById('navDashboard').addEventListener('click', (e) => this.loadDashboard(e));
                document.getElementById('navReports').addEventListener('click', (e) => this.loadReports(e));
                document.getElementById('navSales').addEventListener('click', (e) => this.loadSales(e));
                document.getElementById('navFarms').addEventListener('click', (e) => this.loadFarms(e));
                document.getElementById('navInvoices').addEventListener('click', (e) => this.loadInvoices(e));

                // Show/hide signup
                document.getElementById('showFarmerSignup').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('farmerLoginForm').style.display = 'none';
                    document.getElementById('farmerSignupForm').style.display = 'block';
                });

                document.getElementById('showFarmerLogin').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('farmerSignupForm').style.display = 'none';
                    document.getElementById('farmerLoginForm').style.display = 'block';
                });

                // Sale form calculations
                const saleQuantity = document.getElementById('saleQuantity');
                const salePrice = document.getElementById('salePrice');
                if (saleQuantity) saleQuantity.addEventListener('input', () => this.calculateSaleTotal());
                if (salePrice) salePrice.addEventListener('input', () => this.calculateSaleTotal());
                
                const addExpenseBtn = document.getElementById('addExpenseBtn');
                if (addExpenseBtn) addExpenseBtn.addEventListener('click', () => this.addExpenseItem());

                // Expense item calculations
                document.addEventListener('input', (e) => {
                    if (e.target.classList.contains('expense-amount')) {
                        this.calculateTotalExpenses();
                    }
                });

                // Task form calculations
                const taskHours = document.getElementById('taskHours');
                const taskRate = document.getElementById('taskRate');
                if (taskHours) taskHours.addEventListener('input', () => this.calculateTaskPayment());
                if (taskRate) taskRate.addEventListener('input', () => this.calculateTaskPayment());

                // Modal close buttons
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const modalId = e.target.getAttribute('data-modal');
                        this.hideModal(modalId);
                        document.getElementById('navLinks').classList.remove('active');
                    });
                });

                // Add invoice item
                const addInvoiceItem = document.getElementById('addInvoiceItem');
                if (addInvoiceItem) addInvoiceItem.addEventListener('click', () => this.addInvoiceItem());

                // File input change event
                const pdfFile = document.getElementById('pdfFile');
                if (pdfFile) {
                    pdfFile.addEventListener('change', function(e) {
                        const fileName = document.getElementById('pdfFileName');
                        if (this.files.length > 0) {
                            fileName.textContent = 'Selected: ' + this.files[0].name;
                            fileName.style.color = 'var(--success)';
                        } else {
                            fileName.textContent = 'No file selected';
                            fileName.style.color = 'var(--gray)';
                        }
                    });
                }

                // Event delegation for dynamic buttons
                document.addEventListener('click', (e) => {
                    if (e.target.id === 'addSaleBtn' || e.target.closest('#addSaleBtn')) {
                        this.showModal('addSaleModal');
                    }
                    if (e.target.id === 'addFarmBtn' || e.target.closest('#addFarmBtn')) {
                        this.showModal('addFarmModal');
                    }
                    if (e.target.id === 'createReportBtn' || e.target.closest('#createReportBtn')) {
                        this.loadFarmersForReport();
                        this.showModal('createReportModal');
                    }
                    if (e.target.id === 'createInvoiceBtn' || e.target.closest('#createInvoiceBtn')) {
                        this.loadFarmersForInvoice();
                        this.showModal('createInvoiceModal');
                    }
                    if (e.target.id === 'addExpenseBtnMain' || e.target.closest('#addExpenseBtnMain')) {
                        this.showModal('addExpenseModal');
                    }
                    if (e.target.id === 'addTaskBtn' || e.target.closest('#addTaskBtn')) {
                        this.loadFarmersForTask();
                        this.showModal('addTaskModal');
                    }
                    if (e.target.id === 'uploadPdfBtn' || e.target.closest('#uploadPdfBtn')) {
                        this.loadFarmersForPdfUpload();
                        this.showModal('uploadPdfModal');
                    }
                    if (e.target.id === 'viewMyPdfsBtn' || e.target.closest('#viewMyPdfsBtn')) {
                        this.loadMyPdfs();
                    }
                });

                // Form submissions
                const forms = ['addSaleForm', 'addFarmForm', 'createReportForm', 'createInvoiceForm', 
                             'addExpenseForm', 'addTaskForm', 'uploadPdfForm'];
                forms.forEach(formId => {
                    const form = document.getElementById(formId);
                    if (form) {
                        form.addEventListener('submit', (e) => {
                            e.preventDefault();
                            this[`handle${formId.charAt(0).toUpperCase() + formId.slice(1)}`](e);
                        });
                    }
                });

                // Close mobile menu when clicking outside
                document.addEventListener('click', (e) => {
                    const navLinks = document.getElementById('navLinks');
                    const menuToggle = document.getElementById('menuToggle');
                    if (!navLinks.contains(e.target) && !menuToggle.contains(e.target) && navLinks.classList.contains('active')) {
                        navLinks.classList.remove('active');
                    }
                });
            }

            handleLoginTab(e) {
                const tab = e.target;
                const type = tab.getAttribute('data-type');
                
                document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                if (type === 'farmer') {
                    document.getElementById('farmerLoginForm').style.display = 'block';
                    document.getElementById('agronomistLoginForm').style.display = 'none';
                } else {
                    document.getElementById('farmerLoginForm').style.display = 'none';
                    document.getElementById('agronomistLoginForm').style.display = 'block';
                }
            }

            async handleFarmerLogin(e) {
                e.preventDefault();
                const email = document.getElementById('farmerEmail').value;
                const password = document.getElementById('farmerPassword').value;

                // Quick login - check localStorage first
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const farmer = farmers.find(f => f.email === email && f.password === password);
                
                if (farmer) {
                    this.currentUser = farmer;
                    this.userType = 'farmer';
                    this.saveToLocalStorage();
                    this.hideModal('loginModal');
                    this.loadDashboard();
                    this.updateInvoiceNotifications();
                    this.showNotification('Login successful!', 'success');
                    return;
                }

                try {
                    const response = await fetch(this.backendUrl + '/farmers/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.currentUser = data;
                        this.userType = 'farmer';
                        this.saveToLocalStorage();
                        this.hideModal('loginModal');
                        this.loadDashboard();
                        this.updateInvoiceNotifications();
                        this.showNotification('Login successful!', 'success');
                    } else {
                        this.showNotification('Invalid email or password', 'error');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    this.showNotification('Login failed. Please try again.', 'error');
                }
            }

            async handleAgronomistLogin(e) {
                e.preventDefault();
                const username = document.getElementById('agroUsername').value;
                const password = document.getElementById('agroPassword').value;

                // Quick login - hardcoded credentials
                if (username === 'aaron_agronomy' && password === '9898') {
                    this.currentUser = {
                        id: 'AGRO-001',
                        name: 'Aaron Agronomist',
                        email: 'aaronmuthini0@gmail.com',
                        role: 'agronomist'
                    };
                    this.userType = 'agronomist';
                    this.saveToLocalStorage();
                    this.hideModal('loginModal');
                    this.loadDashboard();
                    this.updateInvoiceNotifications();
                    this.showNotification('Welcome, Agronomist!', 'success');
                } else {
                    this.showNotification('Invalid credentials', 'error');
                }
            }

            async handleFarmerSignup(e) {
                e.preventDefault();
                const formData = {
                    firstName: document.getElementById('signupFirstName').value,
                    lastName: document.getElementById('signupLastName').value,
                    email: document.getElementById('signupEmail').value,
                    phone: document.getElementById('signupPhone').value,
                    location: document.getElementById('signupLocation').value,
                    password: document.getElementById('signupPassword').value
                };

                if (formData.password !== document.getElementById('signupConfirmPassword').value) {
                    this.showNotification('Passwords do not match', 'error');
                    return;
                }

                try {
                    const response = await fetch(this.backendUrl + '/farmers/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.showNotification('Account created successfully!', 'success');
                        // Switch to login form
                        document.getElementById('farmerSignupForm').style.display = 'none';
                        document.getElementById('farmerLoginForm').style.display = 'block';
                        document.getElementById('farmerEmail').value = formData.email;
                    } else {
                        this.showNotification('Registration failed', 'error');
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    // Fallback to localStorage
                    const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                    const farmerId = 'FARM-' + Date.now().toString().slice(-6);
                    const newFarmer = {
                        id: farmerId,
                        ...formData,
                        createdAt: new Date().toISOString(),
                        status: 'active'
                    };
                    
                    farmers.push(newFarmer);
                    localStorage.setItem('farmers', JSON.stringify(farmers));
                    
                    this.showNotification('Account created successfully! Farmer ID: ' + farmerId, 'success');
                    document.getElementById('farmerSignupForm').style.display = 'none';
                    document.getElementById('farmerLoginForm').style.display = 'block';
                    document.getElementById('farmerEmail').value = formData.email;
                }
            }

            checkLoginStatus() {
                const userData = localStorage.getItem('currentUser');
                if (userData) {
                    this.currentUser = JSON.parse(userData);
                    this.userType = localStorage.getItem('userType');
                    this.hideModal('loginModal');
                    this.loadDashboard();
                    this.updateInvoiceNotifications();
                } else {
                    this.showModal('loginModal');
                }
            }

            logout() {
                this.currentUser = null;
                this.userType = null;
                localStorage.removeItem('currentUser');
                localStorage.removeItem('userType');
                document.getElementById('navLinks').classList.remove('active');
                this.showModal('loginModal');
                this.showNotification('Logged out successfully', 'info');
            }

            async loadDashboard(e = null) {
                if (e) e.preventDefault();
                
                let html = '';
                
                if (this.userType === 'farmer') {
                    const sales = JSON.parse(localStorage.getItem('sales')) || [];
                    const expenses = JSON.parse(localStorage.getItem('expenses')) || [];
                    const farms = JSON.parse(localStorage.getItem('farms')) || [];
                    const reports = JSON.parse(localStorage.getItem('reports')) || [];
                    const pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
                    const farmerReports = reports.filter(p => p.farmerId === this.currentUser.id);
                    const farmerPdfs = pdfs.filter(p => p.farmerId === this.currentUser.id);
                    
                    // Calculate totals
                    const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
                    const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
                    const totalProfit = totalSales - totalExpenses;
                    
                    // Update user info
                    document.getElementById('userAvatar').textContent = 
                        (this.currentUser.firstName?.[0] || 'F') + (this.currentUser.lastName?.[0] || '');
                    document.getElementById('userName').textContent = 
                        `${this.currentUser.firstName} ${this.currentUser.lastName}`;
                    document.getElementById('userRole').textContent = 'Farmer';
                    
                    // Update navigation
                    document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                    document.getElementById('navDashboard').classList.add('active');
                    
                    html = `
                        <div class="stats-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-money-bill-wave"></i> Total Sales</h3>
                                </div>
                                <h2 style="color: var(--success); margin: 20px 0;">KSH ${totalSales.toLocaleString()}</h2>
                                <p>All time sales</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-line"></i> Total Expenses</h3>
                                </div>
                                <h2 style="color: var(--danger); margin: 20px 0;">KSH ${totalExpenses.toLocaleString()}</h2>
                                <p>All expenses</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-tractor"></i> Total Profit</h3>
                                </div>
                                <h2 style="color: ${totalProfit >= 0 ? 'var(--primary)' : 'var(--danger)'}; margin: 20px 0;">KSH ${totalProfit.toLocaleString()}</h2>
                                <p>Net profit</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-file-alt"></i> Reports</h3>
                                </div>
                                <h2 style="color: var(--info); margin: 20px 0;">${farmerReports.length}</h2>
                                <p>Farm reports</p>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-bar"></i> Recent Sales</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="addSaleBtn">
                                            <i class="fas fa-plus"></i> Add Sale
                                        </button>
                                    </div>
                                </div>
                                ${this.renderRecentSales(sales.slice(-5).reverse())}
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-tractor"></i> My Farms</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="addFarmBtn">
                                            <i class="fas fa-plus"></i> Add Farm
                                        </button>
                                    </div>
                                </div>
                                ${this.renderFarmsList(farms)}
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-money-bill-wave"></i> Expenses</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-danger" id="addExpenseBtnMain">
                                            <i class="fas fa-plus"></i> Add Expense
                                        </button>
                                    </div>
                                </div>
                                <div class="expense-container">
                                    ${expenses.length > 0 ? 
                                        expenses.slice(-3).reverse().map(exp => `
                                            <div class="expense-item">
                                                <span>${exp.description}</span>
                                                <span style="color: var(--danger);">KSH ${exp.amount.toLocaleString()}</span>
                                            </div>
                                        `).join('') : 
                                        '<p>No expenses recorded yet</p>'
                                    }
                                </div>
                                <p style="margin-top: 10px; text-align: right;">
                                    <strong>Total: KSH ${totalExpenses.toLocaleString()}</strong>
                                </p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-file-pdf"></i> PDF Documents</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-primary" id="viewMyPdfsBtn">
                                            <i class="fas fa-folder-open"></i> View PDFs
                                        </button>
                                    </div>
                                </div>
                                <p>Access farming guides, reports, and certificates uploaded by your agronomist.</p>
                                <div style="margin-top: 10px;">
                                    <span class="badge badge-info">
                                        <i class="fas fa-file-pdf"></i> ${farmerPdfs.length} PDF Documents
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-pie"></i> Sales & Expenses</h3>
                                </div>
                                <div class="chart-container">
                                    <canvas id="profitChart"></canvas>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('mainContent').innerHTML = html;
                    this.renderSalesExpenseChart(sales, expenses);
                    
                } else if (this.userType === 'agronomist') {
                    const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                    const sales = JSON.parse(localStorage.getItem('sales')) || [];
                    const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                    const reports = JSON.parse(localStorage.getItem('reports')) || [];
                    const pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
                    
                    // Calculate totals
                    const systemSales = sales.reduce((sum, sale) => sum + sale.total, 0);
                    const systemExpenses = tasks.reduce((sum, task) => sum + task.payment, 0);
                    const systemProfit = systemSales - systemExpenses;
                    const agronomistProfit = tasks.filter(t => t.status === 'paid').reduce((sum, task) => sum + task.payment, 0);
                    
                    // Update user info
                    document.getElementById('userAvatar').textContent = 'AA';
                    document.getElementById('userName').textContent = 'Aaron Agronomist';
                    document.getElementById('userRole').textContent = 'Agronomist';
                    
                    html = `
                        <div class="stats-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-users"></i> Total Farmers</h3>
                                </div>
                                <h2 style="color: var(--success); margin: 20px 0;">${farmers.length}</h2>
                                <p>Registered farmers</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-money-bill-wave"></i> System Sales</h3>
                                </div>
                                <h2 style="color: var(--primary); margin: 20px 0;">KSH ${systemSales.toLocaleString()}</h2>
                                <p>Total system sales</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-tasks"></i> Tasks Profit</h3>
                                </div>
                                <h2 style="color: var(--info); margin: 20px 0;">KSH ${agronomistProfit.toLocaleString()}</h2>
                                <p>Your earnings</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-line"></i> System Profit</h3>
                                </div>
                                <h2 style="color: ${systemProfit >= 0 ? 'var(--primary)' : 'var(--danger)'}; margin: 20px 0;">KSH ${systemProfit.toLocaleString()}</h2>
                                <p>Net system profit</p>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-users"></i> Farmers Management</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-info" onclick="system.toggleFarmersView()">
                                            <i class="fas fa-eye"></i> View More
                                        </button>
                                    </div>
                                </div>
                                <div id="farmersTableContainer">
                                    ${this.renderFarmersTable(farmers.slice(0, 3), true)}
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-tasks"></i> Tasks & Payments</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="addTaskBtn">
                                            <i class="fas fa-plus"></i> Add Task
                                        </button>
                                    </div>
                                </div>
                                <p>Record tasks and payments for services rendered.</p>
                                <div class="expense-container" style="margin-top: 15px;">
                                    ${tasks.length > 0 ? 
                                        tasks.slice(-3).reverse().map(task => `
                                            <div class="expense-item">
                                                <span>${task.description.substring(0, 30)}...</span>
                                                <span style="color: var(--success);">KSH ${task.payment.toLocaleString()}</span>
                                            </div>
                                        `).join('') : 
                                        '<p>No tasks recorded yet</p>'
                                    }
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-file-medical-alt"></i> Create Reports</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="createReportBtn">
                                            <i class="fas fa-plus"></i> New Report
                                        </button>
                                        <button class="btn btn-sm btn-primary" id="uploadPdfBtn">
                                            <i class="fas fa-upload"></i> Upload PDF
                                        </button>
                                    </div>
                                </div>
                                <p>Create detailed reports and upload PDF documents for farmers.</p>
                                <div style="margin-top: 15px;">
                                    <span class="badge badge-info">
                                        <i class="fas fa-file-alt"></i> ${reports.length} Reports
                                    </span>
                                    <span class="badge badge-warning" style="margin-left: 10px;">
                                        <i class="fas fa-file-pdf"></i> ${pdfs.length} PDFs
                                    </span>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-receipt"></i> Invoices</h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-success" id="createInvoiceBtn">
                                            <i class="fas fa-plus"></i> Create Invoice
                                        </button>
                                    </div>
                                </div>
                                <p>Create and manage invoices for farmers.</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-sm btn-primary" onclick="system.downloadAllInvoices()">
                                        <i class="fas fa-download"></i> Download All Invoices
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-area"></i> System Performance</h3>
                                </div>
                                <div class="chart-container">
                                    <canvas id="agroChart"></canvas>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('mainContent').innerHTML = html;
                    this.renderAgroChart(sales, tasks);
                }
                
                document.getElementById('navLinks').classList.remove('active');
            }

            async loadSales(e = null) {
                if (e) e.preventDefault();
                
                if (this.userType !== 'farmer') return;
                
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                
                // Get unique months
                const months = [...new Set(sales.map(s => s.date.slice(0, 7)))].sort().reverse();
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-chart-line"></i> Daily Sales Tracking</h3>
                            <div class="card-actions">
                                <button class="btn btn-success" id="addSaleBtn">
                                    <i class="fas fa-plus"></i> Add Daily Sale
                                </button>
                                <button class="btn btn-primary" onclick="system.downloadSalesExcel()">
                                    <i class="fas fa-download"></i> Export Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="month-selector">
                            ${months.map(month => `
                                <button class="month-btn ${month === this.currentMonth ? 'active' : ''}" 
                                        onclick="system.selectMonth('${month}')">
                                    ${new Date(month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                                </button>
                            `).join('')}
                        </div>
                        
                        <div id="monthSalesContent">
                            ${this.renderMonthSales(this.currentMonth)}
                        </div>
                        
                        <div class="card" style="margin-top: 30px;">
                            <div class="card-header">
                                <h3><i class="fas fa-chart-area"></i> Monthly Sales & Expenses</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navSales').classList.add('active');
                
                this.renderMonthlySalesChart(sales);
                document.getElementById('navLinks').classList.remove('active');
            }

            selectMonth(month) {
                this.currentMonth = month;
                document.querySelectorAll('.month-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                document.getElementById('monthSalesContent').innerHTML = this.renderMonthSales(month);
            }

            renderMonthSales(month) {
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                const expenses = JSON.parse(localStorage.getItem('expenses')) || [];
                
                const monthSales = sales.filter(s => s.date.startsWith(month));
                const monthExpenses = expenses.filter(e => e.date.startsWith(month));
                
                if (monthSales.length === 0) {
                    return '<p>No sales records for this month.</p>';
                }
                
                let html = `
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Crop</th>
                                    <th>Quantity (kg)</th>
                                    <th>Price/Kg</th>
                                    <th>Total Sales</th>
                                    <th>Expenses</th>
                                    <th>Profit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                monthSales.forEach(sale => {
                    const dayExpenses = monthExpenses.filter(e => e.date === sale.date)
                        .reduce((sum, exp) => sum + exp.amount, 0);
                    const profit = sale.total - dayExpenses;
                    
                    html += `
                        <tr>
                            <td>${new Date(sale.date).toLocaleDateString()}</td>
                            <td>${sale.crop}</td>
                            <td>${sale.quantity}</td>
                            <td>KSH ${sale.pricePerKg.toFixed(2)}</td>
                            <td>KSH ${sale.total.toFixed(2)}</td>
                            <td>KSH ${dayExpenses.toFixed(2)}</td>
                            <td><span class="badge ${profit >= 0 ? 'badge-success' : 'badge-danger'}">KSH ${profit.toFixed(2)}</span></td>
                            <td>
                                <button class="btn btn-sm btn-danger" onclick="system.deleteSale('${sale.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                // Add month totals
                const monthTotalSales = monthSales.reduce((sum, sale) => sum + sale.total, 0);
                const monthTotalExpenses = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                const monthTotalProfit = monthTotalSales - monthTotalExpenses;
                
                html += `
                            </tbody>
                            <tfoot>
                                <tr style="background-color: #f8f9fa; font-weight: bold;">
                                    <td colspan="4">Month Total</td>
                                    <td>KSH ${monthTotalSales.toFixed(2)}</td>
                                    <td>KSH ${monthTotalExpenses.toFixed(2)}</td>
                                    <td><span class="badge ${monthTotalProfit >= 0 ? 'badge-success' : 'badge-danger'}">KSH ${monthTotalProfit.toFixed(2)}</span></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                `;
                
                return html;
            }

            async loadFarms(e = null) {
                if (e) e.preventDefault();
                
                if (this.userType !== 'farmer') return;
                
                const farms = JSON.parse(localStorage.getItem('farms')) || [];
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-tractor"></i> Farm Management</h3>
                            <div class="card-actions">
                                <button class="btn btn-success" id="addFarmBtn">
                                    <i class="fas fa-plus"></i> Add Farm
                                </button>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                `;
                
                farms.forEach(farm => {
                    const farmReports = reports.filter(r => r.farmId === farm.id);
                    html += `
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-farm"></i> ${farm.name}</h3>
                                <span class="badge badge-success">${farm.size} acres</span>
                            </div>
                            <p><strong>Location:</strong> ${farm.location}</p>
                            <p><strong>Crops:</strong> ${farm.crops}</p>
                            <p><strong>Soil Type:</strong> ${farm.soilType}</p>
                            
                            <div style="margin-top: 15px;">
                                <h4>Farm Reports</h4>
                                ${farmReports.length > 0 ? 
                                    farmReports.map(report => `
                                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px;">
                                            <strong>${report.title}</strong><br>
                                            <small>${new Date(report.date).toLocaleDateString()}</small>
                                            <button class="btn btn-sm btn-info" onclick="system.viewReport('${report.id}')" style="float: right;">
                                                <i class="fas fa-eye"></i> View
                                            </button>
                                        </div>
                                    `).join('') : 
                                    '<p>No reports yet</p>'
                                }
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navFarms').classList.add('active');
                document.getElementById('navLinks').classList.remove('active');
            }

            async loadReports(e = null) {
                if (e) e.preventDefault();
                
                if (this.userType === 'farmer') {
                    const reports = JSON.parse(localStorage.getItem('reports')) || [];
                    const farmerReports = reports.filter(r => r.farmerId === this.currentUser.id);
                    
                    let html = `
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-file-medical-alt"></i> Farm Reports</h3>
                                <div class="card-actions">
                                    <button class="btn btn-primary" onclick="system.downloadAllReports()">
                                        <i class="fas fa-download"></i> Download All
                                    </button>
                                </div>
                            </div>
                            
                            <div class="dashboard-grid">
                    `;
                    
                    farmerReports.forEach(report => {
                        html += `
                            <div class="card">
                                <div class="card-header">
                                    <h3>${report.title}</h3>
                                    <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                        ${report.status}
                                    </span>
                                </div>
                                <p><strong>Type:</strong> ${report.type.replace('_', ' ')}</p>
                                <p><strong>Date:</strong> ${new Date(report.date).toLocaleDateString()}</p>
                                <p><strong>Findings:</strong> ${report.findings.substring(0, 100)}...</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-info" onclick="system.viewReport('${report.id}')">
                                        <i class="fas fa-eye"></i> View Full Report
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('mainContent').innerHTML = html;
                } else if (this.userType === 'agronomist') {
                    const reports = JSON.parse(localStorage.getItem('reports')) || [];
                    const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                    
                    let html = `
                        <div class="card">
                            <div class="card-header">
                                <h3><i class="fas fa-file-alt"></i> All Reports</h3>
                                <div class="card-actions">
                                    <button class="btn btn-success" id="createReportBtn">
                                        <i class="fas fa-plus"></i> Create Report
                                    </button>
                                    <button class="btn btn-primary" onclick="system.downloadAllReports()">
                                        <i class="fas fa-download"></i> Export All
                                    </button>
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Farmer</th>
                                            <th>Report Title</th>
                                            <th>Type</th>
                                            <th>Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;
                    
                    reports.forEach(report => {
                        const farmer = farmers.find(f => f.id === report.farmerId);
                        html += `
                            <tr>
                                <td>${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</td>
                                <td>${report.title}</td>
                                <td>${report.type.replace('_', ' ')}</td>
                                <td>${new Date(report.date).toLocaleDateString()}</td>
                                <td>
                                    <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                        ${report.status}
                                    </span>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-info" onclick="system.viewReport('${report.id}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-warning" onclick="system.editReportStatus('${report.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('mainContent').innerHTML = html;
                }
                
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navReports').classList.add('active');
                document.getElementById('navLinks').classList.remove('active');
            }

            async loadInvoices(e = null) {
                if (e) e.preventDefault();
                
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-receipt"></i> Invoices</h3>
                            ${this.userType === 'agronomist' ? `
                                <div class="card-actions">
                                    <button class="btn btn-success" id="createInvoiceBtn">
                                        <i class="fas fa-plus"></i> Create Invoice
                                    </button>
                                    <button class="btn btn-primary" onclick="system.downloadAllInvoices()">
                                        <i class="fas fa-download"></i> Export All
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Farmer</th>
                                        <th>Date</th>
                                        <th>Due Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                const userInvoices = this.userType === 'farmer' 
                    ? invoices.filter(inv => inv.farmerId === this.currentUser.id)
                    : invoices;
                
                userInvoices.forEach(invoice => {
                    const farmer = farmers.find(f => f.id === invoice.farmerId);
                    const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    
                    html += `
                        <tr>
                            <td>${invoice.id}</td>
                            <td>${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</td>
                            <td>${new Date(invoice.date).toLocaleDateString()}</td>
                            <td>${new Date(invoice.dueDate).toLocaleDateString()}</td>
                            <td>KSH ${total.toFixed(2)}</td>
                            <td>
                                <span class="badge ${invoice.paid ? 'badge-success' : 'badge-warning'}">
                                    ${invoice.paid ? 'Paid' : 'Pending'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.previewInvoice('${invoice.id}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${this.userType === 'agronomist' ? `
                                    <button class="btn btn-sm btn-warning" onclick="system.editInvoice('${invoice.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                document.getElementById('navInvoices').classList.add('active');
                document.getElementById('navLinks').classList.remove('active');
            }

            // Helper methods
            calculateSaleTotal() {
                const quantity = parseFloat(document.getElementById('saleQuantity').value) || 0;
                const price = parseFloat(document.getElementById('salePrice').value) || 0;
                const total = quantity * price;
                document.getElementById('saleTotal').value = total.toFixed(2);
                this.calculateProfit();
            }

            addExpenseItem() {
                const container = document.getElementById('expenseItems');
                const newItem = document.createElement('div');
                newItem.className = 'expense-item';
                newItem.style.marginTop = '10px';
                newItem.innerHTML = `
                    <input type="text" class="form-control expense-desc" placeholder="Expense Description" style="flex: 2;">
                    <input type="number" class="form-control expense-amount" placeholder="Amount (KSH)" step="0.01" style="flex: 1; margin-left: 10px;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); system.calculateTotalExpenses();" style="margin-left: 10px;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(newItem);
            }

            calculateTotalExpenses() {
                let total = 0;
                document.querySelectorAll('.expense-amount').forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                document.getElementById('totalExpenses').value = total.toFixed(2);
                this.calculateProfit();
            }

            calculateProfit() {
                const total = parseFloat(document.getElementById('saleTotal').value) || 0;
                const expenses = parseFloat(document.getElementById('totalExpenses').value) || 0;
                const profit = total - expenses;
                document.getElementById('saleProfit').value = profit.toFixed(2);
            }

            calculateTaskPayment() {
                const hours = parseFloat(document.getElementById('taskHours').value) || 0;
                const rate = parseFloat(document.getElementById('taskRate').value) || 0;
                const payment = hours * rate;
                document.getElementById('taskPayment').value = payment.toFixed(2);
            }

            async handleAddSale(e) {
                e.preventDefault();
                
                // Collect expense items
                const expenseItems = [];
                let totalExpenses = 0;
                document.querySelectorAll('.expense-item').forEach(item => {
                    const desc = item.querySelector('.expense-desc').value;
                    const amount = parseFloat(item.querySelector('.expense-amount').value) || 0;
                    if (desc && amount > 0) {
                        expenseItems.push({ description: desc, amount: amount });
                        totalExpenses += amount;
                    }
                });
                
                const sale = {
                    id: 'SALE-' + Date.now(),
                    farmerId: this.currentUser.id,
                    date: document.getElementById('saleDate').value,
                    crop: document.getElementById('saleCrop').value,
                    quantity: parseFloat(document.getElementById('saleQuantity').value),
                    pricePerKg: parseFloat(document.getElementById('salePrice').value),
                    total: parseFloat(document.getElementById('saleTotal').value),
                    expenses: totalExpenses,
                    expenseItems: expenseItems,
                    profit: parseFloat(document.getElementById('saleProfit').value),
                    notes: document.getElementById('saleNotes').value,
                    createdAt: new Date().toISOString()
                };
                
                // Save to localStorage
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                sales.push(sale);
                localStorage.setItem('sales', JSON.stringify(sales));
                
                this.hideModal('addSaleModal');
                this.loadDashboard();
                this.showNotification('Daily sale record added!', 'success');
            }

            async handleAddExpense(e) {
                e.preventDefault();
                
                const expense = {
                    id: 'EXP-' + Date.now(),
                    farmerId: this.currentUser.id,
                    date: document.getElementById('expenseDate').value,
                    category: document.getElementById('expenseCategory').value,
                    description: document.getElementById('expenseDescription').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    createdAt: new Date().toISOString()
                };
                
                const expenses = JSON.parse(localStorage.getItem('expenses')) || [];
                expenses.push(expense);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                
                this.hideModal('addExpenseModal');
                this.loadDashboard();
                this.showNotification('Expense added successfully!', 'success');
            }

            async handleAddTask(e) {
                e.preventDefault();
                
                const task = {
                    id: 'TASK-' + Date.now(),
                    farmerId: document.getElementById('taskFarmer').value,
                    date: document.getElementById('taskDate').value,
                    description: document.getElementById('taskDescription').value,
                    hours: parseFloat(document.getElementById('taskHours').value),
                    rate: parseFloat(document.getElementById('taskRate').value),
                    payment: parseFloat(document.getElementById('taskPayment').value),
                    status: document.getElementById('taskStatus').value,
                    createdBy: this.currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                const tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                tasks.push(task);
                localStorage.setItem('tasks', JSON.stringify(tasks));
                
                this.hideModal('addTaskModal');
                this.loadDashboard();
                this.showNotification('Task added successfully!', 'success');
            }

            async handleAddFarm(e) {
                e.preventDefault();
                
                const farm = {
                    id: 'FARM-' + Date.now(),
                    farmerId: this.currentUser.id,
                    name: document.getElementById('farmName').value,
                    size: parseFloat(document.getElementById('farmSize').value),
                    location: document.getElementById('farmLocation').value,
                    crops: document.getElementById('farmCrops').value,
                    soilType: document.getElementById('farmSoil').value,
                    createdAt: new Date().toISOString()
                };
                
                const farms = JSON.parse(localStorage.getItem('farms')) || [];
                farms.push(farm);
                localStorage.setItem('farms', JSON.stringify(farms));
                
                this.hideModal('addFarmModal');
                this.loadDashboard();
                this.showNotification('Farm added successfully!', 'success');
            }

            loadFarmersForReport() {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const select = document.getElementById('reportFarmer');
                select.innerHTML = '<option value="">Select Farmer</option>';
                
                farmers.forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.id;
                    option.textContent = `${farmer.firstName} ${farmer.lastName}`;
                    select.appendChild(option);
                });
                
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            }

            loadFarmersForInvoice() {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const select = document.getElementById('invoiceFarmer');
                select.innerHTML = '<option value="">Select Farmer</option>';
                
                farmers.forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.id;
                    option.textContent = `${farmer.firstName} ${farmer.lastName}`;
                    select.appendChild(option);
                });
                
                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 30);
                const dueDateStr = dueDate.toISOString().split('T')[0];
                
                document.getElementById('invoiceDate').value = today;
                document.getElementById('invoiceDueDate').value = dueDateStr;
            }

            loadFarmersForTask() {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const select = document.getElementById('taskFarmer');
                select.innerHTML = '<option value="">Select Farmer</option>';
                
                farmers.forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.id;
                    option.textContent = `${farmer.firstName} ${farmer.lastName}`;
                    select.appendChild(option);
                });
                
                document.getElementById('taskDate').value = new Date().toISOString().split('T')[0];
            }

            loadFarmersForPdfUpload() {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const select = document.getElementById('pdfFarmer');
                select.innerHTML = '<option value="">Select Farmer</option>';
                
                farmers.forEach(farmer => {
                    const option = document.createElement('option');
                    option.value = farmer.id;
                    option.textContent = `${farmer.firstName} ${farmer.lastName}`;
                    select.appendChild(option);
                });
            }

            async handleCreateReport(e) {
                e.preventDefault();
                
                const report = {
                    id: 'REPORT-' + Date.now(),
                    farmerId: document.getElementById('reportFarmer').value,
                    title: document.getElementById('reportTitle').value,
                    type: document.getElementById('reportType').value,
                    date: document.getElementById('reportDate').value,
                    findings: document.getElementById('reportFindings').value,
                    recommendations: document.getElementById('reportRecommendations').value,
                    status: document.getElementById('reportStatus').value,
                    createdBy: this.currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                reports.push(report);
                localStorage.setItem('reports', JSON.stringify(reports));
                
                this.hideModal('createReportModal');
                this.loadDashboard();
                this.showNotification('Report created successfully!', 'success');
            }

            async handleUploadPdf(e) {
                e.preventDefault();
                
                const fileInput = document.getElementById('pdfFile');
                if (!fileInput.files.length) {
                    this.showNotification('Please select a PDF file', 'error');
                    return;
                }
                
                const file = fileInput.files[0];
                if (file.type !== 'application/pdf') {
                    this.showNotification('Only PDF files are allowed', 'error');
                    return;
                }
                
                if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    this.showNotification('File size must be less than 10MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const pdfData = event.target.result;
                    
                    const pdf = {
                        id: 'PDF-' + Date.now(),
                        farmerId: document.getElementById('pdfFarmer').value,
                        title: document.getElementById('pdfTitle').value,
                        description: document.getElementById('pdfDescription').value,
                        category: document.getElementById('pdfCategory').value,
                        fileName: file.name,
                        fileSize: (file.size / 1024).toFixed(2) + ' KB',
                        pdfData: pdfData.split(',')[1], // Remove data URL prefix
                        uploadedBy: this.currentUser.id,
                        uploadedAt: new Date().toISOString(),
                        downloaded: false
                    };
                    
                    // Save to localStorage
                    const pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
                    pdfs.push(pdf);
                    localStorage.setItem('pdfs', JSON.stringify(pdfs));
                    
                    this.hideModal('uploadPdfModal');
                    this.showNotification('PDF uploaded successfully!', 'success');
                    
                    // Reset form
                    document.getElementById('uploadPdfForm').reset();
                    document.getElementById('pdfFileName').textContent = '';
                };
                
                reader.readAsDataURL(file);
            }

            addInvoiceItem() {
                const container = document.getElementById('invoiceItems');
                const newItem = document.createElement('div');
                newItem.className = 'invoice-item';
                newItem.style.marginTop = '10px';
                newItem.innerHTML = `
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" class="form-control invoice-desc" placeholder="Description" required>
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-control invoice-qty" placeholder="Qty" required>
                        </div>
                        <div class="form-group">
                            <input type="number" class="form-control invoice-price" placeholder="Unit Price (KSH)" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-danger" onclick="this.parentElement.parentElement.parentElement.remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.insertBefore(newItem, document.getElementById('addInvoiceItem'));
            }

            async handleCreateInvoice(e) {
                e.preventDefault();
                
                const items = [];
                document.querySelectorAll('.invoice-item').forEach(item => {
                    const desc = item.querySelector('.invoice-desc').value;
                    const qty = parseFloat(item.querySelector('.invoice-qty').value);
                    const price = parseFloat(item.querySelector('.invoice-price').value);
                    
                    if (desc && qty && price) {
                        items.push({
                            description: desc,
                            quantity: qty,
                            price: price
                        });
                    }
                });
                
                if (items.length === 0) {
                    this.showNotification('Please add at least one invoice item', 'error');
                    return;
                }
                
                const invoice = {
                    id: 'INV-' + Date.now(),
                    farmerId: document.getElementById('invoiceFarmer').value,
                    date: document.getElementById('invoiceDate').value,
                    dueDate: document.getElementById('invoiceDueDate').value,
                    items: items,
                    notes: document.getElementById('invoiceNotes').value,
                    createdBy: this.currentUser.id,
                    paid: false,
                    notified: false,
                    createdAt: new Date().toISOString()
                };
                
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                invoices.push(invoice);
                localStorage.setItem('invoices', JSON.stringify(invoices));
                
                this.hideModal('createInvoiceModal');
                this.updateInvoiceNotifications();
                this.previewInvoice(invoice.id);
                this.showNotification('Invoice created successfully!', 'success');
            }

            loadMyPdfs() {
                if (this.userType !== 'farmer') return;
                
                const pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
                const farmerPdfs = pdfs.filter(p => p.farmerId === this.currentUser.id);
                
                let html = `
                    <div class="card">
                        <div class="card-header">
                            <h3><i class="fas fa-file-pdf"></i> My PDF Documents</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="system.downloadAllPdfs()">
                                    <i class="fas fa-download"></i> Download All
                                </button>
                            </div>
                        </div>
                        
                        <div class="pdf-list">
                `;
                
                if (farmerPdfs.length === 0) {
                    html += `
                        <div class="pdf-upload-container" style="background: white;">
                            <i class="fas fa-file-pdf pdf-icon" style="font-size: 3rem; margin-bottom: 15px;"></i>
                            <h4>No PDFs Available</h4>
                            <p>Your agronomist hasn't uploaded any PDFs for you yet.</p>
                        </div>
                    `;
                } else {
                    // Group by category
                    const categories = {};
                    farmerPdfs.forEach(pdf => {
                        if (!categories[pdf.category]) {
                            categories[pdf.category] = [];
                        }
                        categories[pdf.category].push(pdf);
                    });
                    
                    Object.keys(categories).forEach(category => {
                        html += `<h4 style="margin-top: 20px; margin-bottom: 10px; text-transform: capitalize;">${category.replace('_', ' ')}</h4>`;
                        
                        categories[category].forEach(pdf => {
                            const uploadedDate = new Date(pdf.uploadedAt).toLocaleDateString();
                            html += `
                                <div class="pdf-item">
                                    <div class="pdf-info">
                                        <i class="fas fa-file-pdf pdf-icon"></i>
                                        <div>
                                            <strong>${pdf.title}</strong><br>
                                            <small>${pdf.description || 'No description'}</small><br>
                                            <small style="color: var(--gray);">${pdf.fileSize}  Uploaded: ${uploadedDate}</small>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-info" onclick="system.previewPdf('${pdf.id}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn btn-sm btn-success" onclick="system.downloadPdf('${pdf.id}')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    });
                }
                
                html += `
                        </div>
                    </div>
                `;
                
                document.getElementById('mainContent').innerHTML = html;
                document.querySelectorAll('.nav-links a').forEach(link => link.classList.remove('active'));
                this.showNotification('Loaded PDF documents', 'info');
            }

            previewPdf(pdfId) {
                const pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
                const pdf = pdfs.find(p => p.id === pdfId);
                
                if (!pdf) return;
                
                const html = `
                    <div class="invoice">
                        <div class="invoice-header">
                            <div>
                                <h2><i class="fas fa-file-pdf pdf-icon"></i> ${pdf.title}</h2>
                                <p><strong>Description:</strong> ${pdf.description || 'No description'}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>Category:</strong> ${pdf.category.replace('_', ' ')}</p>
                                <p><strong>Uploaded:</strong> ${new Date(pdf.uploadedAt).toLocaleDateString()}</p>
                            </div>
                        </div>
                        
                        <div class="pdf-upload-container" style="background: white; margin: 30px 0;">
                            <i class="fas fa-file-pdf pdf-icon" style="font-size: 4rem; color: var(--danger);"></i>
                            <h4>${pdf.fileName}</h4>
                            <p>${pdf.fileSize}</p>
                            <p style="color: var(--gray); margin-top: 10px;">
                                <i class="fas fa-info-circle"></i> This PDF document is available for download
                            </p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-primary" onclick="system.downloadPdf('${pdf.id}')">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                            <button class="btn btn-secondary" onclick="system.printPdf('${pdf.id}')">
                                <i class="fas fa-print"></i> Print Document
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('pdfViewerContent').innerHTML = html;
                this.showModal('viewPdfModal');
            }

            downloadPdf(pdfId) {
                const pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
                const pdf = pdfs.find(p => p.id === pdfId);
                
                if (!pdf) return;
                
                // Mark as downloaded
                pdf.downloaded = true;
                pdf.downloadedAt = new Date().toISOString();
                localStorage.setItem('pdfs', JSON.stringify(pdfs));
                
                // Create download link
                const link = document.createElement('a');
                link.href = 'data:application/pdf;base64,' + pdf.pdfData;
                link.download = pdf.fileName || pdf.title + '.pdf';
                link.click();
                
                this.showNotification('PDF downloaded successfully!', 'success');
            }

            printPdf(pdfId) {
                this.downloadPdf(pdfId);
                this.showNotification('PDF ready for printing', 'info');
            }

            downloadAllPdfs() {
                const pdfs = JSON.parse(localStorage.getItem('pdfs')) || [];
                const farmerPdfs = this.userType === 'farmer' 
                    ? pdfs.filter(p => p.farmerId === this.currentUser.id)
                    : pdfs;
                
                if (farmerPdfs.length === 0) {
                    this.showNotification('No PDFs to download', 'warning');
                    return;
                }
                
                this.showNotification('Preparing PDF bundle for download...', 'info');
                
                // For demo purposes, we'll download the first PDF
                if (farmerPdfs.length > 0) {
                    setTimeout(() => {
                        this.downloadPdf(farmerPdfs[0].id);
                        this.showNotification('Downloading first PDF. Multiple file download requires backend support.', 'info');
                    }, 1000);
                }
            }

            updateInvoiceNotifications() {
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const notificationBadge = document.getElementById('invoiceNotification');
                
                if (this.userType === 'farmer') {
                    const newInvoices = invoices.filter(inv => 
                        inv.farmerId === this.currentUser.id && 
                        !inv.paid && 
                        !inv.notified
                    );
                    
                    if (newInvoices.length > 0) {
                        notificationBadge.textContent = newInvoices.length;
                        notificationBadge.style.display = 'flex';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }
            }

            previewInvoice(invoiceId) {
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const invoice = invoices.find(i => i.id === invoiceId);
                const farmer = farmers.find(f => f.id === invoice.farmerId);
                const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                
                // Mark as notified
                invoice.notified = true;
                localStorage.setItem('invoices', JSON.stringify(invoices));
                this.updateInvoiceNotifications();
                
                let html = `
                    <div class="invoice">
                        <div class="invoice-header">
                            <h2>AARON AGRONOMY SERVICES</h2>
                        </div>
                        
                        <div class="invoice-company">
                            <h3>INVOICE</h3>
                            <p>P.O Box 55-90300, Makueni</p>
                            <p>Email: aaronmuthini0@gmail.com</p>
                        </div>
                        
                        <div class="invoice-details">
                            <div class="invoice-from">
                                <h4>From:</h4>
                                <p>Aaron Agronomy Services</p>
                                <p>P.O Box 55-90300, Makueni</p>
                                <p>aaronmuthini0@gmail.com</p>
                            </div>
                            
                            <div class="invoice-to">
                                <h4>To:</h4>
                                <p><strong>${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Farmer'}</strong></p>
                                <p>${farmer?.email || ''}</p>
                                <p>${farmer?.phone || ''}</p>
                                <p>${farmer?.location || ''}</p>
                            </div>
                            
                            <div class="invoice-info">
                                <p><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                                <p><strong>Invoice No:</strong> ${invoice.id}</p>
                                <p><strong>Due Date:</strong> ${new Date(invoice.dueDate).toLocaleDateString()}</p>
                                <span class="badge ${invoice.paid ? 'badge-success' : 'badge-warning'}">
                                    ${invoice.paid ? 'PAID' : 'PENDING'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="invoice-items">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Unit Price (KSH)</th>
                                        <th>Subtotal (KSH)</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                invoice.items.forEach(item => {
                    const subtotal = item.quantity * item.price;
                    html += `
                        <tr>
                            <td>${item.description}</td>
                            <td>${item.quantity}</td>
                            <td>${item.price.toFixed(2)}</td>
                            <td>${subtotal.toFixed(2)}</td>
                        </tr>
                    `;
                });
                
                html += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="invoice-total">
                            <h3>Total Amount: KSH ${total.toFixed(2)}</h3>
                        </div>
                        
                        ${invoice.notes ? `
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                <h4>Notes:</h4>
                                <p>${invoice.notes}</p>
                            </div>
                        ` : ''}
                        
                        <div class="invoice-footer">
                            <p><strong>Thank you for your business!</strong></p>
                            <p>If you have any questions kindly contact aaronmuthini0@gmail.com</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('invoicePreviewContent').innerHTML = html;
                this.showModal('invoicePreviewModal');
                
                // Setup download and print buttons
                document.getElementById('downloadInvoiceBtn').onclick = () => this.downloadInvoice(invoiceId);
                document.getElementById('printInvoiceBtn').onclick = () => {
                    window.print();
                };
            }

            viewReport(reportId) {
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const report = reports.find(r => r.id === reportId);
                const farmer = farmers.find(f => f.id === report.farmerId);
                
                if (!report) return;
                
                let html = `
                    <div class="invoice">
                        <div class="invoice-header">
                            <div>
                                <h2>${report.title}</h2>
                                <p><strong>Farmer:</strong> ${farmer ? `${farmer.firstName} ${farmer.lastName}` : 'Unknown'}</p>
                            </div>
                            <div style="text-align: right;">
                                <p><strong>Date:</strong> ${new Date(report.date).toLocaleDateString()}</p>
                                <p><strong>Type:</strong> ${report.type.replace('_', ' ')}</p>
                                <span class="badge badge-${report.status === 'approved' ? 'success' : report.status === 'pending' ? 'warning' : 'danger'}">
                                    ${report.status}
                                </span>
                            </div>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h4>Findings</h4>
                            <p style="white-space: pre-wrap;">${report.findings}</p>
                        </div>
                        
                        <div style="margin: 30px 0;">
                            <h4>Recommendations</h4>
                            <p style="white-space: pre-wrap;">${report.recommendations}</p>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button class="btn btn-primary" onclick="system.downloadReport('${report.id}')">
                                <i class="fas fa-download"></i> Download Report
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('reportContent').innerHTML = html;
                this.showModal('viewReportModal');
            }

            // Chart rendering methods
            renderSalesExpenseChart(sales, expenses) {
                const ctx = document.getElementById('profitChart')?.getContext('2d');
                if (!ctx) return;
                
                // Group by month
                const monthlyData = {};
                
                sales.forEach(sale => {
                    const monthYear = sale.date.slice(0, 7);
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { sales: 0, expenses: 0 };
                    }
                    monthlyData[monthYear].sales += sale.total;
                });
                
                expenses.forEach(expense => {
                    const monthYear = expense.date.slice(0, 7);
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { sales: 0, expenses: 0 };
                    }
                    monthlyData[monthYear].expenses += expense.amount;
                });
                
                const labels = Object.keys(monthlyData).sort();
                const salesData = labels.map(label => monthlyData[label].sales);
                const expenseData = labels.map(label => monthlyData[label].expenses);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels.map(label => {
                            const [year, month] = label.split('-');
                            return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        }),
                        datasets: [
                            {
                                label: 'Sales (KSH)',
                                data: salesData,
                                backgroundColor: '#4CAF50',
                                borderColor: '#4CAF50',
                                borderWidth: 1
                            },
                            {
                                label: 'Expenses (KSH)',
                                data: expenseData,
                                backgroundColor: '#F44336',
                                borderColor: '#F44336',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'KSH ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderMonthlySalesChart(sales) {
                const ctx = document.getElementById('salesChart')?.getContext('2d');
                if (!ctx) return;
                
                // Group by month
                const monthlyData = {};
                sales.forEach(sale => {
                    const monthYear = sale.date.slice(0, 7);
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { sales: 0, count: 0 };
                    }
                    monthlyData[monthYear].sales += sale.total;
                    monthlyData[monthYear].count += 1;
                });
                
                const labels = Object.keys(monthlyData).sort();
                const salesData = labels.map(label => monthlyData[label].sales);
                const countData = labels.map(label => monthlyData[label].count);
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.map(label => {
                            const [year, month] = label.split('-');
                            return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        }),
                        datasets: [
                            {
                                label: 'Monthly Sales (KSH)',
                                data: salesData,
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Number of Sales',
                                data: countData,
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value, index, values) {
                                        if (index === 0 || index === values.length - 1 || value % Math.round(values[values.length-1]/5) === 0) {
                                            return value.toLocaleString();
                                        }
                                        return '';
                                    }
                                }
                            }
                        }
                    }
                });
            }

            renderAgroChart(sales, tasks) {
                const ctx = document.getElementById('agroChart')?.getContext('2d');
                if (!ctx) return;
                
                // Group by month
                const monthlyData = {};
                
                sales.forEach(sale => {
                    const monthYear = sale.date.slice(0, 7);
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { sales: 0, tasks: 0, profit: 0 };
                    }
                    monthlyData[monthYear].sales += sale.total;
                });
                
                tasks.forEach(task => {
                    const monthYear = task.date.slice(0, 7);
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { sales: 0, tasks: 0, profit: 0 };
                    }
                    monthlyData[monthYear].tasks += task.payment;
                    monthlyData[monthYear].profit = monthlyData[monthYear].sales - monthlyData[monthYear].tasks;
                });
                
                const labels = Object.keys(monthlyData).sort();
                const salesData = labels.map(label => monthlyData[label].sales);
                const taskData = labels.map(label => monthlyData[label].tasks);
                const profitData = labels.map(label => monthlyData[label].profit);
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.map(label => {
                            const [year, month] = label.split('-');
                            return new Date(year, month - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                        }),
                        datasets: [
                            {
                                label: 'System Sales (KSH)',
                                data: salesData,
                                borderColor: '#4CAF50',
                                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Task Payments (KSH)',
                                data: taskData,
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'System Profit (KSH)',
                                data: profitData,
                                borderColor: '#FF9800',
                                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'KSH ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // UI Helper methods
            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'flex';
                    document.getElementById('navLinks').classList.remove('active');
                }
            }

            hideModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div style="position: fixed; top: 20px; right: 20px; z-index: 9999; 
                         background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#F44336' : '#2196F3'}; 
                         color: white; padding: 15px 20px; border-radius: 5px; 
                         box-shadow: 0 5px 15px rgba(0,0,0,0.2); min-width: 250px; max-width: 300px;">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                        ${message}
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            saveToLocalStorage() {
                localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
                localStorage.setItem('userType', this.userType);
            }

            // Render helper methods
            renderRecentSales(sales) {
                if (sales.length === 0) {
                    return '<p>No sales records yet. Add your first sale!</p>';
                }
                
                let html = '';
                sales.forEach(sale => {
                    const profit = sale.total - (sale.expenses || 0);
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${sale.crop}</strong>
                                <span>KSH ${sale.total.toFixed(2)}</span>
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${new Date(sale.date).toLocaleDateString()} | 
                                Profit: <span class="${profit >= 0 ? 'text-success' : 'text-danger'}">KSH ${profit.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
                
                return html;
            }

            renderFarmsList(farms) {
                if (farms.length === 0) {
                    return '<p>No farms added yet. Add your first farm!</p>';
                }
                
                let html = '';
                farms.forEach(farm => {
                    html += `
                        <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between;">
                                <strong>${farm.name}</strong>
                                <span class="badge badge-info">${farm.size} acres</span>
                            </div>
                            <div style="font-size: 0.9em; color: #666;">
                                ${farm.location} | ${farm.crops}
                            </div>
                        </div>
                    `;
                });
                
                return html;
            }

            renderFarmersTable(farmers, showOnlyNames = false) {
                if (farmers.length === 0) {
                    return '<p>No farmers registered yet.</p>';
                }
                
                if (showOnlyNames) {
                    let html = '<div style="max-height: 200px; overflow-y: auto;">';
                    farmers.forEach(farmer => {
                        html += `
                            <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                                <strong>${farmer.firstName} ${farmer.lastName}</strong>
                                <span style="color: #666; font-size: 0.9em; margin-left: 10px;">${farmer.location}</span>
                            </div>
                        `;
                    });
                    html += '</div>';
                    return html;
                }
                
                let html = '<div class="table-responsive"><table class="table"><thead><tr>';
                html += '<th>Name</th><th>Email</th><th>Phone</th><th>Location</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                farmers.forEach(farmer => {
                    html += `
                        <tr>
                            <td><strong>${farmer.firstName} ${farmer.lastName}</strong></td>
                            <td>${farmer.email}</td>
                            <td>${farmer.phone || 'N/A'}</td>
                            <td>${farmer.location}</td>
                            <td>
                                <span class="badge badge-${farmer.status === 'active' ? 'success' : farmer.status === 'pending' ? 'warning' : 'danger'}">
                                    ${farmer.status || 'active'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="system.viewFarmerDetails('${farmer.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                return html;
            }

            toggleFarmersView() {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const container = document.getElementById('farmersTableContainer');
                const button = event.target;
                
                if (!container || !button) return;
                
                const isShowingAll = button.innerHTML.includes('View Less');
                
                if (isShowingAll) {
                    container.innerHTML = this.renderFarmersTable(farmers.slice(0, 3), true);
                    button.innerHTML = '<i class="fas fa-eye"></i> View More';
                    button.classList.remove('btn-warning');
                    button.classList.add('btn-info');
                } else {
                    container.innerHTML = this.renderFarmersTable(farmers, false);
                    button.innerHTML = '<i class="fas fa-eye-slash"></i> View Less';
                    button.classList.remove('btn-info');
                    button.classList.add('btn-warning');
                }
            }

            // Additional methods
            deleteSale(saleId) {
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                const filteredSales = sales.filter(s => s.id !== saleId);
                localStorage.setItem('sales', JSON.stringify(filteredSales));
                this.loadSales();
                this.showNotification('Sale record deleted!', 'success');
            }

            viewFarmerDetails(farmerId) {
                const farmers = JSON.parse(localStorage.getItem('farmers')) || [];
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                const farms = JSON.parse(localStorage.getItem('farms')) || [];
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                
                const farmer = farmers.find(f => f.id === farmerId);
                if (!farmer) return;
                
                const farmerSales = sales.filter(s => s.farmerId === farmerId);
                const farmerFarms = farms.filter(f => f.farmerId === farmerId);
                const farmerReports = reports.filter(r => r.farmerId === farmerId);
                
                const totalSales = farmerSales.reduce((sum, sale) => sum + sale.total, 0);
                const totalProfit = farmerSales.reduce((sum, sale) => sum + (sale.total - (sale.expenses || 0)), 0);
                
                let html = `
                    <div class="invoice">
                        <div class="invoice-header">
                            <div>
                                <h2>${farmer.firstName} ${farmer.lastName}</h2>
                                <p><strong>Farmer ID:</strong> ${farmer.id}</p>
                            </div>
                            <div style="text-align: right;">
                                <span class="badge badge-${farmer.status === 'active' ? 'success' : farmer.status === 'pending' ? 'warning' : 'danger'}">
                                    ${farmer.status || 'active'}
                                </span>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h4>Contact Information</h4>
                            <p><strong>Email:</strong> ${farmer.email}</p>
                            <p><strong>Phone:</strong> ${farmer.phone || 'N/A'}</p>
                            <p><strong>Location:</strong> ${farmer.location}</p>
                            <p><strong>Registered:</strong> ${new Date(farmer.createdAt).toLocaleDateString()}</p>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: var(--success); margin-bottom: 5px;">KSH ${totalSales.toLocaleString()}</h5>
                                <small>Total Sales</small>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: var(--primary); margin-bottom: 5px;">KSH ${totalProfit.toLocaleString()}</h5>
                                <small>Total Profit</small>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center;">
                                <h5 style="color: var(--info); margin-bottom: 5px;">${farmerFarms.length}</h5>
                                <small>Active Farms</small>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            <h4>Farms</h4>
                            ${farmerFarms.length > 0 ? 
                                farmerFarms.map(farm => `
                                    <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                                        <strong>${farm.name}</strong> - ${farm.size} acres<br>
                                        <small>${farm.location} | ${farm.crops} | ${farm.soilType} soil</small>
                                    </div>
                                `).join('') : 
                                '<p>No farms registered yet.</p>'
                            }
                        </div>
                    </div>
                `;
                
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3>Farmer Details</h3>
                            <button class="close-modal" onclick="this.parentElement.parentElement.parentElement.remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${html}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            editReportStatus(reportId) {
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                const report = reports.find(r => r.id === reportId);
                
                if (!report) return;
                
                const newStatus = prompt('Update report status (pending/approved/requires_action):', report.status || 'pending');
                
                if (newStatus && ['pending', 'approved', 'requires_action'].includes(newStatus.toLowerCase())) {
                    report.status = newStatus.toLowerCase();
                    localStorage.setItem('reports', JSON.stringify(reports));
                    this.loadReports();
                    this.showNotification('Report status updated!', 'success');
                }
            }

            editInvoice(invoiceId) {
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const invoice = invoices.find(i => i.id === invoiceId);
                
                if (!invoice) return;
                
                const paid = confirm('Mark this invoice as paid?');
                
                if (paid !== null) {
                    invoice.paid = paid;
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    this.updateInvoiceNotifications();
                    this.loadInvoices();
                    this.showNotification('Invoice updated!', 'success');
                }
            }

            // Download methods
            downloadSalesExcel() {
                const sales = JSON.parse(localStorage.getItem('sales')) || [];
                let csv = 'Date,Crop,Quantity (kg),Price/Kg,Total Sales,Expenses,Profit,Notes\n';
                
                sales.forEach(sale => {
                    const profit = sale.total - (sale.expenses || 0);
                    csv += `${sale.date},${sale.crop},${sale.quantity},${sale.pricePerKg},${sale.total},${sale.expenses || 0},${profit},"${sale.notes}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sales_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                this.showNotification('Sales data exported successfully!', 'success');
            }

            downloadAllReports() {
                const reports = this.userType === 'farmer' 
                    ? JSON.parse(localStorage.getItem('reports')).filter(r => r.farmerId === this.currentUser.id)
                    : JSON.parse(localStorage.getItem('reports')) || [];
                
                let csv = 'Report ID,Title,Type,Date,Status,Findings,Recommendations\n';
                
                reports.forEach(report => {
                    csv += `${report.id},"${report.title}",${report.type},${report.date},${report.status},"${report.findings.replace(/"/g, '""')}","${report.recommendations.replace(/"/g, '""')}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reports_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                this.showNotification('Reports exported successfully!', 'success');
            }

            downloadAllInvoices() {
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                let csv = 'Invoice ID,Farmer ID,Date,Due Date,Amount,Status,Items\n';
                
                invoices.forEach(invoice => {
                    const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                    const itemsStr = invoice.items.map(item => `${item.description} (${item.quantity} x KSH ${item.price})`).join('; ');
                    csv += `${invoice.id},${invoice.farmerId},${invoice.date},${invoice.dueDate},${total},${invoice.paid ? 'Paid' : 'Pending'},"${itemsStr}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoices_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                
                this.showNotification('Invoices exported successfully!', 'success');
            }

            downloadReport(reportId) {
                const reports = JSON.parse(localStorage.getItem('reports')) || [];
                const report = reports.find(r => r.id === reportId);
                
                if (!report) return;
                
                const content = `
                    Report: ${report.title}
                    Type: ${report.type}
                    Date: ${report.date}
                    Status: ${report.status}
                    
                    FINDINGS:
                    ${report.findings}
                    
                    RECOMMENDATIONS:
                    ${report.recommendations}
                `;
                
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${reportId}.txt`;
                a.click();
                
                this.showNotification('Report downloaded!', 'success');
            }

            downloadInvoice(invoiceId) {
                const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
                const invoice = invoices.find(i => i.id === invoiceId);
                
                if (!invoice) return;
                
                let content = `
                    INVOICE #${invoice.id}
                    Date: ${invoice.date}
                    Due Date: ${invoice.dueDate}
                    Status: ${invoice.paid ? 'PAID' : 'PENDING'}
                    
                    ITEMS:
                `;
                
                invoice.items.forEach(item => {
                    content += `${item.description} - ${item.quantity} x KSH ${item.price} = KSH ${(item.quantity * item.price).toFixed(2)}\n`;
                });
                
                const total = invoice.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                content += `\nTOTAL: KSH ${total.toFixed(2)}`;
                
                if (invoice.notes) {
                    content += `\n\nNOTES:\n${invoice.notes}`;
                }
                
                const blob = new Blob([content], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `invoice_${invoiceId}.txt`;
                a.click();
                
                this.showNotification('Invoice downloaded!', 'success');
            }
        }

        // Initialize the system
        const system = new AgronomySystem();
        window.system = system;

        // Set default dates
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            
            // Set dates for various forms
            ['saleDate', 'expenseDate', 'taskDate', 'reportDate'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.value = today;
                    if (id === 'saleDate') {
                        input.max = today;
                    }
                }
            });
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Handle window resize for responsive design
        window.addEventListener('resize', () => {
            const navLinks = document.getElementById('navLinks');
            if (window.innerWidth > 768 && navLinks.classList.contains('active')) {
                navLinks.classList.remove('active');
            }
        });
    </script>
</body>
</html>

